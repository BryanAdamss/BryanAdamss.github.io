<!doctype html>



  


<html class="theme-next mist use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.0" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="vue,vue-router,æºç è§£æ," />








  <link rel="shortcut icon" type="image/x-icon" href="/Avatar.png?v=5.1.0" />






<meta name="description" content="vue-router æºç è§£æ | 1.5w å­— | å¤šå›¾é¢„è­¦ - ã€ä¸­ã€‘ å„ä½å¥½ï¼Œæˆ‘æ˜¯å…‰è¾‰ ğŸ˜ æœ¬ç¯‡æ˜¯vue-routeræºç è§£æçš„ä¸­ç¯‡ï¼Œä¹Ÿæ˜¯æ ¸å¿ƒç¯‡ æœ¬ç¯‡ä¸»è¦ä»‹ç»äº†ä¸‹é¢å‡ ç‚¹ ä»‹ç»äº†vue-routeræ˜¯å¦‚ä½•åšè·¯ç”±åŒ¹é…çš„ ä»¥åŠå…¶ç›¸å…³çš„å®ˆå«ã€é’©å­æ˜¯å¦‚ä½•è§¦å‘çš„ å¼‚æ­¥ç»„ä»¶åˆæ˜¯å¦‚ä½•å¤„ç†çš„ç­‰ç­‰   è™½ç„¶çœ‹ç€çŸ¥è¯†ç‚¹å¾ˆå°‘ï¼Œä½†å†…å®¹å´ä¸€ç‚¹éƒ½ä¸å°‘ å¦å¤–è¿˜æ˜¯è¦è¯´ä¸€ä¸‹ ç¬¬ä¸€æ¬¡åšæºç è§£æï¼Œè‚¯å®šæœ‰å¾ˆå¤šé”™è¯¯æˆ–ç†è§£ä¸åˆ°ä½çš„åœ°æ–¹">
<meta name="keywords" content="vue,vue-router,æºç è§£æ">
<meta property="og:type" content="article">
<meta property="og:title" content="vue-router-analysis-part2">
<meta property="og:url" content="http://yoursite.com/2020/12/01/vue-router-analysis-part2/index.html">
<meta property="og:site_name" content="BryanAdamssçš„åšå®¢">
<meta property="og:description" content="vue-router æºç è§£æ | 1.5w å­— | å¤šå›¾é¢„è­¦ - ã€ä¸­ã€‘ å„ä½å¥½ï¼Œæˆ‘æ˜¯å…‰è¾‰ ğŸ˜ æœ¬ç¯‡æ˜¯vue-routeræºç è§£æçš„ä¸­ç¯‡ï¼Œä¹Ÿæ˜¯æ ¸å¿ƒç¯‡ æœ¬ç¯‡ä¸»è¦ä»‹ç»äº†ä¸‹é¢å‡ ç‚¹ ä»‹ç»äº†vue-routeræ˜¯å¦‚ä½•åšè·¯ç”±åŒ¹é…çš„ ä»¥åŠå…¶ç›¸å…³çš„å®ˆå«ã€é’©å­æ˜¯å¦‚ä½•è§¦å‘çš„ å¼‚æ­¥ç»„ä»¶åˆæ˜¯å¦‚ä½•å¤„ç†çš„ç­‰ç­‰   è™½ç„¶çœ‹ç€çŸ¥è¯†ç‚¹å¾ˆå°‘ï¼Œä½†å†…å®¹å´ä¸€ç‚¹éƒ½ä¸å°‘ å¦å¤–è¿˜æ˜¯è¦è¯´ä¸€ä¸‹ ç¬¬ä¸€æ¬¡åšæºç è§£æï¼Œè‚¯å®šæœ‰å¾ˆå¤šé”™è¯¯æˆ–ç†è§£ä¸åˆ°ä½çš„åœ°æ–¹">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="http://yoursite.com/2020/12/01/vue-router-analysis-part2/match.png">
<meta property="og:image" content="http://yoursite.com/2020/12/01/vue-router-analysis-part2/normalize-location.png">
<meta property="og:image" content="http://yoursite.com/2020/12/01/vue-router-analysis-part2/dynamic-route.png">
<meta property="og:image" content="http://yoursite.com/2020/12/01/vue-router-analysis-part2/match-route.png">
<meta property="og:image" content="http://yoursite.com/2020/12/01/vue-router-analysis-part2/fill-params.png">
<meta property="og:image" content="http://yoursite.com/2020/12/01/vue-router-analysis-part2/create-route-inner.png">
<meta property="og:image" content="http://yoursite.com/2020/12/01/vue-router-analysis-part2/create-route.png">
<meta property="og:image" content="http://yoursite.com/2020/12/01/vue-router-analysis-part2/match-demo-record.png">
<meta property="og:image" content="http://yoursite.com/2020/12/01/vue-router-analysis-part2/alias.png">
<meta property="og:image" content="http://yoursite.com/2020/12/01/vue-router-analysis-part2/redirect-demo.png">
<meta property="og:image" content="http://yoursite.com/2020/12/01/vue-router-analysis-part2/redirect-stack-1.png">
<meta property="og:image" content="http://yoursite.com/2020/12/01/vue-router-analysis-part2/redirect-stack-2.png">
<meta property="og:image" content="http://yoursite.com/2020/12/01/vue-router-analysis-part2/redirect-stack-3.png">
<meta property="og:image" content="http://yoursite.com/2020/12/01/vue-router-analysis-part2/redirect-stack-4.png">
<meta property="og:image" content="http://yoursite.com/2020/12/01/vue-router-analysis-part2/redirect-full.png">
<meta property="og:image" content="http://yoursite.com/2020/12/01/vue-router-analysis-part2/flat-map-components.png">
<meta property="og:image" content="http://yoursite.com/2020/12/01/vue-router-analysis-part2/extract-guards.png">
<meta property="og:image" content="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/917b376a388f43faa6c8f8d81f730bcb~tplv-k3u1fbpfcp-watermark.image">
<meta property="og:updated_time" content="2020-12-06T04:24:39.439Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="vue-router-analysis-part2">
<meta name="twitter:description" content="vue-router æºç è§£æ | 1.5w å­— | å¤šå›¾é¢„è­¦ - ã€ä¸­ã€‘ å„ä½å¥½ï¼Œæˆ‘æ˜¯å…‰è¾‰ ğŸ˜ æœ¬ç¯‡æ˜¯vue-routeræºç è§£æçš„ä¸­ç¯‡ï¼Œä¹Ÿæ˜¯æ ¸å¿ƒç¯‡ æœ¬ç¯‡ä¸»è¦ä»‹ç»äº†ä¸‹é¢å‡ ç‚¹ ä»‹ç»äº†vue-routeræ˜¯å¦‚ä½•åšè·¯ç”±åŒ¹é…çš„ ä»¥åŠå…¶ç›¸å…³çš„å®ˆå«ã€é’©å­æ˜¯å¦‚ä½•è§¦å‘çš„ å¼‚æ­¥ç»„ä»¶åˆæ˜¯å¦‚ä½•å¤„ç†çš„ç­‰ç­‰   è™½ç„¶çœ‹ç€çŸ¥è¯†ç‚¹å¾ˆå°‘ï¼Œä½†å†…å®¹å´ä¸€ç‚¹éƒ½ä¸å°‘ å¦å¤–è¿˜æ˜¯è¦è¯´ä¸€ä¸‹ ç¬¬ä¸€æ¬¡åšæºç è§£æï¼Œè‚¯å®šæœ‰å¾ˆå¤šé”™è¯¯æˆ–ç†è§£ä¸åˆ°ä½çš„åœ°æ–¹">
<meta name="twitter:image" content="http://yoursite.com/2020/12/01/vue-router-analysis-part2/match.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":0,"b2t":false,"scrollpercent":false},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: 'åšä¸»'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/2020/12/01/vue-router-analysis-part2/"/>





  <title> vue-router-analysis-part2 | BryanAdamssçš„åšå®¢ </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  














  
  
    
  

  <div class="container one-collumn sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">BryanAdamssçš„åšå®¢</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">ä¸€ä¸ªä¼ªå‰ç«¯</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            é¦–é¡µ
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            åˆ†ç±»
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            å½’æ¡£
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            æ ‡ç­¾
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            æœç´¢
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocapitalize="off" autocomplete="off" autocorrect="off" placeholder="æœç´¢..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/12/01/vue-router-analysis-part2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="BryanAdamss">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/Avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="BryanAdamssçš„åšå®¢">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                vue-router-analysis-part2
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">å‘è¡¨äº</span>
              
              <time title="åˆ›å»ºäº" itemprop="dateCreated datePublished" datetime="2020-12-01T06:51:15+08:00">
                2020-12-01 06:51:15
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">åˆ†ç±»äº</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/FrontEnd/" itemprop="url" rel="index">
                    <span itemprop="name">å‰ç«¯</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        <h1 id="vue-router-æºç è§£æ-1-5w-å­—-å¤šå›¾é¢„è­¦-ã€ä¸­ã€‘"><a href="#vue-router-æºç è§£æ-1-5w-å­—-å¤šå›¾é¢„è­¦-ã€ä¸­ã€‘" class="headerlink" title="vue-router æºç è§£æ | 1.5w å­— | å¤šå›¾é¢„è­¦ - ã€ä¸­ã€‘"></a>vue-router æºç è§£æ | 1.5w å­— | å¤šå›¾é¢„è­¦ - ã€ä¸­ã€‘</h1><ul>
<li>å„ä½å¥½ï¼Œæˆ‘æ˜¯å…‰è¾‰ ğŸ˜</li>
<li>æœ¬ç¯‡æ˜¯<code>vue-router</code>æºç è§£æçš„ä¸­ç¯‡ï¼Œä¹Ÿæ˜¯æ ¸å¿ƒç¯‡</li>
<li>æœ¬ç¯‡ä¸»è¦ä»‹ç»äº†ä¸‹é¢å‡ ç‚¹<ul>
<li>ä»‹ç»äº†<code>vue-router</code>æ˜¯å¦‚ä½•åšè·¯ç”±åŒ¹é…çš„</li>
<li>ä»¥åŠå…¶ç›¸å…³çš„å®ˆå«ã€é’©å­æ˜¯å¦‚ä½•è§¦å‘çš„</li>
<li>å¼‚æ­¥ç»„ä»¶åˆæ˜¯å¦‚ä½•å¤„ç†çš„ç­‰ç­‰</li>
</ul>
</li>
<li>è™½ç„¶çœ‹ç€çŸ¥è¯†ç‚¹å¾ˆå°‘ï¼Œä½†å†…å®¹å´ä¸€ç‚¹éƒ½ä¸å°‘</li>
<li>å¦å¤–è¿˜æ˜¯è¦è¯´ä¸€ä¸‹<ul>
<li>ç¬¬ä¸€æ¬¡åšæºç è§£æï¼Œè‚¯å®šæœ‰å¾ˆå¤šé”™è¯¯æˆ–ç†è§£ä¸åˆ°ä½çš„åœ°æ–¹ï¼Œæ¬¢è¿æŒ‡æ­£ ğŸ¤</li>
</ul>
</li>
<li>é¡¹ç›®åœ°å€<ul>
<li><code>https://github.com/BryanAdamss/vue-router-for-analysis</code></li>
<li>å¦‚æœè§‰å¾—å¯¹ä½ æœ‰å¸®åŠ©ï¼Œè®°å¾—ç»™æˆ‘ä¸€ä¸ª<code>star</code>âœ¨</li>
</ul>
</li>
<li>uml å›¾æºæ–‡ä»¶<ul>
<li><code>https://github.com/BryanAdamss/vue-router-for-analysis/blob/dev/vue-router.EAP</code></li>
</ul>
</li>
<li>å…³è”æ–‡ç« é“¾æ¥<ul>
<li><a href="https://juejin.cn/post/6880529850159874062" target="_blank" rel="noopener">vue-routeræºç è§£æ | 1.3wå­— | å¤šå›¾é¢„è­¦ - ã€ä¸Šã€‘</a></li>
<li><a href="https://juejin.cn/post/6901047675227996167" target="_blank" rel="noopener">vue-router æºç è§£æ | 1.5w å­— | å¤šå›¾é¢„è­¦ - ã€ä¸­ã€‘</a></li>
<li><a href="https://juejin.cn/post/6902992939115855880" target="_blank" rel="noopener">vue-router æºç è§£æ | 6k å­— - ã€ä¸‹ã€‘</a></li>
</ul>
</li>
</ul>
<h2 id="è·¯ç”±è·³è½¬"><a href="#è·¯ç”±è·³è½¬" class="headerlink" title="è·¯ç”±è·³è½¬"></a>è·¯ç”±è·³è½¬</h2><ul>
<li>å‰é¢ä»‹ç»è¿‡ï¼Œè¦å®ç°è·¯ç”±çš„è·³è½¬ï¼Œé¦–å…ˆå¾—ä»è·¯ç”±æ˜ å°„è¡¨ä¸­æ‰¾åˆ°ä¸åœ°å€åŒ¹é…çš„è·¯ç”±å¯¹è±¡ï¼Œè¿™ä¸ªè¿‡ç¨‹ç§°ä¹‹ä¸ºè·¯ç”±åŒ¹é…ï¼Œæ‰¾åˆ°åŒ¹é…çš„è·¯ç”±åï¼Œç„¶åå†è§£æè·³è½¬</li>
<li>æ‰€ä»¥å®ç°è·¯ç”±è·³è½¬æœ‰ä¸¤ä¸ªå…³é”®æ­¥éª¤ï¼šè·¯ç”±åŒ¹é…ã€å¯¼èˆªè§£æ</li>
<li><code>VueRouter</code>å°†ä¸Šè¿°ä¸¤ä¸ªå…³é”®æ­¥éª¤å°è£…åˆ°<code>transitionTo</code>æ–¹æ³•ä¸­äº†</li>
<li>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å…ˆçœ‹çœ‹<code>transitionTo</code>çš„å®ç°</li>
</ul>
<h3 id="transitionTo"><a href="#transitionTo" class="headerlink" title="transitionTo"></a>transitionTo</h3><ul>
<li>å‰é¢ä»‹ç»è¿‡ï¼Œ<code>transitionTo</code>æ–¹æ³•å®šä¹‰åœ¨åŸºç±»<code>History</code>ä¸Šçš„</li>
</ul>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/history/base.js</span></span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"><span class="comment">//Â çˆ¶ç±»</span></span><br><span class="line"><span class="keyword">export</span>Â <span class="keyword">class</span>Â HistoryÂ &#123;</span><br><span class="line">Â Â ...</span><br><span class="line"></span><br><span class="line">Â Â <span class="comment">//Â è·¯ç”±è·³è½¬</span></span><br><span class="line">Â Â transitionToÂ (</span><br><span class="line">Â Â Â Â location:Â RawLocation,Â <span class="comment">//Â åŸå§‹locationï¼Œä¸€ä¸ªurlæˆ–è€…æ˜¯ä¸€ä¸ªLocationÂ interface(è‡ªå®šä¹‰å½¢çŠ¶ï¼Œåœ¨types/router.d.tsä¸­å®šä¹‰)</span></span><br><span class="line">Â Â Â Â onComplete?:Â <span class="built_in">Function</span>,Â <span class="comment">//Â è·³è½¬æˆåŠŸå›è°ƒ</span></span><br><span class="line">Â Â Â Â onAbort?:Â <span class="built_in">Function</span><span class="comment">//Â è·³è½¬å¤±è´¥å›è°ƒ</span></span><br><span class="line">Â Â )Â &#123;</span><br><span class="line">Â Â Â Â <span class="keyword">const</span>Â routeÂ =Â <span class="keyword">this</span>.router.match(location,Â <span class="keyword">this</span>.current)Â <span class="comment">//Â ä¼ å…¥éœ€è¦è·³è½¬çš„locationå’Œå½“å‰è·¯ç”±å¯¹è±¡ï¼Œè¿”å›toçš„Route</span></span><br><span class="line"></span><br><span class="line">Â Â Â Â <span class="comment">//Â ç¡®è®¤è·³è½¬</span></span><br><span class="line">Â Â Â Â <span class="keyword">this</span>.confirmTransition(</span><br><span class="line">Â Â Â Â Â Â route,</span><br><span class="line">Â Â Â Â Â Â ()Â =&gt;Â &#123;Â <span class="comment">//Â onCompleteï¼Œå®Œæˆ</span></span><br><span class="line">Â Â Â Â Â Â Â Â <span class="keyword">this</span>.updateRoute(route)Â <span class="comment">//Â æ›´æ–°routeï¼Œä¼šè§¦å‘afterEaché’©å­</span></span><br><span class="line">Â Â Â Â Â Â Â Â onCompleteÂ &amp;&amp;Â onComplete(route)Â <span class="comment">//Â è°ƒç”¨onCompleteå›è°ƒ</span></span><br><span class="line">Â Â Â Â Â Â Â Â <span class="keyword">this</span>.ensureURL()</span><br><span class="line">Â Â Â Â Â Â Â Â <span class="comment">//Â fireÂ readyÂ cbsÂ once</span></span><br><span class="line">Â Â Â Â Â Â Â Â <span class="comment">//Â è§¦å‘readyå›è°ƒ</span></span><br><span class="line">Â Â Â Â Â Â Â Â <span class="keyword">if</span>Â (!<span class="keyword">this</span>.ready)Â &#123;</span><br><span class="line">Â Â Â Â Â Â Â Â Â Â <span class="keyword">this</span>.readyÂ =Â <span class="literal">true</span></span><br><span class="line">Â Â Â Â Â Â Â Â Â Â <span class="keyword">this</span>.readyCbs.forEach(<span class="function"><span class="params">cb</span>Â =&gt;</span>Â &#123;</span><br><span class="line">Â Â Â Â Â Â Â Â Â Â Â Â cb(route)</span><br><span class="line">Â Â Â Â Â Â Â Â Â Â &#125;)</span><br><span class="line">Â Â Â Â Â Â Â Â &#125;</span><br><span class="line">Â Â Â Â Â Â &#125;,</span><br><span class="line">Â Â Â Â Â Â errÂ =&gt;Â &#123;Â <span class="comment">//Â onAbortï¼ŒæŠ¥é”™ï¼ˆå–æ¶ˆï¼‰</span></span><br><span class="line">Â Â Â Â Â Â Â Â <span class="keyword">if</span>Â (onAbort)Â &#123;</span><br><span class="line">Â Â Â Â Â Â Â Â Â Â onAbort(err)</span><br><span class="line">Â Â Â Â Â Â Â Â &#125;</span><br><span class="line">Â Â Â Â Â Â Â Â <span class="comment">//Â è§¦å‘errorå›è°ƒ</span></span><br><span class="line">Â Â Â Â Â Â Â Â <span class="keyword">if</span>Â (errÂ &amp;&amp;Â !<span class="keyword">this</span>.ready)Â &#123;</span><br><span class="line">Â Â Â Â Â Â Â Â Â Â <span class="keyword">this</span>.readyÂ =Â <span class="literal">true</span></span><br><span class="line">Â Â Â Â Â Â Â Â Â Â <span class="keyword">this</span>.readyErrorCbs.forEach(<span class="function"><span class="params">cb</span>Â =&gt;</span>Â &#123;</span><br><span class="line">Â Â Â Â Â Â Â Â Â Â Â Â cb(err)</span><br><span class="line">Â Â Â Â Â Â Â Â Â Â &#125;)</span><br><span class="line">Â Â Â Â Â Â Â Â &#125;</span><br><span class="line">Â Â Â Â Â Â &#125;</span><br><span class="line">Â Â Â Â )</span><br><span class="line">Â Â &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>åœ¨<code>setupListeners</code>ç« èŠ‚ä¹Ÿä»‹ç»è¿‡<code>transitionTo</code>çš„æ–¹æ³•ç­¾å</li>
<li>æ¥æ”¶ä¸‰ä¸ªå‚æ•°<ul>
<li><code>location</code>ä¸º<code>RawLocation</code>ç±»å‹ï¼Œä»£è¡¨éœ€è¦è§£æçš„åœ°å€</li>
<li><code>onComplete</code>æ˜¯è·³è½¬æˆåŠŸå›è°ƒï¼Œåœ¨è·¯ç”±è·³è½¬æˆåŠŸæ—¶è°ƒç”¨</li>
<li><code>onAbort</code>æ˜¯è·³è½¬å¤±è´¥(å–æ¶ˆ)å›è°ƒï¼Œåœ¨è·¯ç”±è¢«å–æ¶ˆæ—¶è°ƒç”¨</li>
</ul>
</li>
<li>çœ‹ä¸‹å†…éƒ¨é€»è¾‘</li>
<li>è°ƒç”¨<code>routerå®ä¾‹</code>çš„<code>match</code>æ–¹æ³•ï¼Œä»è·¯ç”±æ˜ å°„è¡¨ä¸­å–åˆ°å°†è¦è·³è½¬åˆ°çš„è·¯ç”±å¯¹è±¡<code>route</code>ï¼›è¿™å…¶å®å°±æ˜¯<code>è·¯ç”±åŒ¹é…</code>è¿‡ç¨‹ï¼›</li>
<li>æ‹¿åˆ°å°†è¦è·³è½¬çš„<code>route</code>åï¼Œè°ƒç”¨<code>confirmTransition</code>å®Œæˆ<code>route</code>çš„è§£æè·³è½¬ï¼Œå¹¶åœ¨è·³è½¬æˆåŠŸã€å–æ¶ˆæ—¶è°ƒç”¨å¯¹åº”å›è°ƒæ–¹æ³•ï¼›è¿™æ˜¯<code>å¯¼èˆªè§£æ</code>è¿‡ç¨‹<ul>
<li>æˆåŠŸæ—¶ï¼Œè°ƒç”¨<code>updateRoute</code>è§¦å‘é‡æ–°æ¸²æŸ“ï¼Œç„¶åè§¦å‘ç›¸å…³å›è°ƒï¼›å…³äºæ¸²æŸ“ï¼Œæˆ‘ä»¬åé¢ç« èŠ‚ä¼šè®²</li>
<li>å–æ¶ˆ(å¤±è´¥)æ—¶ï¼Œè§¦å‘ç›¸å…³å›è°ƒ</li>
</ul>
</li>
<li>é‚£æˆ‘ä»¬ä¸‹é¢å…ˆçœ‹ä¸‹è·¯ç”±åŒ¹é…è¿‡ç¨‹</li>
</ul>
<h2 id="è·¯ç”±åŒ¹é…"><a href="#è·¯ç”±åŒ¹é…" class="headerlink" title="è·¯ç”±åŒ¹é…"></a>è·¯ç”±åŒ¹é…</h2><ul>
<li><code>transitionTo</code>ä¸­ä¼šè°ƒç”¨<code>routerå®ä¾‹</code>çš„<code>match</code>æ–¹æ³•å®ç°è·¯ç”±åŒ¹é…</li>
</ul>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/index.js</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">class</span> VueRouter &#123;</span><br><span class="line">  ...</span><br><span class="line"></span><br><span class="line">  <span class="keyword">constructor</span> (<span class="params">options: RouterOptions = &#123;&#125;</span>) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">this</span>.matcher = createMatcher(options.routes || [], <span class="keyword">this</span>)</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// è·å–åŒ¹é…çš„è·¯ç”±å¯¹è±¡</span></span><br><span class="line">  match (</span><br><span class="line">    raw: RawLocation,</span><br><span class="line">    current?: Route,</span><br><span class="line">    redirectedFrom?: Location</span><br><span class="line">  ): Route &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.matcher.match(raw, current, redirectedFrom)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><code>routerå®ä¾‹çš„match</code>æ–¹æ³•ï¼Œåˆè°ƒç”¨çš„åŒ¹é…å™¨çš„<code>match</code>æ–¹æ³•ï¼Œå°†å‚æ•°ç›´æ¥é€ä¼ è¿‡å»<ul>
<li>å…³äºåŒ¹é…çš„åˆ›å»ºå¯ä»¥çœ‹ä¹‹å‰çš„<code>åˆ›å»ºåŒ¹é…å™¨</code>ç« èŠ‚</li>
</ul>
</li>
<li>æˆ‘ä»¬ç»§ç»­çœ‹åŒ¹é…å™¨çš„<code>match</code>æ–¹æ³•</li>
</ul>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/create-matcher.js</span></span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span>Â <span class="function"><span class="keyword">function</span>Â <span class="title">createMatcher</span>Â (<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">Â Â routes:Â <span class="built_in">Array</span>&lt;RouteConfig&gt;,Â <span class="comment">//Â è·¯ç”±é…ç½®åˆ—è¡¨</span></span></span></span><br><span class="line"><span class="function"><span class="params">Â Â router:Â VueRouterÂ <span class="comment">//Â VueRouterå®ä¾‹</span></span></span></span><br><span class="line"><span class="function"><span class="params"></span>):Â <span class="title">Matcher</span>Â </span>&#123;</span><br><span class="line">Â  ...</span><br><span class="line"></span><br><span class="line">Â Â <span class="comment">//Â ä¼ å…¥location,è¿”å›åŒ¹é…çš„Routeå¯¹è±¡</span></span><br><span class="line">Â Â <span class="function"><span class="keyword">function</span>Â <span class="title">match</span>Â (<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">Â Â Â Â raw:Â RawLocation,</span></span></span><br><span class="line"><span class="function"><span class="params">Â Â Â Â currentRoute?:Â Route,</span></span></span><br><span class="line"><span class="function"><span class="params">Â Â Â Â redirectedFrom?:Â Location</span></span></span><br><span class="line"><span class="function"><span class="params">Â Â </span>):Â <span class="title">Route</span>Â </span>&#123;</span><br><span class="line">Â Â Â Â <span class="comment">//Â è·å–æ ¼å¼åŒ–åçš„locationï¼Œç”±äºé—­åŒ…ç‰¹æ€§ï¼Œæ‰€ä»¥æ­¤å¤„èƒ½è®¿é—®åˆ°routerå®ä¾‹</span></span><br><span class="line">Â Â Â Â <span class="keyword">const</span>Â locationÂ =Â normalizeLocation(raw,Â currentRoute,Â <span class="literal">false</span>,Â router)</span><br><span class="line">Â Â Â Â <span class="keyword">const</span>Â &#123;Â nameÂ &#125;Â =Â location</span><br><span class="line"></span><br><span class="line">Â Â Â Â <span class="comment">//Â é€šè¿‡nameåŒ¹é…</span></span><br><span class="line">Â Â Â Â <span class="keyword">if</span>Â (name)Â &#123;</span><br><span class="line">Â Â Â Â Â Â <span class="keyword">const</span>Â recordÂ =Â nameMap[name]</span><br><span class="line">Â Â Â Â Â Â <span class="keyword">if</span>Â (process.env.NODE_ENVÂ !==Â <span class="string">'production'</span>)Â &#123;</span><br><span class="line">Â Â Â Â Â Â Â Â <span class="comment">//Â æœªæ‰¾åˆ°è­¦å‘Š</span></span><br><span class="line">Â Â Â Â Â Â Â Â warn(record,Â <span class="string">`RouteÂ withÂ nameÂ '<span class="subst">$&#123;name&#125;</span>'Â doesÂ notÂ exist`</span>)</span><br><span class="line">Â Â Â Â Â Â &#125;</span><br><span class="line"></span><br><span class="line">Â Â Â Â Â Â <span class="comment">//Â æœªæ‰¾åˆ°è·¯ç”±è®°å½•ï¼Œåˆ™åˆ›å»ºä¸€ä¸ªç©ºRouteè¿”å›</span></span><br><span class="line">Â Â Â Â Â Â <span class="keyword">if</span>Â (!record)Â <span class="keyword">return</span>Â _createRoute(<span class="literal">null</span>,Â location)</span><br><span class="line"></span><br><span class="line">Â Â Â Â Â Â <span class="comment">//Â è·å–åŠ¨æ€è·¯ç”±å‚æ•°å</span></span><br><span class="line">Â Â Â Â Â Â <span class="keyword">const</span>Â paramNamesÂ =Â record.regex.keys</span><br><span class="line">Â Â Â Â Â Â Â Â .filter(<span class="function"><span class="params">key</span>Â =&gt;</span>Â !key.optional)</span><br><span class="line">Â Â Â Â Â Â Â Â .map(<span class="function"><span class="params">key</span>Â =&gt;</span>Â key.name)</span><br><span class="line">Â Â Â Â Â Â <span class="keyword">if</span>Â (<span class="keyword">typeof</span>Â location.paramsÂ !==Â <span class="string">'object'</span>)Â &#123;</span><br><span class="line">Â Â Â Â Â Â Â Â location.paramsÂ =Â &#123;&#125;</span><br><span class="line">Â Â Â Â Â Â &#125;</span><br><span class="line"></span><br><span class="line">Â Â Â Â Â Â <span class="comment">//Â æå–å½“å‰Routeä¸­ç¬¦åˆåŠ¨æ€è·¯ç”±å‚æ•°åçš„å€¼èµ‹å€¼ç»™location</span></span><br><span class="line">Â Â Â Â Â Â <span class="keyword">if</span>Â (currentRouteÂ &amp;&amp;Â <span class="keyword">typeof</span>Â currentRoute.paramsÂ ===Â <span class="string">'object'</span>)Â &#123;</span><br><span class="line">Â Â Â Â Â Â Â Â <span class="keyword">for</span>Â (<span class="keyword">const</span>Â keyÂ <span class="keyword">in</span>Â currentRoute.params)Â &#123;</span><br><span class="line">Â Â Â Â Â Â Â Â Â Â <span class="keyword">if</span>Â (!(keyÂ <span class="keyword">in</span>Â location.params)Â &amp;&amp;Â paramNames.indexOf(key)Â &gt;Â <span class="number">-1</span>)Â &#123;</span><br><span class="line">Â Â Â Â Â Â Â Â Â Â Â Â location.params[key]Â =Â currentRoute.params[key]</span><br><span class="line">Â Â Â Â Â Â Â Â Â Â &#125;</span><br><span class="line">Â Â Â Â Â Â Â Â &#125;</span><br><span class="line">Â Â Â Â Â Â &#125;</span><br><span class="line"></span><br><span class="line">Â Â Â Â Â Â <span class="comment">//Â å¡«å……params</span></span><br><span class="line">Â Â Â Â Â Â location.pathÂ =Â fillParams(record.path,Â location.params,Â <span class="string">`namedÂ routeÂ "<span class="subst">$&#123;name&#125;</span>"`</span>)</span><br><span class="line"></span><br><span class="line">Â Â Â Â Â Â <span class="comment">//Â åˆ›å»ºroute</span></span><br><span class="line">Â Â Â Â Â Â <span class="keyword">return</span>Â _createRoute(record,Â location,Â redirectedFrom)</span><br><span class="line">Â Â Â Â &#125;Â <span class="keyword">else</span>Â <span class="keyword">if</span>Â (location.path)Â &#123;</span><br><span class="line">Â Â Â Â Â Â location.paramsÂ =Â &#123;&#125;</span><br><span class="line"></span><br><span class="line">Â Â Â Â Â Â <span class="comment">//Â éå†pathListï¼Œæ‰¾åˆ°èƒ½åŒ¹é…åˆ°çš„è®°å½•ï¼Œç„¶åç”ŸæˆRoute</span></span><br><span class="line">Â Â Â Â Â Â <span class="keyword">for</span>Â (<span class="keyword">let</span>Â iÂ =Â <span class="number">0</span>;Â iÂ &lt;Â pathList.length;Â i++)Â &#123;</span><br><span class="line">Â Â Â Â Â Â Â Â <span class="keyword">const</span>Â pathÂ =Â pathList[i]</span><br><span class="line">Â Â Â Â Â Â Â Â <span class="keyword">const</span>Â recordÂ =Â pathMap[path]</span><br><span class="line">Â Â Â Â Â Â Â Â <span class="keyword">if</span>Â (matchRoute(record.regex,Â location.path,Â location.params))Â &#123;</span><br><span class="line"></span><br><span class="line">Â Â Â Â Â Â Â Â Â Â <span class="comment">//Â æ‰¾åˆ°åŒ¹é…çš„è·¯ç”±è®°å½•åï¼Œç”Ÿæˆå¯¹åº”Route</span></span><br><span class="line">Â Â Â Â Â Â Â Â Â Â <span class="keyword">return</span>Â _createRoute(record,Â location,Â redirectedFrom)</span><br><span class="line">Â Â Â Â Â Â Â Â &#125;</span><br><span class="line">Â Â Â Â Â Â &#125;</span><br><span class="line">Â Â Â Â &#125;</span><br><span class="line"></span><br><span class="line">Â Â Â Â <span class="comment">//Â noÂ match</span></span><br><span class="line">Â Â Â Â <span class="keyword">return</span>Â _createRoute(<span class="literal">null</span>,Â location)</span><br><span class="line">Â Â &#125;</span><br><span class="line">Â Â Â </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>ç”±äº<code>router.match</code>æ˜¯å°†å‚æ•°é€ä¼ è¿‡æ¥çš„ï¼Œæ‰€ä»¥äºŒè€…çš„ç­¾åä¸€æ¨¡ä¸€æ ·<ul>
<li><code>raw</code>æ˜¯<code>RawLocation</code>ç±»å‹ï¼Œæ˜¯éœ€è¦è¿›è¡Œè·¯ç”±åŒ¹é…çš„åœ°å€</li>
<li><code>currentRoute</code>æ˜¯å½“å‰è·¯ç”±å¯¹è±¡</li>
<li><code>redirectedFrom</code>ä»£è¡¨ä»å“ªä¸ªåœ°å€é‡å®šå‘è¿‡æ¥çš„</li>
</ul>
</li>
<li>æˆ‘ä»¬çœ‹ä¸‹<code>match</code>æ–¹æ³•é€»è¾‘<ul>
<li>é¦–å…ˆå®ƒå¯¹ä¼ å…¥çš„<code>raw</code>åœ°å€ï¼Œè¿›è¡Œäº†æ ¼å¼åŒ–(è§„èŒƒåŒ–)</li>
<li>ç„¶åå–å‡ºæ ¼å¼åŒ–åœ°å€ä¸­çš„<code>name</code></li>
<li><code>name</code>å­˜åœ¨ï¼Œåˆ¤æ–­æ˜¯å¦èƒ½é€šè¿‡<code>name</code>åœ¨<code>nameMap</code>ä¸­æ‰¾åˆ°å¯¹åº”çš„è·¯ç”±è®°å½•<code>RouteRecord</code><ul>
<li>æ— æ³•æ‰¾åˆ°ï¼Œåˆ™åˆ›å»ºä¸€ä¸ªæ–°<code>route</code>å¯¹è±¡è¿”å›</li>
<li>å¯ä»¥æ‰¾åˆ°ï¼Œåˆ™å¡«å……<code>params</code>ï¼Œå¹¶ä½¿ç”¨æ­¤è·¯ç”±è®°å½•åˆ›å»ºä¸€ä¸ªæ–°çš„<code>Route</code>å¯¹è±¡è¿”å›</li>
</ul>
</li>
<li><code>name</code>ä¸å­˜åœ¨ï¼Œåˆ™åˆ¤æ–­<code>path</code>æ˜¯å¦å­˜åœ¨<ul>
<li>å­˜åœ¨ï¼Œåˆ™åˆ©ç”¨<code>pathListã€pathMap</code>è°ƒç”¨<code>matchRoute</code>åˆ¤æ–­æ˜¯å¦åŒ¹é…ï¼Œè¿›è€Œæ‰¾åˆ°åŒ¹é…çš„è·¯ç”±è®°å½•ï¼Œç„¶åä½¿ç”¨æ­¤è·¯ç”±è®°å½•åˆ›å»ºæ–°<code>route</code>å¯¹è±¡è¿”å›</li>
</ul>
</li>
<li><code>name</code>ã€<code>path</code>éƒ½ä¸å­˜åœ¨<ul>
<li>åˆ™ç›´æ¥åˆ›å»ºä¸€ä¸ªæ–°<code>route</code>å¯¹è±¡è¿”å›</li>
</ul>
</li>
</ul>
</li>
<li>æ´»åŠ¨å›¾å¦‚ä¸‹</li>
<li>match.png<ul>
<li><img src="/2020/12/01/vue-router-analysis-part2/match.png" alt="match.png"></li>
</ul>
</li>
<li>æˆ‘ä»¬æå–ä¸€ä¸‹ä¸Šè¿°æµç¨‹çš„å…³é”®è¯<ul>
<li><code>åœ°å€æ ¼å¼åŒ–normalizeLocation</code>ã€<code>åœ°å€æ˜¯å¦åŒ¹é…åˆ¤æ–­matchRoute</code>ã€<code>å¡«å……å‚æ•°fillParams</code>ã€<code>åˆ›å»ºè·¯ç”±å¯¹è±¡_createRoute</code></li>
</ul>
</li>
</ul>
<h3 id="åœ°å€æ ¼å¼åŒ–-normalizeLocation"><a href="#åœ°å€æ ¼å¼åŒ–-normalizeLocation" class="headerlink" title="åœ°å€æ ¼å¼åŒ– normalizeLocation"></a>åœ°å€æ ¼å¼åŒ– normalizeLocation</h3><ul>
<li>æˆ‘ä»¬çœ‹ä¸‹ä¸ºä½•éœ€è¦å¯¹åœ°å€åšæ ¼å¼åŒ–</li>
<li>æˆ‘ä»¬çŸ¥é“<code>VueRoute</code>å®šä¹‰çš„åœ°å€æ˜¯<code>RawLocation</code>ç±»å‹çš„ï¼Œè€Œå®ƒæ˜¯è”åˆç±»å‹çš„ï¼Œæ”¯æŒ<code>string</code>å’Œ<code>Location</code>ç±»å‹</li>
</ul>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// flow/declarations.js</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">declare</span> <span class="keyword">type</span> Location = &#123;</span><br><span class="line">  _normalized?: <span class="built_in">boolean</span></span><br><span class="line">  name?: <span class="built_in">string</span></span><br><span class="line">  path?: <span class="built_in">string</span></span><br><span class="line">  hash?: <span class="built_in">string</span></span><br><span class="line">  query?: Dictionary&lt;<span class="built_in">string</span>&gt;</span><br><span class="line">  params?: Dictionary&lt;<span class="built_in">string</span>&gt;</span><br><span class="line">  append?: <span class="built_in">boolean</span></span><br><span class="line">  replace?: <span class="built_in">boolean</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">declare</span> <span class="keyword">type</span> RawLocation = <span class="built_in">string</span> | Location</span><br></pre></td></tr></table></figure>
<ul>
<li>æ‰€ä»¥ä¸‹é¢çš„åœ°å€éƒ½æ˜¯åˆæ³•çš„</li>
<li><code>$router.push</code>æ–¹æ³•çš„å‚æ•°ä¹Ÿæ˜¯çš„<code>RawLocation</code>ç±»å‹ï¼Œæ‰€ä»¥ä½¿ç”¨<code>$router.push</code>æ¥ä¸¾ä¾‹</li>
</ul>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å­—ç¬¦ä¸²å½¢å¼</span></span><br><span class="line"><span class="keyword">this</span>.$router.push(<span class="string">'home'</span>) <span class="comment">// ç›¸å¯¹</span></span><br><span class="line"><span class="keyword">this</span>.$router.push(<span class="string">'/home'</span>) <span class="comment">// ç»å¯¹</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Location å¯¹è±¡å½¢å¼</span></span><br><span class="line"><span class="keyword">this</span>.$router.push(&#123; path: <span class="string">'home'</span> &#125;)</span><br><span class="line"><span class="keyword">this</span>.$router.push(&#123; path: <span class="string">'/home'</span> &#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">this</span>.$router.push(&#123; path: <span class="string">'/home'</span>, query: &#123; test: <span class="number">3</span> &#125; &#125;) <span class="comment">// æºå¸¦qs</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">this</span>.$router.push(&#123; name: <span class="string">'home'</span> &#125;) <span class="comment">// å‘½åè·¯ç”±</span></span><br><span class="line"><span class="keyword">this</span>.$router.push(&#123; name: <span class="string">'detail'</span>, params: &#123; id: <span class="number">1</span> &#125; &#125;) <span class="comment">// å‘½å+å¸¦å‚</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">this</span>.$router.push(&#123; params: &#123; id: <span class="number">1</span> &#125; &#125;) <span class="comment">// ä»…å¸¦å‚ï¼Œé’ˆå¯¹ä»…æœ‰å‚æ•°å˜åŒ–çš„ç›¸å¯¹è·³è½¬ï¼›ç›¸å¯¹å‚æ•°è·³è½¬</span></span><br></pre></td></tr></table></figure>
<ul>
<li>å¯ä»¥çœ‹åˆ°<code>VueRouter</code>éœ€è¦å…¼å®¹ä¸Šé¢æ‰€æœ‰æƒ…å†µï¼Œä¸ºäº†æ–¹ä¾¿å¤„ç†ï¼Œéœ€è¦å¯¹åœ°å€åšæ ¼å¼åŒ–</li>
<li>çœ‹ä¸‹å®ç°é€»è¾‘</li>
</ul>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/util/location.js</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//Â æ ¼å¼åŒ–location</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">normalizeLocation</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  raw: RawLocation, <span class="comment">//Â åŸå§‹locationï¼Œä¸€ä¸ªstringï¼Œæˆ–è€…æ˜¯ä¸€ä¸ªå·²ç»æ ¼å¼åŒ–åçš„location</span></span></span></span><br><span class="line"><span class="function"><span class="params">  current: ?Route, <span class="comment">//Â å½“å‰è·¯ç”±å¯¹è±¡</span></span></span></span><br><span class="line"><span class="function"><span class="params">  append: ?<span class="built_in">boolean</span>, <span class="comment">//Â æ˜¯å¦æ˜¯è¿½åŠ æ¨¡å¼</span></span></span></span><br><span class="line"><span class="function"><span class="params">  router: ?VueRouter <span class="comment">//Â VueRouterå®ä¾‹</span></span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">Location</span> </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> next: Location = <span class="keyword">typeof</span> raw === <span class="string">'string'</span> ? &#123; path: raw &#125; : raw <span class="comment">//Â namedÂ target //Â å·²ç»æ ¼å¼åŒ–è¿‡ï¼Œç›´æ¥è¿”å›</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (next._normalized) &#123;</span><br><span class="line">    <span class="keyword">return</span> next</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (next.name) &#123;</span><br><span class="line">    <span class="comment">//Â å¤„ç†å‘½åå½¢å¼ï¼Œä¾‹å¦‚&#123;name:'Home',params:&#123;id:3&#125;&#125;</span></span><br><span class="line">    next = extend(&#123;&#125;, raw)</span><br><span class="line">    <span class="keyword">const</span> params = next.params</span><br><span class="line">    <span class="keyword">if</span> (params &amp;&amp; <span class="keyword">typeof</span> params === <span class="string">'object'</span>) &#123;</span><br><span class="line">      next.params = extend(&#123;&#125;, params)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> next</span><br><span class="line">  &#125; <span class="comment">//Â relativeÂ params //Â å¤„ç†&#123;params:&#123;id:1&#125;&#125;ç›¸å¯¹å‚æ•°å½¢å¼è·³è½¬</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!next.path &amp;&amp; next.params &amp;&amp; current) &#123;</span><br><span class="line">    next = extend(&#123;&#125;, next)</span><br><span class="line">    next._normalized = <span class="literal">true</span></span><br><span class="line">    <span class="keyword">const</span> params: <span class="built_in">any</span> = extend(extend(&#123;&#125;, current.params), next.params) <span class="comment">//Â æå–å½“å‰routeçš„å­—æ®µåšä¸ºnextçš„å­—æ®µï¼Œå› ä¸ºç›¸å¯¹å‚æ•°å½¢å¼ï¼Œåªæœ‰paramsï¼Œå¿…é¡»å€ŸåŠ©currentæå–ä¸€äº›å­—æ®µ</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (current.name) &#123;</span><br><span class="line">      <span class="comment">//Â å‘½åå½¢å¼</span></span><br><span class="line">      next.name = current.name</span><br><span class="line">      next.params = params</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (current.matched.length) &#123;</span><br><span class="line">      <span class="comment">//Â pathå½¢å¼ï¼Œä»åŒ¹é…è®°å½•ä¸­æå–å‡ºå½“å‰pathå¹¶å¡«å……å‚æ•°</span></span><br><span class="line">      <span class="keyword">const</span> rawPath = current.matched[current.matched.length - <span class="number">1</span>].path</span><br><span class="line">      next.path = fillParams(rawPath, params, <span class="string">`pathÂ <span class="subst">$&#123;current.path&#125;</span>`</span>)</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (process.env.NODE_ENV !== <span class="string">'production'</span>) &#123;</span><br><span class="line">      warn(<span class="literal">false</span>, <span class="string">`relativeÂ paramsÂ navigationÂ requiresÂ aÂ currentÂ route.`</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> next</span><br><span class="line">  &#125; <span class="comment">//Â å¤„ç†pathå½¢å¼è·³è½¬ï¼Œä¾‹å¦‚&#123;path:'/test',query:&#123;test:3&#125;&#125; //Â è§£æpath</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> parsedPath = parsePath(next.path || <span class="string">''</span>)</span><br><span class="line">  <span class="keyword">const</span> basePath = (current &amp;&amp; current.path) || <span class="string">'/'</span></span><br><span class="line">  <span class="keyword">const</span> path = parsedPath.path</span><br><span class="line">    ? resolvePath(parsedPath.path, basePath, append || next.append)</span><br><span class="line">    : basePath <span class="comment">//Â è§£æquery</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> query = resolveQuery(</span><br><span class="line">    parsedPath.query,</span><br><span class="line">    next.query, <span class="comment">//Â é¢å¤–éœ€è¦è¿½åŠ çš„qs</span></span><br><span class="line">    router &amp;&amp; router.options.parseQuery <span class="comment">//Â æ”¯æŒä¼ å…¥è‡ªå®šä¹‰è§£æqueryçš„æ–¹æ³•</span></span><br><span class="line">  ) <span class="comment">//Â è§£æhash</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> hash = next.hash || parsedPath.hash</span><br><span class="line">  <span class="keyword">if</span> (hash &amp;&amp; hash.charAt(<span class="number">0</span>) !== <span class="string">'#'</span>) &#123;</span><br><span class="line">    hash = <span class="string">`#<span class="subst">$&#123;hash&#125;</span>`</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    _normalized: <span class="literal">true</span>, <span class="comment">//Â æ ‡è¯†å·²ç»æ ¼å¼åŒ–è¿‡</span></span><br><span class="line">    path,</span><br><span class="line">    query,</span><br><span class="line">    hash,</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>é¦–å…ˆå°†<code>string</code>ç±»å‹çš„è½¬æ¢ä¸ºå¯¹è±¡å½¢å¼ï¼Œæ–¹ä¾¿åé¢ç»Ÿä¸€å¤„ç†</li>
<li>å¦‚æœå‘ç°åœ°å€å·²ç»åšè¿‡æ ¼å¼åŒ–å¤„ç†ï¼Œåˆ™ç›´æ¥è¿”å›</li>
<li>å†åˆ¤æ–­æ˜¯å¦æ˜¯å‘½åè·¯ç”±<ul>
<li>è‹¥æ˜¯ï¼Œåˆ™æ‹·è´åŸå§‹åœ°å€<code>raw</code>ï¼Œæ‹·è´<code>params</code>ï¼Œç›´æ¥è¿”å›</li>
</ul>
</li>
<li>å¤„ç†äº†ä»…æºå¸¦å‚æ•°çš„ç›¸å¯¹è·¯ç”±(ç›¸å¯¹å‚æ•°)è·³è½¬ï¼Œå°±æ˜¯<code>this.$router.push({params:{id:1}})</code>å½¢å¼<ul>
<li>å¯¹è¿™ç§åœ°å€çš„å®šä¹‰æ˜¯<code>æ²¡æœ‰path</code>ã€<code>ä»…æœ‰params</code>å¹¶ä¸”<code>å½“å‰è·¯ç”±å¯¹è±¡å­˜åœ¨</code></li>
<li>ä¸»è¦å¤„ç†é€»è¾‘æ˜¯<ul>
<li>å…ˆåˆå¹¶<code>params</code></li>
<li>è‹¥æ˜¯å‘½åè·¯ç”±ï¼Œåˆ™ä½¿ç”¨<code>current.name</code>åšä¸º<code>next.name</code>ï¼Œå¹¶èµ‹å€¼<code>params</code></li>
<li>éå‘½åè·¯ç”±ï¼Œä»å½“å‰è·¯ç”±å¯¹è±¡ä¸­æ‰¾åˆ°åŒ¹é…çš„è·¯ç”±è®°å½•ï¼Œå¹¶å–å‡ºè·¯ç”±è®°å½•ä¸Šçš„<code>path</code>åšä¸º<code>next.path</code>ï¼Œç„¶åå¡«å……<code>params</code></li>
<li>è¿”å›å¤„ç†å¥½çš„åœ°å€</li>
</ul>
</li>
<li>ç”±äºè¿™ä¸­è·³è½¬æ–¹å¼ï¼Œä»…æœ‰<code>params</code>ï¼Œæ‰€ä»¥å¿…é¡»ä»å½“å‰è·¯ç”±å¯¹è±¡<code>current</code>ä¸Šè·å–å¯ç”¨å­—æ®µ(<code>path</code>ã€<code>name</code>)ï¼Œåšä¸ºè‡ªèº«å€¼ï¼Œç„¶åè·³è½¬</li>
</ul>
</li>
<li>å¤„ç†é€šè¿‡<code>path</code>è·³è½¬çš„æ–¹å¼<ul>
<li>è°ƒç”¨<code>parsePath</code>ä»<code>path</code>ä¸­è§£æå‡º<code>pathã€queryã€hash</code></li>
<li>ç„¶åä»¥<code>current.path</code>ä¸º<code>basePath</code>ï¼Œè§£æ(<code>resolve</code>)å‡º<code>æœ€ç»ˆpath</code></li>
<li>å¯¹<code>query</code>è¿›è¡Œåˆå¹¶æ“ä½œ</li>
<li>å¯¹<code>hash</code>è¿›è¡Œå‰è¿½åŠ <code>#</code>æ“ä½œ</li>
<li>è¿”å›å¸¦æœ‰<code>_normalized:true</code>æ ‡è¯†çš„<code>Location</code>å¯¹è±¡</li>
</ul>
</li>
<li>ç»è¿‡ä¸Šé¢ä¸€ç•ªå¤„ç†ï¼Œæ— è®ºä¼ å…¥ä½•ç§åœ°å€ï¼Œéƒ½è¿”å›ä¸€ä¸ªå¸¦æœ‰<code>_normalized:true</code>æ ‡è¯†çš„<code>Locationç±»å‹</code>çš„å¯¹è±¡</li>
<li>normalize-location.png<ul>
<li><img src="/2020/12/01/vue-router-analysis-part2/normalize-location.png" alt="normalize-location.png"></li>
</ul>
</li>
</ul>
<h3 id="åœ°å€æ˜¯å¦åŒ¹é…åˆ¤æ–­-matchRoute"><a href="#åœ°å€æ˜¯å¦åŒ¹é…åˆ¤æ–­-matchRoute" class="headerlink" title="åœ°å€æ˜¯å¦åŒ¹é…åˆ¤æ–­ matchRoute"></a>åœ°å€æ˜¯å¦åŒ¹é…åˆ¤æ–­ matchRoute</h3><ul>
<li>æˆ‘ä»¬çŸ¥é“<code>VueRouter</code>æ˜¯æ”¯æŒåŠ¨æ€è·¯ç”±åŒ¹é…çš„ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤º</li>
<li>dynamic-route.png<ul>
<li><img src="/2020/12/01/vue-router-analysis-part2/dynamic-route.png" alt="dynamic-route.png"></li>
</ul>
</li>
<li>æˆ‘ä»¬åœ¨ä¸Šç¯‡çš„<code>ç”Ÿæˆè·¯ç”±è®°å½•</code>ç« èŠ‚ä¹Ÿä»‹ç»è¿‡ï¼Œ<code>VueRouter</code>åœ¨ç”Ÿæˆè·¯ç”±è®°å½•æ—¶ï¼Œä¼šé€šè¿‡<code>path-to-regexp</code>åŒ…ç”Ÿæˆä¸€ä¸ªæ­£åˆ™æ‰©å±•å¯¹è±¡å¹¶èµ‹å€¼åˆ°è·¯ç”±è®°å½•çš„<code>regex</code>å­—æ®µä¸Šï¼Œç”¨äºåç»­çš„åŠ¨æ€è·¯ç”±å‚æ•°çš„è·å–<ul>
<li>ä¸»è¦çš„é€»è¾‘æ˜¯æä¾›ä¸€ä¸ªåŠ¨æ€è·¯ç”±<code>user/:id</code>å’Œä¸€ä¸ªåœ°å€<code>/user/345</code>ï¼Œé€šè¿‡<code>path-to-regexp</code>å°±èƒ½ç”Ÿæˆä¸€ä¸ªå¯¹è±¡<code>{id:345}</code>æ¥è¡¨è¾¾å‚æ•°çš„æ˜ å°„å…³ç³»</li>
<li>æ˜¯ä¸€ä¸ªå€ŸåŠ©åŠ¨æ€è·¯ç”±ï¼Œä» url ä¸Šæå–å‚æ•°çš„è¿‡ç¨‹ï¼›<code>/user/345</code>-&gt;<code>{id:345}</code></li>
<li>å…·ä½“ä¾‹å­å¯æŸ¥çœ‹<code>ç”Ÿæˆè·¯ç”±è®°å½•</code>ç« èŠ‚</li>
</ul>
</li>
<li>ä¸Šè¿°æå–å‚æ•°çš„é€»è¾‘æ˜¯åœ¨<code>matchRoute</code>å®ç°çš„</li>
<li><code>matchRoute</code>ä½äº<code>src/create-matcher.js</code></li>
</ul>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/create-matcher.js</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//Â æ£€æŸ¥pathæ˜¯å¦èƒ½é€šè¿‡regexçš„åŒ¹é…ï¼Œå¹¶å¯¹paramså¯¹è±¡æ­£ç¡®èµ‹å€¼</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">matchRoute</span>(<span class="params">regex: RouteRegExp, path: <span class="built_in">string</span>, params: <span class="built_in">Object</span></span>): <span class="title">boolean</span> </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> m = path.match(regex)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!m) &#123;</span><br><span class="line">    <span class="comment">//Â æ— æ³•åŒ¹é…ä¸Š</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!params) &#123;</span><br><span class="line">    <span class="comment">//Â ç¬¦åˆæ­£åˆ™Â &amp;&amp;Â paramsä¸å­˜åœ¨ï¼Œåˆ™è¡¨ç¤ºå¯ä»¥åŒ¹é…</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">  &#125; <span class="comment">//Â ç¬¦åˆæ­£åˆ™Â &amp;&amp;Â paramså­˜åœ¨ï¼Œéœ€è¦å¯¹paramsè¿›è¡Œæ­£ç¡®èµ‹å€¼ //Â path-to-regexpä¼šå°†æ¯ä¸ªåŠ¨æ€è·¯ç”±æ ‡è®°å¤„å¤„ç†æˆæ­£åˆ™çš„ä¸€ä¸ªç»„ï¼Œæ‰€ä»¥iä»1å¼€å§‹ //Â å‚è€ƒhttps://www.npmjs.com/package/path-to-regexp //Â constÂ keysÂ =Â []; //Â constÂ regexpÂ =Â pathToRegexp("/foo/:bar",Â keys); //Â regexpÂ =Â /^\/foo\/([^\/]+?)\/?$/i //Â :barå°±è¢«å¤„ç†æˆæ­£åˆ™çš„ä¸€ä¸ªç»„äº† //Â keysÂ =Â [&#123;Â name:Â 'bar',Â prefix:Â '/',Â suffix:Â '',Â pattern:Â '[^\\/#\\?]+?',Â modifier:Â ''Â &#125;]</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">1</span>, len = m.length; i &lt; len; ++i) &#123;</span><br><span class="line">    <span class="keyword">const</span> key = regex.keys[i - <span class="number">1</span>] <span class="comment">//Â regex.keysè¿”å›åŒ¹é…åˆ°çš„</span></span><br><span class="line">    <span class="keyword">const</span> val = <span class="keyword">typeof</span> m[i] === <span class="string">'string'</span> ? <span class="built_in">decodeURIComponent</span>(m[i]) : m[i]</span><br><span class="line">    <span class="keyword">if</span> (key) &#123;</span><br><span class="line">      <span class="comment">//Â FixÂ #1994:Â usingÂ *Â withÂ props:Â trueÂ generatesÂ aÂ paramÂ namedÂ 0</span></span><br><span class="line">      params[key.name || <span class="string">'pathMatch'</span>] = val</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> truee</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>é€šè¿‡æ–¹æ³•ç­¾åï¼Œå¯ä»¥çŸ¥é“å®ƒè¿”å›ä¸€ä¸ª<code>boolean</code>å€¼ï¼Œè¿™ä¸ªå€¼ä»£è¡¨ä¼ å…¥çš„<code>path</code>æ˜¯å¦èƒ½é€šè¿‡<code>regexçš„åŒ¹é…</code>ï¼›è™½ç„¶è¿”å›ä¸€ä¸ª<code>boolean</code>å€¼ï¼Œä½†æ˜¯å…¶å†…éƒ¨è¿˜åšäº†ä»¶å¾ˆé‡è¦çš„äº‹ï¼Œä»<code>path</code>ä¸Šæå–åŠ¨æ€è·¯ç”±å‚æ•°å€¼ï¼Œæˆ‘ä»¬çœ‹ä¸‹å®Œæ•´é€»è¾‘</li>
<li>é¦–å…ˆè°ƒç”¨<code>path.match(regex)</code></li>
<li>ä¸èƒ½åŒ¹é…ç›´æ¥è¿”å›<code>false</code></li>
<li>å¯ä»¥åŒ¹é…ä¸”æ— <code>params</code>ï¼Œè¿”å›<code>true</code></li>
<li>å‰©ä¸‹çš„å°±åªæœ‰ä¸€ç§æƒ…å†µï¼Œå¯ä»¥åŒ¹é…ä¸”<code>params</code>å­˜åœ¨ï¼Œæ­¤æ—¶éœ€è¦å¯¹<code>params</code>è¿›è¡Œæ­£ç¡®èµ‹å€¼<ul>
<li>æ•´ä¸ªèµ‹å€¼ï¼Œä¸»è¦æ˜¯éå†<code>path.match(regex)</code>è¿”å›å€¼å¹¶å–å‡º<code>regex</code>ä¸­å­˜å‚¨çš„<code>key</code>ï¼Œç„¶åä¾æ¬¡èµ‹å€¼ï¼Œå…³äºç»†èŠ‚å¯ä»¥å‚è€ƒä¸Šé¢çš„æ³¨é‡Šï¼›</li>
<li>å…³äº<code>regex</code>ã€<code>path-to-regexp</code>ï¼Œå¯ä»¥å‚è€ƒ<code>ç”Ÿæˆè·¯ç”±è®°å½•</code>ç« èŠ‚å’Œ<code>https://www.npmjs.com/package/path-to-regexp</code></li>
</ul>
</li>
<li>è¿˜æœ‰ä¸€ä¸ªç‚¹ï¼Œèµ‹å€¼æ—¶çš„<code>pathMatch</code>æ˜¯ä»€ä¹ˆï¼Ÿ<ul>
<li>è¿™å…¶å®æ˜¯è·Ÿé€šé…ç¬¦å³<code>*</code>æœ‰å…³çš„</li>
<li><code>VueRouter</code>å…³äºé€šé…ç¬¦çš„ç‰¹æ®Šå¤„ç†å¯ä»¥çœ‹<a href="https://router.vuejs.org/zh/guide/essentials/dynamic-matching.html#æ•è·æ‰€æœ‰è·¯ç”±æˆ–-404-not-found-è·¯ç”±" target="_blank" rel="noopener">https://router.vuejs.org/zh/guide/essentials/dynamic-matching.html#æ•è·æ‰€æœ‰è·¯ç”±æˆ–-404-not-found-è·¯ç”±</a><ul>
<li>å³<code>pathMatch</code>ä¼šä»£è¡¨é€šé…ç¬¦åŒ¹é…åˆ°çš„è·¯å¾„</li>
</ul>
</li>
</ul>
</li>
<li>å®˜æ–¹ä¾‹å­å¦‚ä¸‹</li>
</ul>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="comment">// ä¼šåŒ¹é…æ‰€æœ‰è·¯å¾„</span></span><br><span class="line">  path: <span class="string">'*'</span></span><br><span class="line">&#125;</span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment">// ä¼šåŒ¹é…ä»¥ `/user-` å¼€å¤´çš„ä»»æ„è·¯å¾„</span></span><br><span class="line">  path: <span class="string">'/user-*'</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç»™å‡ºä¸€ä¸ªè·¯ç”± &#123; path: '/user-*' &#125;</span></span><br><span class="line"><span class="keyword">this</span>.$router.push(<span class="string">'/user-admin'</span>)</span><br><span class="line"><span class="keyword">this</span>.$route.params.pathMatch <span class="comment">// 'admin'</span></span><br><span class="line"><span class="comment">// ç»™å‡ºä¸€ä¸ªè·¯ç”± &#123; path: '*' &#125;</span></span><br><span class="line"><span class="keyword">this</span>.$router.push(<span class="string">'/non-existing'</span>)</span><br><span class="line"><span class="keyword">this</span>.$route.params.pathMatch <span class="comment">// '/non-existing'</span></span><br></pre></td></tr></table></figure>
<ul>
<li>match-route.png<ul>
<li><img src="/2020/12/01/vue-router-analysis-part2/match-route.png" alt="match-route.png"></li>
</ul>
</li>
</ul>
<h3 id="å¡«å……å‚æ•°-fillParams"><a href="#å¡«å……å‚æ•°-fillParams" class="headerlink" title="å¡«å……å‚æ•° fillParams"></a>å¡«å……å‚æ•° fillParams</h3><ul>
<li><code>fillParams</code>å¯ä»¥çœ‹åšæ˜¯<code>matchRoute</code>çš„é€†æ“ä½œï¼Œæ˜¯ä¸€ä¸ªå€ŸåŠ©åŠ¨æ€è·¯å¾„ï¼Œä½¿ç”¨å‚æ•°ç”Ÿæˆ url çš„è¿‡ç¨‹ï¼›å³<code>/user/:id</code>+<code>{id:345}</code>-&gt;<code>/user/345</code></li>
<li>å¯ä»¥çœ‹ä¸‹å®ƒçš„å®ç°</li>
</ul>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/util/params.js</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ç¼“å­˜</span></span><br><span class="line"><span class="keyword">const</span> regexpCompileCache: &#123;</span><br><span class="line">  [key: <span class="built_in">string</span>]: <span class="built_in">Function</span></span><br><span class="line">&#125; = <span class="built_in">Object</span>.create(<span class="literal">null</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">//Â å¡«å……åŠ¨æ€è·¯ç”±å‚æ•°</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">fillParams</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  path: <span class="built_in">string</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">  params: ?<span class="built_in">Object</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">  routeMsg: <span class="built_in">string</span></span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">string</span> </span>&#123;</span><br><span class="line">  params = params || &#123;&#125;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">//Â compileä¸»è¦ç”¨æ¥é€†è§£æï¼Œhttps://www.npmjs.com/package/path-to-regexp#compile-reverse-path-to-regexp</span></span><br><span class="line">    <span class="keyword">const</span> filler =</span><br><span class="line">      regexpCompileCache[path] ||</span><br><span class="line">      (regexpCompileCache[path] = Regexp.compile(path)) <span class="comment">//Â ä¿®å¤https://github.com/vuejs/vue-router/issues/2505#issuecomment-442353151 //Â FixÂ #2505Â resolvingÂ asteriskÂ routesÂ &#123;Â name:Â 'not-found',Â params:Â &#123;Â pathMatch:Â '/not-found'Â &#125;&#125; //Â andÂ fixÂ #3106Â soÂ thatÂ youÂ canÂ workÂ withÂ locationÂ descriptorÂ objectÂ havingÂ params.pathMatchÂ equalÂ toÂ emptyÂ string</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> params.pathMatch === <span class="string">'string'</span>) params[<span class="number">0</span>] = params.pathMatch <span class="comment">//Â è¿”å›é€†è§£æåçš„è·¯å¾„</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> filler(params, &#123; pretty: <span class="literal">true</span> &#125;)</span><br><span class="line">  &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">    <span class="keyword">if</span> (process.env.NODE_ENV !== <span class="string">'production'</span>) &#123;</span><br><span class="line">      <span class="comment">//Â FixÂ #3072Â noÂ warnÂ ifÂ `pathMatch`Â isÂ string</span></span><br><span class="line">      warn(</span><br><span class="line">        <span class="keyword">typeof</span> params.pathMatch === <span class="string">'string'</span>,</span><br><span class="line">        <span class="string">`missingÂ paramÂ forÂ <span class="subst">$&#123;routeMsg&#125;</span>:Â <span class="subst">$&#123;e.message&#125;</span>`</span></span><br><span class="line">      )</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">''</span></span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    <span class="comment">//Â deleteÂ theÂ 0Â ifÂ itÂ wasÂ added</span></span><br><span class="line">    <span class="keyword">delete</span> params[<span class="number">0</span>]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>å¯ä»¥çœ‹åˆ°æ•´ä¸ªé€†è§£æé€»è¾‘æ˜¯å€ŸåŠ©<code>Regexp.compile</code>ç»“åˆ<code>regexpCompileCache</code>å®ç°çš„</li>
<li><code>Regexp.compile</code>æ¥æ”¶ä¸€ä¸ª<code>åŠ¨æ€è·¯ç”±path</code>ï¼Œè¿”å›ä¸€ä¸ªå‡½æ•°ï¼Œå¯ç”¨è¿™ä¸ªå‡½æ•°åšé€†è§£æï¼›</li>
<li><code>Regexp.compile</code>ä¾‹å­å¦‚ä¸‹</li>
</ul>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// https://www.npmjs.com/package/path-to-regexp#compile-reverse-path-to-regexp</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> toPath = compile(<span class="string">'/user/:id'</span>)</span><br><span class="line">toPath(&#123; id: <span class="number">123</span> &#125;) <span class="comment">//=&gt;Â "/user/123"</span></span><br></pre></td></tr></table></figure>
<ul>
<li>å¯ä»¥çœ‹åˆ°é¦–å…ˆå¯¹<code>Regexp.compile</code>è¿”å›çš„å‡½æ•°åšäº†ç¼“å­˜</li>
<li>ç„¶åå°†<code>matchRoute</code>ä¸­æ·»åŠ çš„<code>pathMatch</code>èµ‹å€¼ç»™<code>params[0]</code></li>
<li>è°ƒç”¨<code>Regexp.compile</code>è¿”å›å‡½æ•°ï¼Œä»¥<code>params</code>ä¸ºå…¥å‚ï¼Œé€†è§£æ<code>url</code>å¹¶è¿”å›</li>
<li>åˆ é™¤æ·»åŠ çš„<code>params[0]</code></li>
<li>fill-params.png<ul>
<li><img src="/2020/12/01/vue-router-analysis-part2/fill-params.png" alt="fill-params.png"></li>
</ul>
</li>
</ul>
<h3 id="åˆ›å»ºè·¯ç”±å¯¹è±¡-createRoute"><a href="#åˆ›å»ºè·¯ç”±å¯¹è±¡-createRoute" class="headerlink" title="åˆ›å»ºè·¯ç”±å¯¹è±¡_createRoute"></a>åˆ›å»ºè·¯ç”±å¯¹è±¡_createRoute</h3><ul>
<li>ä¸Šé¢æ— è®ºæ˜¯<code>normalizeLocation</code>ã€<code>matchRoute</code>ã€<code>fillParams</code>éƒ½æ˜¯é’ˆå¯¹ä¼ å…¥çš„<code>åœ°å€</code>åšä¸€äº›æ“ä½œï¼›</li>
<li>è€Œ<code>match</code>æ–¹æ³•çš„ä½œç”¨æ˜¯æ‰¾åˆ°ä¸åœ°å€åŒ¹é…çš„è·¯ç”±å¯¹è±¡ï¼Œè€Œè¿™ä¸ªä¸»è¦æ˜¯ç”±<code>_createRoute</code>æ–¹æ³•å®ç°</li>
<li>ä»å‘½åä¸Šå¯ä»¥çœ‹å‡ºï¼Œè¿™æ˜¯ä¸ªå†…éƒ¨æ–¹æ³•</li>
</ul>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//src/create-matcher.js createMatcheræ–¹æ³•å†…</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">_createRoute</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  record: ?RouteRecord,</span></span></span><br><span class="line"><span class="function"><span class="params">  location: Location,</span></span></span><br><span class="line"><span class="function"><span class="params">  redirectedFrom?: Location</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">Route</span> </span>&#123;</span><br><span class="line">  <span class="comment">//Â è·¯ç”±è®°å½•è¢«æ ‡è®°ä¸ºé‡å®šå‘</span></span><br><span class="line">  <span class="keyword">if</span> (record &amp;&amp; record.redirect) &#123;</span><br><span class="line">    <span class="keyword">return</span> redirect(record, redirectedFrom || location)</span><br><span class="line">  &#125; <span class="comment">//Â è·¯ç”±è®°å½•è¢«æ ‡è®°ä¸ºåˆ«åè·¯ç”±ï¼Œè§create-route-map.js</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (record &amp;&amp; record.matchAs) &#123;</span><br><span class="line">    <span class="keyword">return</span> alias(record, location, record.matchAs)</span><br><span class="line">  &#125; <span class="comment">//Â æ­£å¸¸è·¯ç”±è®°å½•</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> createRoute(record, location, redirectedFrom, router)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>å¯ä»¥çœ‹åˆ°å®ƒæ¥æ”¶ä¸‰ä¸ªå‚æ•°<ul>
<li><code>record</code>ç”¨æ¥ç”Ÿæˆ<code>Routeå¯¹è±¡</code>çš„ç›®æ ‡è·¯ç”±è®°å½•</li>
<li><code>location</code>ç›®æ ‡åœ°å€</li>
<li><code>redirectedFrom</code>é‡å®šå‘çš„æ¥æºåœ°å€ï¼Œè¿™ä¸ªå‚æ•°åªåœ¨å‘ç”Ÿé‡å®šå‘æ—¶æ‰ä¼šæœ‰å€¼</li>
</ul>
</li>
<li>æˆ‘ä»¬çŸ¥é“ï¼Œåœ¨æ–°å¢è·¯ç”±è®°å½•æ—¶ï¼Œä¼šå¯¹ä¸åŒç±»å‹çš„è®°å½•æ·»åŠ ä¸Šä¸åŒçš„æ ‡è®°å­—æ®µ<ul>
<li>å¦‚ä¸ºé‡å®šå‘è·¯æœ‰è®°å½•æ·»åŠ <code>redirect</code>å­—æ®µ</li>
<li>ä¸ºåˆ«åè·¯ç”±æ·»åŠ <code>matchAs</code>å­—æ®µ<ul>
<li>å…·ä½“å¯çœ‹å‰é¢çš„<code>ç”Ÿæˆè·¯ç”±è®°å½•</code>ç« èŠ‚</li>
</ul>
</li>
</ul>
</li>
<li>å¯ä»¥çœ‹åˆ°é’ˆå¯¹ä¸åŒçš„è·¯ç”±è®°å½•ç±»å‹è°ƒç”¨äº†ä¸åŒæ–¹æ³•<ul>
<li>é‡å®šå‘è·¯ç”±è°ƒç”¨<code>redirect</code>æ–¹æ³•</li>
<li>åˆ«åè·¯ç”±è°ƒç”¨<code>alias</code>æ–¹æ³•</li>
<li>å…¶ä½™çš„è°ƒç”¨<code>createRoute</code>æ–¹æ³•</li>
</ul>
</li>
<li>æ´»åŠ¨å›¾å¦‚ä¸‹</li>
<li>create-route-inner.png<ul>
<li><img src="/2020/12/01/vue-router-analysis-part2/create-route-inner.png" alt="create-route-inner.png"></li>
</ul>
</li>
<li>å…¶å®<code>redirect</code>ã€<code>alias</code>æ–¹æ³•å†…éƒ¨ä¹Ÿè°ƒç”¨äº†<code>createRoute</code>æ–¹æ³•</li>
<li>æ‰€ä»¥æˆ‘ä»¬å…ˆçœ‹<code>createRoute</code>æ–¹æ³•å®ç°</li>
</ul>
<h4 id="createRoute"><a href="#createRoute" class="headerlink" title="createRoute"></a>createRoute</h4><ul>
<li><code>createRoute</code>ä½äº<code>src/util/route.js</code></li>
</ul>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/util/route.js</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//Â ç”ŸæˆRoute</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">createRoute</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  record: ?RouteRecord,</span></span></span><br><span class="line"><span class="function"><span class="params">  location: Location,</span></span></span><br><span class="line"><span class="function"><span class="params">  redirectedFrom?: ?Location,</span></span></span><br><span class="line"><span class="function"><span class="params">  router?: VueRouter</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">Route</span> </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> stringifyQuery = router &amp;&amp; router.options.stringifyQuery <span class="comment">//Â æ”¯æŒä¼ å…¥è‡ªå®šä¹‰åºåˆ—åŒ–qsæ–¹æ³•</span></span><br><span class="line">  <span class="keyword">let</span> query: <span class="built_in">any</span> = location.query || &#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    query = clone(query) <span class="comment">//Â location.queryä¸ºå¼•ç”¨å€¼ï¼Œé¿å…ç›¸äº’å½±å“ï¼Œè¿›è¡Œæ·±æ‹·è´</span></span><br><span class="line">  &#125; <span class="keyword">catch</span> (e) &#123;&#125; <span class="comment">//Â ç”ŸæˆRoute</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> route: Route = &#123;</span><br><span class="line">    name: location.name || (record &amp;&amp; record.name),</span><br><span class="line">    meta: (record &amp;&amp; record.meta) || &#123;&#125;,</span><br><span class="line">    path: location.path || <span class="string">'/'</span>,</span><br><span class="line">    hash: location.hash || <span class="string">''</span>,</span><br><span class="line">    query,</span><br><span class="line">    params: location.params || &#123;&#125;,</span><br><span class="line">    fullPath: getFullPath(location, stringifyQuery), <span class="comment">//Â å®Œæ•´path</span></span><br><span class="line">    matched: record ? formatMatch(record) : [], <span class="comment">//Â è·å–æ‰€æœ‰åŒ¹é…çš„è·¯ç”±è®°å½•</span></span><br><span class="line">  &#125; <span class="comment">//Â å¦‚æœæ˜¯ä»å…¶å®ƒè·¯ç”±å¯¹é‡å®šå‘è¿‡æ¥çš„ï¼Œåˆ™éœ€è¦è®°å½•é‡å®šå‘ä¹‹å‰çš„åœ°å€</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (redirectedFrom) &#123;</span><br><span class="line">    route.redirectedFrom = getFullPath(redirectedFrom, stringifyQuery)</span><br><span class="line">  &#125; <span class="comment">//Â é˜²æ­¢ç¯¡æ”¹</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">Object</span>.freeze(route)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>ç”±äº<code>VueRouter</code>æ”¯æŒä¼ å…¥è‡ªå®šä¹‰<code>åºåˆ—åŒ–queryString</code>æ–¹æ³•ï¼Œæ‰€ä»¥ç¬¬ä¸€æ­¥å…ˆè·å–åºåˆ—åŒ–<code>queryString</code>çš„æ–¹æ³•</li>
<li>ç„¶åå¯¹<code>query</code>åšäº†ä¸€ä¸ªæ·±æ‹·è´ï¼Œé¿å…ç›¸äº’å½±å“</li>
<li>æ¥ä¸‹æ¥å°±æ˜¯ç”Ÿæˆæ–°<code>Route</code> å¯¹è±¡</li>
<li>å¦‚æœæ˜¯ä»å…¶ä»–è·¯ç”±é‡å®šå‘è¿‡æ¥çš„ï¼Œåˆ™ç”Ÿæˆå®Œæ•´çš„é‡å®šå‘æ¥æºåœ°å€ï¼Œå¹¶èµ‹å€¼ç»™æ–°ç”Ÿæˆçš„<code>Route</code>å¯¹è±¡</li>
<li>æœ€åè°ƒç”¨<code>Object.freeze</code>å†»ç»“æ–°<code>Route</code> å¯¹è±¡ï¼Œå› ä¸º<code>Route</code>å¯¹è±¡æ˜¯<code>immutable</code>çš„</li>
<li>æ•´ä¸ªæµç¨‹å¦‚ä¸‹</li>
<li>create-route.png<ul>
<li><img src="/2020/12/01/vue-router-analysis-part2/create-route.png" alt="create-route.png"></li>
</ul>
</li>
<li>å¯ä»¥çœ‹åˆ°ç”Ÿæˆ<code>Route</code>æ—¶ï¼Œä¼šè°ƒç”¨<code>getFullPath</code>ç”Ÿæˆå®Œæ•´<code>fullPath</code></li>
</ul>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/util/route.js</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//Â è·å–å®Œæ•´path</span></span><br><span class="line">function getFullPath(&#123; path, query = &#123;&#125;, hash = '' &#125;, _stringifyQuery): string &#123;</span><br><span class="line">  <span class="keyword">const</span> stringify = _stringifyQuery || stringifyQuery</span><br><span class="line">  <span class="keyword">return</span> (path || <span class="string">'/'</span>) + stringify(query) + hash</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>å¯ä»¥çœ‹åˆ°<code>getFullPath</code>æ˜¯åœ¨<code>path</code>åé¢è¿½åŠ äº†<code>qs</code>å’Œ<code>hash</code></li>
<li>å¦å¤–ç”Ÿæˆ<code>Route</code>æ—¶ï¼Œè¿˜ä¼šè°ƒç”¨<code>formatMatch</code>æ¥è·å–<strong>æ‰€æœ‰</strong>å…³è”çš„<code>è·¯ç”±è®°å½•</code></li>
<li>ä¸»è¦é€šè¿‡å‘ä¸ŠæŸ¥æ‰¾çš„å½¢å¼æ‰¾åˆ°æ‰€æœ‰å…³è”çš„è·¯ç”±è®°å½•</li>
</ul>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/util/route.js</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//Â æ ¼å¼åŒ–åŒ¹é…çš„è·¯ç”±è®°å½•ï¼Œå½“ä¸€ä¸ªè·¯ç”±è®°å½•åŒ¹é…äº†ï¼Œå¦‚æœå…¶è¿˜æœ‰çˆ¶è·¯ç”±è®°å½•ï¼Œåˆ™çˆ¶è·¯ç”±è®°å½•è‚¯å®šä¹Ÿæ˜¯åŒ¹é…çš„</span></span><br><span class="line"><span class="comment">//Â /foo/barÂ åŒ¹é…äº†ï¼Œåˆ™å…¶çˆ¶è·¯ç”±å¯¹è±¡Â /fooÂ è‚¯å®šä¹ŸåŒ¹é…äº†</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">formatMatch</span>(<span class="params">record: ?RouteRecord</span>): <span class="title">Array</span>&lt;<span class="title">RouteRecord</span>&gt; </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> res = []</span><br><span class="line">  <span class="keyword">while</span> (record) &#123;</span><br><span class="line">    res.unshift(record) <span class="comment">//Â é˜Ÿåˆ—å¤´æ·»åŠ ï¼Œæ‰€ä»¥çˆ¶recordæ°¸è¿œåœ¨å‰é¢ï¼Œå½“å‰recordæ°¸è¿œåœ¨æœ€åï¼›åœ¨router-viewç»„ä»¶ä¸­è·å–åŒ¹é…çš„routeÂ recordæ—¶ä¼šç”¨åˆ°</span></span><br><span class="line">    record = record.parent</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> res</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>éš¾é“ä¸€æ¡<code>Route</code>ä¸æ˜¯å¯¹åº”(å…³è”)ä¸€ä¸ª<code>è·¯ç”±å¯¹è±¡</code>å—ï¼Ÿ</li>
<li>å…¶å®åœ¨æœ¯è¯­è¡¨ä»‹ç»<code>Routeè·¯ç”±å¯¹è±¡</code>æ—¶ï¼Œä¹Ÿæœ‰æ‰€æåŠï¼Œä¸€ä¸ª<code>Routeè·¯ç”±å¯¹è±¡</code>å¯èƒ½ä¼šå…³è”å¤šä¸ª<code>RouteRecordè·¯ç”±è®°å½•å¯¹è±¡</code></li>
<li>è¿™æ˜¯å› ä¸ºå­˜åœ¨åµŒå¥—è·¯ç”±çš„æƒ…å†µï¼Œå½“å­è·¯ç”±è®°å½•è¢«åŒ¹é…åˆ°æ—¶ï¼Œå…¶å®ä»£è¡¨ç€çˆ¶è·¯ç”±è®°å½•ä¹Ÿä¸€å®šè¢«åŒ¹é…åˆ°äº†ï¼Œçœ‹ä¸‹é¢ä¾‹å­</li>
</ul>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å½“æœ‰ä¸‹é¢çš„è·¯ç”±è§„åˆ™</span></span><br><span class="line">routes: [</span><br><span class="line">  &#123;</span><br><span class="line">    path: <span class="string">'/parent'</span>,</span><br><span class="line">    component: Parent,</span><br><span class="line">    children: [&#123; path: <span class="string">'foo'</span>, component: Foo &#125;],</span><br><span class="line">  &#125;,</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<ul>
<li>è®¿é—®<code>/parent/foo</code>æ—¶ï¼ŒåŒ¹é…åˆ°çš„è·¯ç”±è®°å½•æœ‰ä¸¤ä¸ª</li>
<li>match-demo-record.png<ul>
<li><img src="/2020/12/01/vue-router-analysis-part2/match-demo-record.png" alt="match-demo-record.png"></li>
</ul>
</li>
<li>è€Œä¸”ç²¾å‡†åŒ¹é…åˆ°è·¯ç”±è®°å½•ä¸€å®šæ˜¯æœ€åä¸€ä¸ªï¼Œæ‰€ä»¥åé¢ä¼šçœ‹åˆ°ç”¨<code>route.matched[route.matched.length - 1]</code>æ¥è·å–å½“å‰<code>route</code>å¯¹åº”çš„ç²¾å‡†åŒ¹é…çš„<code>RouteRecord</code></li>
<li>çœ‹å®Œ<code>createRoute</code>çš„å®ç°ï¼Œæˆ‘ä»¬å†æ¥çœ‹çœ‹<code>alias</code>çš„å®ç°</li>
</ul>
<h4 id="åˆ›å»ºåˆ«åè·¯ç”±å¯¹è±¡-alias"><a href="#åˆ›å»ºåˆ«åè·¯ç”±å¯¹è±¡-alias" class="headerlink" title="åˆ›å»ºåˆ«åè·¯ç”±å¯¹è±¡ alias"></a>åˆ›å»ºåˆ«åè·¯ç”±å¯¹è±¡ alias</h4><ul>
<li><code>alias</code>ä½äº<code>src/create-matcher.js</code></li>
</ul>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/create-matcher.js</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//Â åˆ›å»ºåˆ«åRoute</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">alias</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  record: RouteRecord,</span></span></span><br><span class="line"><span class="function"><span class="params">  location: Location,</span></span></span><br><span class="line"><span class="function"><span class="params">  matchAs: <span class="built_in">string</span></span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">Route</span> </span>&#123;</span><br><span class="line">  <span class="comment">//Â è·å–åˆ«åçš„å®Œæ•´è·¯å¾„</span></span><br><span class="line">  <span class="keyword">const</span> aliasedPath = fillParams(</span><br><span class="line">    matchAs,</span><br><span class="line">    location.params,</span><br><span class="line">    <span class="string">`aliasedÂ routeÂ withÂ pathÂ "<span class="subst">$&#123;matchAs&#125;</span>"`</span></span><br><span class="line">  ) <span class="comment">//Â è·å–åˆ«ååŒ¹é…çš„åŸå§‹Route</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> aliasedMatch = match(&#123;</span><br><span class="line">    _normalized: <span class="literal">true</span>,</span><br><span class="line">    path: aliasedPath,</span><br><span class="line">  &#125;)</span><br><span class="line">  <span class="keyword">if</span> (aliasedMatch) &#123;</span><br><span class="line">    <span class="keyword">const</span> matched = aliasedMatch.matched</span><br><span class="line">    <span class="keyword">const</span> aliasedRecord = matched[matched.length - <span class="number">1</span>] <span class="comment">//Â æ‰¾åˆ°æ‰€æœ‰åŒ¹é…çš„è·¯ç”±è®°å½•çš„æœ€åä¸€ä¸ªï¼Œå³å½“å‰åŒ¹é…çš„è·¯ç”±è®°å½•ï¼Œé€»è¾‘è§route.jsÂ formatMatchæ–¹æ³•</span></span><br><span class="line">    location.params = aliasedMatch.params</span><br><span class="line">    <span class="keyword">return</span> _createRoute(aliasedRecord, location)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> _createRoute(<span class="literal">null</span>, location)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>é€»è¾‘å¦‚ä¸‹</li>
<li>å…ˆæ‹¿<code>matchAs</code>å¾—åˆ°<code>aliasedPath</code>ï¼Œ</li>
<li>ç„¶åæ‹¿<code>aliasedPath</code>èµ°ä¸€é<code>match</code>å¾—åˆ°<code>aliasedMatch</code>è·¯ç”±å¯¹è±¡</li>
<li><code>aliasedMatch</code>å¦‚æœå­˜åœ¨ï¼Œæ‹¿<code>aliasedMatch</code>ç²¾å‡†åŒ¹é…çš„<code>è·¯ç”±è®°å½•å¯¹è±¡</code>å’Œ<code>location</code>ï¼Œç”Ÿæˆ<code>è·¯ç”±å¯¹è±¡</code>è¿”å›</li>
<li>ä¸å­˜åœ¨ï¼Œåˆ™åˆ›å»ºä¸€ä¸ªæ–°çš„<code>è·¯ç”±å¯¹è±¡</code>è¿”å›</li>
<li>å¯èƒ½æœ‰ç‚¹ç»•ï¼Œæˆ‘ä»¬ä¸¾ä¸ªä¾‹å­<ul>
<li>å‰é¢æˆ‘ä»¬çŸ¥é“ï¼Œ<code>/a</code>è®¾ç½®äº†åˆ«å<code>/b</code>æ—¶ï¼Œä¼šç”Ÿæˆä¸¤æ¡è·¯ç”±è®°å½•ï¼Œä¸”<code>/b</code>çš„è·¯ç”±è®°å½•ä¸Šçš„<code>matchAs</code>ä¸º<code>/a</code><ul>
<li>å¿˜è®°çš„å¯ä»¥çœ‹å‰é¢çš„<code>ç”Ÿæˆåˆ«åè·¯ç”±è®°å½•</code>ç« èŠ‚</li>
</ul>
</li>
<li>æ­¤å¤„ä¼ å…¥çš„<code>alias</code>çš„<code>matchAs</code>å°±ç›¸å½“äº<code>/a</code>ï¼Œå…ˆæ‹¿<code>matchAs</code>å³<code>/a</code>å¾—åˆ°å¡«å……è¿‡<code>params</code>çš„è·¯å¾„</li>
<li>å†ä»¥æ­¤è·¯å¾„è°ƒç”¨<code>match</code>æ‰¾åˆ°åŒ¹é…çš„<code>è·¯ç”±å¯¹è±¡</code>ï¼Œè®°ä¸º<code>routeA</code></li>
<li>å‰é¢ä¹Ÿæè¿‡ï¼Œè·¯ç”±å¯¹è±¡ä¼šå…³è”è·¯ç”±è®°å½•ï¼Œæ‰€ä»¥ä»<code>routeA</code>ä¸­å¯ä»¥å¾—åˆ°ç²¾å‡†åŒ¹é…çš„è·¯ç”±è®°å½•<code>routeRecordA</code></li>
<li>æ‹¿æ­¤è·¯ç”±è®°å½•å’Œ<code>/b</code>çš„<code>location</code>å»ç”Ÿæˆè·¯ç”±å¯¹è±¡å¹¶è¿”å›</li>
<li>è¿™æ ·å°±å®ç°äº†å®˜ç½‘ä¸Šè¯´çš„<code>/a çš„åˆ«åæ˜¯ /bï¼Œæ„å‘³ç€ï¼Œå½“ç”¨æˆ·è®¿é—® /b æ—¶ï¼ŒURL ä¼šä¿æŒä¸º /bï¼Œä½†æ˜¯è·¯ç”±åŒ¹é…åˆ™ä¸º /aï¼Œå°±åƒç”¨æˆ·è®¿é—® /a ä¸€æ ·ã€‚</code>æ•ˆæœ</li>
</ul>
</li>
<li>æ´»åŠ¨å›¾å¦‚ä¸‹</li>
<li>alias.png<ul>
<li><img src="/2020/12/01/vue-router-analysis-part2/alias.png" alt="alias.png"></li>
</ul>
</li>
<li>æˆ‘ä»¬å†æ¥çœ‹çœ‹<code>redirect</code>çš„å®ç°</li>
</ul>
<h4 id="åˆ›å»ºé‡å®šå‘è·¯ç”±å¯¹è±¡-redirect"><a href="#åˆ›å»ºé‡å®šå‘è·¯ç”±å¯¹è±¡-redirect" class="headerlink" title="åˆ›å»ºé‡å®šå‘è·¯ç”±å¯¹è±¡ redirect"></a>åˆ›å»ºé‡å®šå‘è·¯ç”±å¯¹è±¡ redirect</h4><ul>
<li>æˆ‘ä»¬å…ˆçœ‹ä¸‹<code>record.redirect</code>å¯èƒ½çš„å‡ ç§æƒ…å†µï¼›<code>https://router.vuejs.org/zh/guide/essentials/redirect-and-alias.html#é‡å®šå‘</code><ul>
<li>å­—ç¬¦ä¸²<code>{redirect:&#39;/&#39;}</code></li>
<li>å¯¹è±¡<code>{redirect:{path:&#39;/test&#39;}}</code>ã€<code>{redirect:{name:&#39;Test&#39;}}</code></li>
<li>ä¹Ÿæ”¯æŒä¼ å…¥å‡½æ•°<code>{redirect:to=&gt;{ return {name:&#39;Test&#39;}}}</code></li>
</ul>
</li>
<li>æˆ‘ä»¬å…ˆçœ‹è¿™ä¸ª<code>redirect</code>æ–¹æ³•çš„å…¥å£</li>
</ul>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/create-matcher.js _createRouteæ–¹æ³•å†…éƒ¨</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (record &amp;&amp; record.redirect) &#123;</span><br><span class="line">  <span class="keyword">return</span> redirect(record, redirectedFrom || location)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>ç”±äºå­˜åœ¨å¤šæ¬¡é‡å®šå‘çš„åœºæ™¯ï¼Œæ‰€ä»¥éœ€è¦ä¿ç•™é¦–æ¬¡è§¦å‘é‡å®šå‘çš„åœ°å€å³<code>redirectedFrom</code><ul>
<li><code>/a</code> -&gt; <code>/b</code> -&gt; <code>/c</code>ï¼Œåœ¨<code>/c</code>ä¸­éœ€è¦ä¿ç•™é¦–æ¬¡è§¦å‘é‡å®šå‘çš„åœ°å€å³<code>/a</code></li>
</ul>
</li>
<li>å¤šæ¬¡é‡å®šå‘ï¼Œå¦‚ä½•ä¿ç•™é¦–æ¬¡è§¦å‘é‡å®šå‘çš„åœ°å€å‘¢ï¼Ÿ<ul>
<li>åœ¨ç¬¬ä¸€æ¬¡é‡å®šå‘æ—¶ï¼Œ<code>redirectedFrom</code>æ²¡æœ‰å€¼</li>
<li>åœ¨<code>redirect</code>æ–¹æ³•å†…éƒ¨ä¼šå°†<code>location</code>åšä¸º<code>redirectedFrom</code>å‚æ•°è°ƒç”¨<code>match</code>æ–¹æ³•ï¼Œ<code>match</code>å¦‚æœå‘ç°ä»ç„¶éœ€è¦é‡å®šå‘ï¼Œåˆ™ä¼šç»§ç»­è°ƒç”¨<code>redirect</code>ï¼Œæ­¤æ—¶<code>redirectedFrom</code>æ˜¯æœ‰å€¼çš„ï¼Œå°±æ˜¯é¦–æ¬¡ä¼ å…¥çš„<code>location</code>ï¼Œä¾æ¬¡å¾ªç¯ï¼Œè¿™æ ·å°±å®Œæˆäº†åˆå§‹åœ°å€çš„ä¼ é€’</li>
</ul>
</li>
<li>å¯ä»¥çœ‹ä¸‹ä¸‹é¢çš„ä¾‹å­</li>
</ul>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">;[</span><br><span class="line">  &#123; path: <span class="string">'/foo'</span>, component: Foo &#125;,</span><br><span class="line">  &#123; path: <span class="string">'/baz'</span>, component: Baz, redirect: <span class="string">'/foo'</span> &#125;, <span class="comment">//Â namedÂ redirect</span></span><br><span class="line">  &#123; path: <span class="string">'/named-redirect'</span>, redirect: <span class="string">'/baz'</span> &#125;,</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="comment">// src/create-matcher.js _createRouteæ–¹æ³•å†…éƒ¨</span></span><br><span class="line"><span class="keyword">if</span> (record &amp;&amp; record.redirect) &#123;</span><br><span class="line">  <span class="built_in">console</span>.count(<span class="string">'redirectÂ count:'</span>) <span class="comment">// ç»Ÿè®¡è°ƒç”¨æ¬¡æ•°</span></span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'record:'</span>, record, <span class="string">'redirectedFrom:'</span>, redirectedFrom) <span class="comment">// æ‰“å°é‡å®šå‘åˆå§‹æ¥æºåœ°å€</span></span><br><span class="line">  <span class="keyword">return</span> redirect(record, redirectedFrom || location)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>å½“æˆ‘ä»¬è®¿é—®<code>/named-redirect</code>è·¯ç”±æ—¶(è§¦å‘è·¯ç”±è·³è½¬)ï¼Œä¼šé‡å®šå‘åˆ°<code>/baz</code>ï¼Œ<code>/baz</code>åˆä¼šé‡å®šå‘åˆ°<code>/foo</code>ï¼Œæœ€ç»ˆå±•ç¤º<code>Foo</code>ç»„ä»¶ï¼›æ‰€ä»¥ï¼Œ<code>redirect</code>æ–¹æ³•åº”è¯¥ä¼šè¢«è°ƒç”¨ä¸¤æ¬¡ï¼›</li>
<li>æˆ‘ä»¬å¯ä»¥çœ‹ä¸‹ä¸Šé¢ä¾‹å­çš„è¾“å‡º</li>
<li>redirect-demo.png<ul>
<li><img src="/2020/12/01/vue-router-analysis-part2/redirect-demo.png" alt="redirect-demo.png"></li>
</ul>
</li>
<li>ä¼šå‘ç°<code>redirect</code>æ–¹æ³•è¢«è°ƒç”¨äº†å››æ¬¡ï¼Œå‰ä¸¤æ¬¡æ˜¯è·¯ç”±è·³è½¬å¯¼è‡´çš„<code>redirect</code>è°ƒç”¨ï¼Œåä¸¤æ¬¡åˆ™æ˜¯ç»„ä»¶æ¸²æŸ“æ—¶ï¼Œéœ€è¦è§£æè·¯ç”±ä»è€Œè§¦å‘çš„<code>redirect</code>è°ƒç”¨ï¼›</li>
<li>å¯ä»¥å¯¹æ¯”ä¸‹è°ƒç”¨æ ˆ<ul>
<li>redirect-stack-1.png<ul>
<li><img src="/2020/12/01/vue-router-analysis-part2/redirect-stack-1.png" alt="redirect-stack-1.png"></li>
</ul>
</li>
<li>redirect-stack-2.png<ul>
<li><img src="/2020/12/01/vue-router-analysis-part2/redirect-stack-2.png" alt="redirect-stack-2.png"></li>
</ul>
</li>
<li>å¯ä»¥çœ‹åˆ°ç¬¬ä¸€ã€ç¬¬äºŒæ¬¡çš„<code>redirect</code>æ˜¯ç”±<code>transitionTo</code>è§¦å‘çš„</li>
<li>redirect-stack-3.png<ul>
<li><img src="/2020/12/01/vue-router-analysis-part2/redirect-stack-3.png" alt="redirect-stack-3.png"></li>
</ul>
</li>
<li>redirect-stack-4.png<ul>
<li><img src="/2020/12/01/vue-router-analysis-part2/redirect-stack-4.png" alt="redirect-stack-4.png"></li>
</ul>
</li>
<li>è€Œç¬¬ä¸‰ã€ç¬¬å››æ¬¡éƒ½æ˜¯ç»„ä»¶æ¸²æŸ“<code>render</code>è°ƒç”¨<code>resolve</code>è§¦å‘çš„<ul>
<li>ä¸ºä½•ç»„ä»¶æ¸²æŸ“æ—¶éœ€è¦è§£æè·¯ç”±ï¼Œè¿™ä¸ªæˆ‘ä»¬åœ¨åé¢ç»„ä»¶ç›¸å…³ç« èŠ‚è§£é‡Š</li>
</ul>
</li>
</ul>
</li>
<li>å¯ä»¥çœ‹åˆ°ç¬¬ä¸€æ¬¡è°ƒç”¨<code>redirect</code>æ˜¯ä»<code>/named-redirect</code>é‡å®šå‘åˆ°<code>/baz</code>ï¼Œæ­¤æ—¶<code>redirectFrom</code>æ˜¯æ²¡æœ‰å€¼çš„</li>
<li>è€Œç¬¬äºŒæ¬¡è°ƒç”¨æ˜¯ä»<code>/baz</code>é‡å®šå‘åˆ°<code>/foo</code>ï¼Œæ­¤æ—¶<code>redirectFrom</code>å°±æ˜¯è§¦å‘ç¬¬ä¸€æ¬¡é‡å®šå‘çš„åœ°å€<code>/named-redirect</code></li>
<li>è€Œä¸”æœ€ç»ˆçš„<code>$route</code>ä¸Šä¹Ÿä¼šæœ‰ä¸ª<code>redirectFrom</code>ä¿ç•™äº†è§¦å‘ç¬¬ä¸€æ¬¡é‡å®šå‘çš„åœ°å€</li>
<li>ä¸Šé¢æˆ‘ä»¬åªæ˜¯çœ‹äº†<code>redirectFrom</code>çš„æ„ä¹‰ï¼Œä¸‹é¢æˆ‘ä»¬çœ‹çœ‹<code>redirect</code>çš„å…·ä½“å®ç°</li>
</ul>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/create-matcher.js createMatcheræ–¹æ³•å†…</span></span><br><span class="line"><span class="comment">//Â åˆ›å»ºé‡å®šå‘Route</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">redirect</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  record: RouteRecord, <span class="comment">//Â è§¦å‘é‡å®šå‘çš„è·¯ç”±è®°å½•(éœ€è¦è¿›è¡Œé‡å®šå‘çš„è·¯ç”±è®°å½•ï¼ŒåŒ…å«redirect)</span></span></span></span><br><span class="line"><span class="function"><span class="params">  location: Location <span class="comment">//Â è§¦å‘é‡å®šå‘çš„åˆå§‹åœ°å€()</span></span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">Route</span> </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> originalRedirect = record.redirect</span><br><span class="line">  <span class="keyword">let</span> redirect =</span><br><span class="line">    <span class="keyword">typeof</span> originalRedirect === <span class="string">'function'</span> <span class="comment">//Â redirectæ”¯æŒä¼ å…¥å‡½æ•°;https://router.vuejs.org/zh/guide/essentials/redirect-and-alias.html#é‡å®šå‘</span></span><br><span class="line">      ? originalRedirect(createRoute(record, location, <span class="literal">null</span>, router))</span><br><span class="line">      : originalRedirect <span class="comment">//Â redirectè¿”å›çš„æ˜¯ä¸€ä¸ªè·¯å¾„pathï¼Œå¦‚'/bar'</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> redirect === <span class="string">'string'</span>) &#123;</span><br><span class="line">    redirect = &#123; path: redirect &#125;</span><br><span class="line">  &#125; <span class="comment">//Â originalRedirectå‡½æ•°è¿”å›ä¸€ä¸ªéstringã€éobjectçš„å€¼æ—¶ï¼Œç»™äºˆè­¦å‘Šï¼Œå¹¶åˆ›å»ºä¸€ä¸ªç©ºRoute</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!redirect || <span class="keyword">typeof</span> redirect !== <span class="string">'object'</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (process.env.NODE_ENV !== <span class="string">'production'</span>) &#123;</span><br><span class="line">      warn(<span class="literal">false</span>, <span class="string">`invalidÂ redirectÂ option:Â <span class="subst">$&#123;JSON.stringify(redirect)&#125;</span>`</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> _createRoute(<span class="literal">null</span>, location)</span><br><span class="line">  &#125; <span class="comment">//Â åˆ°è¿™ä¸€æ­¥ï¼Œredirectä¸€å®šæ˜¯ä¸ªobject</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> re: <span class="built_in">Object</span> = redirect</span><br><span class="line">  <span class="keyword">const</span> &#123; name, path &#125; = re</span><br><span class="line">  <span class="keyword">let</span> &#123; query, hash, params &#125; = location</span><br><span class="line"></span><br><span class="line">  query = re.hasOwnProperty(<span class="string">'query'</span>) ? re.query : query</span><br><span class="line">  hash = re.hasOwnProperty(<span class="string">'hash'</span>) ? re.hash : hash</span><br><span class="line">  params = re.hasOwnProperty(<span class="string">'params'</span>) ? re.params : params <span class="comment">//Â é‡å®šå‘æ˜¯å‘½åè·¯ç”±å½¢å¼</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (name) &#123;</span><br><span class="line">    <span class="comment">//Â resolvedÂ namedÂ direct</span></span><br><span class="line">    <span class="keyword">const</span> targetRecord = nameMap[name] <span class="comment">//Â æœªæ‰¾åˆ°å‘½åè·¯ç”±è­¦å‘Š</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (process.env.NODE_ENV !== <span class="string">'production'</span>) &#123;</span><br><span class="line">      assert(targetRecord, <span class="string">`redirectÂ failed:Â namedÂ routeÂ "<span class="subst">$&#123;name&#125;</span>"Â notÂ found.`</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> match(</span><br><span class="line">      &#123;</span><br><span class="line">        _normalized: <span class="literal">true</span>,</span><br><span class="line">        name,</span><br><span class="line">        query,</span><br><span class="line">        hash,</span><br><span class="line">        params,</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="literal">undefined</span>,</span><br><span class="line">      location</span><br><span class="line">    )</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (path) &#123;</span><br><span class="line">    <span class="comment">//Â é‡å®šå‘æ˜¯pathå½¢å¼</span></span><br><span class="line">    <span class="comment">//Â 1.Â resolveÂ relativeÂ redirectï¼Œè§£æå‡ºå®Œæ•´è·¯å¾„</span></span><br><span class="line">    <span class="keyword">const</span> rawPath = resolveRecordPath(path, record) <span class="comment">//Â 2.Â resolveÂ paramsï¼Œå¡«å……params</span></span><br><span class="line">    <span class="keyword">const</span> resolvedPath = fillParams(</span><br><span class="line">      rawPath,</span><br><span class="line">      params,</span><br><span class="line">      <span class="string">`redirectÂ routeÂ withÂ pathÂ "<span class="subst">$&#123;rawPath&#125;</span>"`</span></span><br><span class="line">    ) <span class="comment">//Â 3.Â rematchÂ withÂ existingÂ queryÂ andÂ hashï¼Œé‡æ–°åŒ¹é…</span></span><br><span class="line">    <span class="keyword">return</span> match(</span><br><span class="line">      &#123;</span><br><span class="line">        _normalized: <span class="literal">true</span>,</span><br><span class="line">        path: resolvedPath,</span><br><span class="line">        query,</span><br><span class="line">        hash,</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="literal">undefined</span>,</span><br><span class="line">      location</span><br><span class="line">    )</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (process.env.NODE_ENV !== <span class="string">'production'</span>) &#123;</span><br><span class="line">      warn(<span class="literal">false</span>, <span class="string">`invalidÂ redirectÂ option:Â <span class="subst">$&#123;JSON.stringify(redirect)&#125;</span>`</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> _createRoute(<span class="literal">null</span>, location)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>å¯ä»¥çœ‹åˆ°é¦–å…ˆå¯¹<code>record.redirect</code>è¿›è¡Œè§„èŒƒåŒ–ï¼Œç»Ÿä¸€ç”Ÿæˆä¸€ä¸ª<code>redirect</code>å¯¹è±¡(é‡å®šå‘ç›®æ ‡)<ul>
<li>ä¸ºä»€ä¹ˆè¦è¿›è¡Œè§„èŒƒåŒ–ï¼Œå‰é¢ä¹Ÿæè¿‡ï¼Œ<code>redirect</code>æ”¯æŒå­—ç¬¦ä¸²ã€å¯¹è±¡ã€å‡½æ•°ç±»å‹ï¼Œæ‰€ä»¥éœ€è¦è§„èŒƒåŒ–ï¼Œæ–¹ä¾¿åé¢ç»Ÿä¸€å¤„ç†</li>
</ul>
</li>
<li>æ¥ä¸‹æ¥ä¼šä¼˜å…ˆå–<code>redirect</code>çš„<code>query hash params</code>å€¼æ¥åš<code>match</code>ï¼Œä¸å­˜åœ¨æ—¶æ‰ä¼šå–<code>åˆå§‹åœ°å€location</code>çš„<code>query hash params</code></li>
<li>æ¥ä¸‹æ¥ä¼šåˆ¤æ–­é‡å®šå‘ç›®æ ‡æ˜¯<code>å‘½åå½¢å¼</code>è¿˜æ˜¯<code>pathå½¢å¼</code></li>
<li>å‘½åå½¢å¼<ul>
<li>å…ˆåˆ¤æ–­<code>nameMap</code>ä¸­æœ‰æ²¡æœ‰ç›®æ ‡è·¯ç”±è®°å½•ï¼Œæ²¡æœ‰åˆ™ä¸­æ–­ï¼Œå¹¶ç»™äºˆæç¤ºï¼›</li>
<li>å†é‡èµ°<code>match</code>æµç¨‹ï¼Œå¹¶å°†<code>location</code>åšä¸º<code>redirectedFrom</code>ä¼ å…¥ï¼Œè¿™æ ·å°±å®Œæˆäº†<code>redirectedFrom</code>çš„ä¼ é€’é—­ç¯</li>
<li><code>match</code>é‡Œé¢ä¼šç»§ç»­åˆ¤æ–­æ˜¯å¦æœ‰é‡å®šå‘ï¼Œè¿™æ ·å°±è¦†ç›–äº†å¤šé‡é‡å®šå‘çš„åœºæ™¯</li>
</ul>
</li>
<li>path å½¢å¼<ul>
<li>æ‹¿<code>path</code>åŒ¹é…ï¼Œéœ€è¦è·å–å®Œæ•´è·¯å¾„ï¼Œæ‰€ä»¥å…ˆä»<code>record</code>æ‹¿å‡ºåŸå§‹è·¯å¾„<code>rawPath</code>å¹¶å¡«å……å‰é¢è§£æå‡ºçš„<code>params</code>å¾—å‡ºå®Œæ•´åœ°å€</li>
<li>å†æ‹¿å®Œæ•´åœ°å€é‡èµ°<code>match</code>æµç¨‹ï¼ŒåŒæ—¶ä¹Ÿå°†<code>location</code>åšä¸º<code>redirectedFrom</code>ä¼ å…¥ï¼Œå®Œæˆ<code>redirectedFrom</code>çš„ä¼ é€’é—­ç¯</li>
<li><code>match</code>é‡Œé¢ä¼šç»§ç»­åˆ¤æ–­æ˜¯å¦æœ‰é‡å®šå‘ï¼Œè¿™æ ·å°±è¦†ç›–äº†å¤šé‡é‡å®šå‘çš„åœºæ™¯</li>
</ul>
</li>
<li>å¦‚æœæ—¢ä¸æ˜¯<code>å‘½åå½¢å¼</code>ä¹Ÿä¸æ˜¯<code>pathå½¢å¼</code>ï¼Œåˆ™ç›´æ¥åˆ›å»ºä¸€ä¸ªæ–°è·¯ç”±å¯¹è±¡è¿”å›</li>
<li>æµç¨‹å¦‚ä¸‹</li>
<li>redirect-full.png<ul>
<li><img src="/2020/12/01/vue-router-analysis-part2/redirect-full.png" alt="redirect-full.png"></li>
</ul>
</li>
</ul>
<h3 id="å°ç»“"><a href="#å°ç»“" class="headerlink" title="å°ç»“"></a>å°ç»“</h3><ul>
<li>è·¯ç”±åŒ¹é…çš„è¿‡ç¨‹ï¼Œå…¶å®å°±æ˜¯æ‹¿<code>åœ°å€RawLocation</code>ç”Ÿæˆ<code>è·¯ç”±å¯¹è±¡Route</code>çš„è¿‡ç¨‹ï¼Œè¿™ä¸­é—´<code>è·¯ç”±è®°å½•RouteRecord</code>èµ·ä¸­é—´æ¡¥æ¢çš„ä½œç”¨ï¼Œå› ä¸ºè·¯ç”±è®°å½•ä¸Šä¿å­˜äº†ç”Ÿæˆè·¯ç”±å¯¹è±¡çš„é‡è¦ä¿¡æ¯ï¼›æ‰€ä»¥æµç¨‹åº”è¯¥æ˜¯æ‹¿<code>åœ°å€</code>ä»è·¯ç”±æ˜ å°„è¡¨ä¸­æ‰¾åˆ°å¯¹åº”çš„<code>è·¯ç”±è®°å½•</code>ï¼Œç„¶åæ‹¿<code>è·¯ç”±è®°å½•</code>ç”Ÿæˆ<code>è·¯ç”±å¯¹è±¡</code></li>
<li>ä¸Šè¿°åŒ¹é…é€»è¾‘ä¸»è¦ç”±<code>match</code>å‡½æ•°å®ç°çš„ï¼Œå…³é”®é€»è¾‘åŒ…å«<code>åœ°å€æ ¼å¼åŒ–normalizeLocation</code>ã€<code>åœ°å€æ˜¯å¦åŒ¹é…åˆ¤æ–­matchRoute</code>ã€<code>å¡«å……å‚æ•°fillParams</code>ã€<code>åˆ›å»ºè·¯ç”±å¯¹è±¡_createRoute</code></li>
<li>åœ¨<code>normalizeLocation</code>æ—¶ï¼Œä¼šå¯¹<code>rawLocation</code>è¿›è¡Œè§„èŒƒåŒ–ï¼Œæ–¹ä¾¿åç»­å¤„ç†</li>
<li>åœ¨<code>matchRoute</code>æ—¶ï¼Œä¼šå€ŸåŠ©<code>path-to-regexp</code>æ£€æµ‹åœ°å€æ˜¯å¦åŒ¹é…å¹¶æå–å‡º<code>params</code></li>
<li><code>fillParams</code>å¯ä»¥çœ‹åšæ˜¯<code>æå–params</code>çš„é€†å‘æ“ä½œï¼Œä¸»è¦ç”¨æ¥å¯¹åœ°å€ä¸­çš„åŠ¨æ€éƒ¨åˆ†è¿›è¡Œå¡«å……</li>
<li>åœ¨<code>_createRoute</code>æ—¶ï¼Œä¼šåˆ†åˆ«å¤„ç†åˆ«åã€é‡å®šå‘ã€å¤šé‡é‡å®šå‘ç­‰åœºæ™¯</li>
<li>ç»è¿‡ä¸Šè¿°æµç¨‹ï¼Œå°±å¯ä»¥æ‹¿åˆ°<code>RawLocation</code>å¯¹åº”çš„<code>Route</code></li>
<li>æ‹¿åˆ°<code>Route</code>ï¼Œæˆ‘ä»¬å°±å¯ä»¥è¿›è¡Œå¯¼èˆªçš„è§£æ</li>
</ul>
<h2 id="å¯¼èˆªè§£æ-ç¡®è®¤-æµç¨‹"><a href="#å¯¼èˆªè§£æ-ç¡®è®¤-æµç¨‹" class="headerlink" title="å¯¼èˆªè§£æ(ç¡®è®¤)æµç¨‹"></a>å¯¼èˆªè§£æ(ç¡®è®¤)æµç¨‹</h2><ul>
<li>å‰é¢æè¿‡åœ¨<code>transitionTo</code>æ–¹æ³•ä¸­ï¼Œè°ƒç”¨å®Œ<code>match</code>æ–¹æ³•å¾—åˆ°ç›®æ ‡<code>Route</code>åï¼Œå°±ä¼šè°ƒç”¨<code>confirmTransition</code>æ–¹æ³•æ¥åšå¯¼èˆªè§£æ</li>
<li>æˆ‘ä»¬çŸ¥é“<code>vue-router</code>åœ¨è·¯ç”±è·³è½¬æ—¶ï¼Œä¼šæŒ‰é¡ºåºè§¦å‘å„ç§é’©å­ã€å®ˆå«å‡½æ•°ï¼Œä¾‹å¦‚<code>beforeRouteLeaveã€beforeRouteEnterç­‰ç­‰</code>ï¼›</li>
<li>é¦–å…ˆè¿™äº›é’©å­ã€å®ˆå«æœ‰çš„æ˜¯å®šä¹‰åœ¨<code>vue-router</code>å®ä¾‹ä¸Šçš„ï¼Œæœ‰çš„æ˜¯è·¯ç”±ç‹¬äº«çš„ï¼Œæœ‰çš„æ˜¯ä½äº<code>.vue</code>ç»„ä»¶ä¸­çš„ï¼Œæ‰€ä»¥ç¬¬ä¸€æ­¥å¿…é¡»æŠ½å‡ºè¿™äº›é’©å­ã€å®ˆå«å‡½æ•°ç»Ÿä¸€å¤„ç†</li>
<li>å…¶æ¬¡è¿™äº›é’©å­ã€å®ˆå«æ˜¯æŒ‰é¡ºåºä¾æ¬¡æ‰§è¡Œçš„ï¼Œæ‰€ä»¥éœ€è¦è®¾è®¡ä¸€ä¸ªé˜Ÿåˆ—å’Œè¿­ä»£å™¨æ¥ä¿è¯é¡ºåºæ‰§è¡Œ</li>
<li>æœ€åè¿˜æœ‰ä¸€äº›ç‰¹æ®Šåœºæ™¯éœ€è¦å¤„ç†ï¼Œä¾‹å¦‚å¼‚æ­¥è·¯ç”±ç»„ä»¶å¦‚ä½•ä¿è¯é¡ºåºæ‰§è¡Œ</li>
<li>ä¸Šè¿°çš„ç›¸å…³é€»è¾‘å°è£…åœ¨<code>confirmTransition</code>ä¸­</li>
<li><code>confirmTransition</code>æ–¹æ³•è¢«å®šä¹‰åœ¨<code>src/base.js</code>ä¸­</li>
</ul>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/base.js Historyç±»ä¸­</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//Â ç¡®è®¤è·¯ç”±è·³è½¬</span></span><br><span class="line">confirmTransitionÂ (<span class="comment">/*Â to*/</span>route:Â Route,Â onComplete:Â <span class="built_in">Function</span>,Â onAbort?:Â <span class="built_in">Function</span>)Â &#123;</span><br><span class="line">Â Â <span class="keyword">const</span>Â currentÂ =Â <span class="keyword">this</span>.currentÂ <span class="comment">/*Â fromÂ */</span></span><br><span class="line"></span><br><span class="line">Â Â <span class="comment">//Â å–æ¶ˆ</span></span><br><span class="line">Â Â <span class="keyword">const</span>Â abortÂ =Â <span class="function"><span class="params">err</span>Â =&gt;</span>Â &#123;</span><br><span class="line">Â Â Â Â <span class="comment">//Â afterÂ mergingÂ https://github.com/vuejs/vue-router/pull/2771Â we</span></span><br><span class="line">Â Â Â Â <span class="comment">//Â WhenÂ theÂ userÂ navigatesÂ throughÂ historyÂ throughÂ back/forwardÂ buttons</span></span><br><span class="line">Â Â Â Â <span class="comment">//Â weÂ doÂ notÂ wantÂ toÂ throwÂ theÂ error.Â WeÂ onlyÂ throwÂ itÂ ifÂ directlyÂ calling</span></span><br><span class="line">Â Â Â Â <span class="comment">//Â push/replace.Â That'sÂ whyÂ it'sÂ notÂ includedÂ inÂ isError</span></span><br><span class="line">Â Â Â Â <span class="keyword">if</span>Â (!isExtendedError(NavigationDuplicated,Â err)Â &amp;&amp;Â isError(err))Â &#123;</span><br><span class="line">Â Â Â Â Â Â <span class="keyword">if</span>Â (<span class="keyword">this</span>.errorCbs.length)Â &#123;</span><br><span class="line">Â Â Â Â Â Â Â Â <span class="keyword">this</span>.errorCbs.forEach(<span class="function"><span class="params">cb</span>Â =&gt;</span>Â &#123;</span><br><span class="line">Â Â Â Â Â Â Â Â Â Â cb(err)</span><br><span class="line">Â Â Â Â Â Â Â Â &#125;)</span><br><span class="line">Â Â Â Â Â Â &#125;Â <span class="keyword">else</span>Â &#123;</span><br><span class="line">Â Â Â Â Â Â Â Â warn(<span class="literal">false</span>,Â <span class="string">'uncaughtÂ errorÂ duringÂ routeÂ navigation:'</span>)</span><br><span class="line">Â Â Â Â Â Â Â Â <span class="built_in">console</span>.error(err)</span><br><span class="line">Â Â Â Â Â Â &#125;</span><br><span class="line">Â Â Â Â &#125;</span><br><span class="line">Â Â Â Â onAbortÂ &amp;&amp;Â onAbort(err)</span><br><span class="line">Â Â &#125;</span><br><span class="line"></span><br><span class="line">Â Â <span class="comment">//Â ç›¸åŒRouteï¼ŒæŠ¥é‡å¤é”™è¯¯</span></span><br><span class="line">Â Â <span class="keyword">if</span>Â (</span><br><span class="line">Â Â Â Â isSameRoute(route,Â current)Â &amp;&amp;</span><br><span class="line">Â Â Â Â <span class="comment">//Â inÂ theÂ caseÂ theÂ routeÂ mapÂ hasÂ beenÂ dynamicallyÂ appendedÂ to</span></span><br><span class="line">Â Â Â Â <span class="comment">//Â é˜²æ­¢routeÂ mapÂ è¢«åŠ¨æ€æ”¹å˜äº†</span></span><br><span class="line">Â Â Â Â route.matched.lengthÂ ===Â current.matched.length</span><br><span class="line">Â Â )Â &#123;</span><br><span class="line">Â Â Â Â <span class="comment">//Â ensureURLç”±å­ç±»å®ç°ï¼Œä¸»è¦æ ¹æ®ä¼ å‚ç¡®å®šæ˜¯æ·»åŠ è¿˜æ˜¯æ›¿æ¢ä¸€ä¸ªè®°å½•</span></span><br><span class="line">Â Â Â Â <span class="keyword">this</span>.ensureURL()Â <span class="comment">//Â æ›¿æ¢å½“å‰å†å²è®°å½•</span></span><br><span class="line">Â Â Â Â <span class="keyword">return</span>Â abort(<span class="keyword">new</span>Â NavigationDuplicated(route))</span><br><span class="line">Â Â &#125;</span><br><span class="line"></span><br><span class="line">Â Â <span class="comment">//Â å¯¹æ¯”å‰årouteçš„RouteRecordï¼Œæ‰¾å‡ºéœ€è¦æ›´æ–°ã€å¤±æ´»ã€æ¿€æ´»çš„çš„è·¯ç”±è®°å½•</span></span><br><span class="line">Â Â <span class="keyword">const</span>Â &#123;Â updated,Â deactivated,Â activatedÂ &#125;Â =Â resolveQueue(</span><br><span class="line">Â Â Â Â <span class="keyword">this</span>.current.matched,</span><br><span class="line">Â Â Â Â route.matched</span><br><span class="line">Â Â )</span><br><span class="line"></span><br><span class="line">Â Â <span class="comment">//Â ç”Ÿæˆéœ€è¦æ‰§è¡Œçš„å®ˆå«ã€é’©å­é˜Ÿåˆ—</span></span><br><span class="line">Â Â <span class="keyword">const</span>Â queue:Â <span class="built_in">Array</span>&lt;?NavigationGuard&gt;Â =Â [].concat(</span><br><span class="line">Â Â Â Â <span class="comment">//Â in-componentÂ leaveÂ guards</span></span><br><span class="line">Â Â Â Â extractLeaveGuards(deactivated),Â <span class="comment">//Â æå–è·¯ç”±ç»„ä»¶ä¸­æ‰€æœ‰beforeRouteLeaveå®ˆå«</span></span><br><span class="line">Â Â Â Â <span class="comment">//Â globalÂ beforeÂ hooks</span></span><br><span class="line">Â Â Â Â <span class="keyword">this</span>.router.beforeHooks,Â <span class="comment">//Â å…¨å±€çš„beforeEachå®ˆå«</span></span><br><span class="line">Â Â Â Â <span class="comment">//Â in-componentÂ updateÂ hooks</span></span><br><span class="line">Â Â Â Â extractUpdateHooks(updated),Â <span class="comment">//Â æå–è·¯ç”±ç»„ä»¶ä¸­æ‰€æœ‰beforeRouteUpdateå®ˆå«</span></span><br><span class="line">Â Â Â Â <span class="comment">//Â in-configÂ enterÂ guards</span></span><br><span class="line">Â Â Â Â activated.map(<span class="function"><span class="params">m</span>Â =&gt;</span>Â m.beforeEnter),Â <span class="comment">//Â è·¯ç”±ç‹¬äº«çš„beforeEnterå®ˆå«</span></span><br><span class="line">Â Â Â Â <span class="comment">//Â asyncÂ components</span></span><br><span class="line">Â Â Â Â resolveAsyncComponents(activated)<span class="comment">//Â è§£æå¼‚æ­¥ç»„ä»¶</span></span><br><span class="line">Â Â )</span><br><span class="line"></span><br><span class="line">Â Â <span class="keyword">this</span>.pendingÂ =Â routeÂ <span class="comment">//Â è®°å½•å°†è¦è·³è½¬çš„routeï¼Œæ–¹ä¾¿å–æ¶ˆå¯¹æ¯”ç”¨</span></span><br><span class="line"></span><br><span class="line">Â Â <span class="comment">//Â è¿­ä»£å‡½æ•°</span></span><br><span class="line">Â Â <span class="keyword">const</span>Â iteratorÂ =Â <span class="function">(<span class="params">hook:Â NavigationGuard,Â next</span>)Â =&gt;</span>Â &#123;</span><br><span class="line">Â Â Â Â <span class="keyword">if</span>Â (<span class="keyword">this</span>.pendingÂ !==Â route)Â &#123;Â <span class="comment">//Â å½“å‘ç°toå‘ç”Ÿå˜åŒ–ï¼Œåˆ™ä»£è¡¨éœ€è¦å–æ¶ˆ</span></span><br><span class="line">Â Â Â Â Â Â <span class="keyword">return</span>Â abort()</span><br><span class="line">Â Â Â Â &#125;</span><br><span class="line">Â Â Â Â <span class="keyword">try</span>Â &#123;</span><br><span class="line">Â Â Â Â Â Â hook(<span class="comment">/*Â to*/</span>route,Â <span class="comment">/*Â from*/</span>current,Â <span class="comment">/*Â next*/</span><span class="function">(<span class="params">to:Â <span class="built_in">any</span></span>)Â =&gt;</span>Â &#123;</span><br><span class="line">Â Â Â Â Â Â Â Â <span class="keyword">if</span>Â (toÂ ===Â <span class="literal">false</span>Â ||Â isError(to))Â &#123;</span><br><span class="line">Â Â Â Â Â Â Â Â Â Â <span class="comment">//Â next(false)Â -&gt;Â abortÂ navigation,Â ensureÂ currentÂ URL</span></span><br><span class="line">Â Â Â Â Â Â Â Â Â Â <span class="comment">//Â next(false)Â -&gt;Â å–æ¶ˆè·³è½¬ï¼Œæ·»åŠ ä¸€ä¸ªæ–°å†å²è®°å½•(ä½†ç”±äºurlåœ°å€æœªå‘ç”Ÿå˜åŒ–ï¼Œæ‰€ä»¥å¹¶æœªæ·»åŠ è®°å½•)</span></span><br><span class="line">Â Â Â Â Â Â Â Â Â Â <span class="keyword">this</span>.ensureURL(<span class="literal">true</span>)</span><br><span class="line">Â Â Â Â Â Â Â Â Â Â abort(to)</span><br><span class="line">Â Â Â Â Â Â Â Â &#125;Â <span class="keyword">else</span>Â <span class="keyword">if</span>Â (</span><br><span class="line">Â Â Â Â Â Â Â Â Â Â <span class="keyword">typeof</span>Â toÂ ===Â <span class="string">'string'</span>Â ||Â <span class="comment">//Â next('/')</span></span><br><span class="line">Â Â Â Â Â Â Â Â Â Â (<span class="keyword">typeof</span>Â toÂ ===Â <span class="string">'object'</span>Â &amp;&amp;</span><br><span class="line">Â Â Â Â Â Â Â Â Â Â Â Â (<span class="keyword">typeof</span>Â to.pathÂ ===Â <span class="string">'string'</span>Â ||Â <span class="keyword">typeof</span>Â to.nameÂ ===Â <span class="string">'string'</span>))Â <span class="comment">//Â next(&#123;path:'/'&#125;)æˆ–next(&#123;name:'Home'&#125;)</span></span><br><span class="line">Â Â Â Â Â Â Â Â )Â &#123;</span><br><span class="line">Â Â Â Â Â Â Â Â Â Â <span class="comment">//Â next('/')Â orÂ next(&#123;Â path:Â '/'Â &#125;)Â -&gt;Â redirect</span></span><br><span class="line">Â Â Â Â Â Â Â Â Â Â abort()Â <span class="comment">//Â å–æ¶ˆå½“å‰</span></span><br><span class="line">Â Â Â Â Â Â Â Â Â Â <span class="keyword">if</span>Â (<span class="keyword">typeof</span>Â toÂ ===Â <span class="string">'object'</span>Â &amp;&amp;Â to.replace)Â &#123;</span><br><span class="line">Â Â Â Â Â Â Â Â Â Â Â Â <span class="comment">//Â è°ƒç”¨å­ç±»æ–¹æ³•çš„æ›¿æ¢è®°å½•</span></span><br><span class="line">Â Â Â Â Â Â Â Â Â Â Â Â <span class="keyword">this</span>.replace(to)</span><br><span class="line">Â Â Â Â Â Â Â Â Â Â &#125;Â <span class="keyword">else</span>Â &#123;</span><br><span class="line">Â Â Â Â Â Â Â Â Â Â Â Â <span class="comment">//Â è°ƒç”¨å­ç±»æ–¹æ³•çš„æ·»åŠ è®°å½•</span></span><br><span class="line">Â Â Â Â Â Â Â Â Â Â Â Â <span class="keyword">this</span>.push(to)</span><br><span class="line">Â Â Â Â Â Â Â Â Â Â &#125;</span><br><span class="line">Â Â Â Â Â Â Â Â &#125;Â <span class="keyword">else</span>Â &#123;</span><br><span class="line">Â Â Â Â Â Â Â Â Â Â <span class="comment">//Â confirmÂ transitionÂ andÂ passÂ onÂ theÂ value</span></span><br><span class="line">Â Â Â Â Â Â Â Â Â Â <span class="comment">//Â next()</span></span><br><span class="line">Â Â Â Â Â Â Â Â Â Â next(to)</span><br><span class="line">Â Â Â Â Â Â Â Â &#125;</span><br><span class="line">Â Â Â Â Â Â &#125;)</span><br><span class="line">Â Â Â Â &#125;Â <span class="keyword">catch</span>Â (e)Â &#123;</span><br><span class="line">Â Â Â Â Â Â abort(e)</span><br><span class="line">Â Â Â Â &#125;</span><br><span class="line">Â Â &#125;</span><br><span class="line"></span><br><span class="line">Â Â <span class="comment">//Â æ‰§è¡Œé˜Ÿåˆ—</span></span><br><span class="line">Â Â runQueue(queue,Â iterator,Â <span class="comment">/*Â æ‰§è¡Œç»“æŸå›è°ƒ*/</span><span class="function"><span class="params">()</span>Â =&gt;</span>Â &#123;</span><br><span class="line">Â Â Â Â <span class="keyword">const</span>Â postEnterCbsÂ =Â []Â <span class="comment">//Â ä¿å­˜beforeRouteEnterä¸­ä¼ ç»™nextçš„å›è°ƒå‡½æ•°</span></span><br><span class="line">Â Â Â Â <span class="keyword">const</span>Â isValidÂ =Â <span class="function"><span class="params">()</span>Â =&gt;</span>Â <span class="keyword">this</span>.currentÂ ===Â routeÂ <span class="comment">//Â è¡¨ç¤ºè·³è½¬ç»“æŸ</span></span><br><span class="line"></span><br><span class="line">Â Â Â Â <span class="comment">//Â waitÂ untilÂ asyncÂ componentsÂ areÂ resolvedÂ before</span></span><br><span class="line">Â Â Â Â <span class="comment">//Â extractingÂ in-componentÂ enterÂ guards</span></span><br><span class="line">Â Â Â Â <span class="keyword">const</span>Â enterGuardsÂ =Â extractEnterGuards(activated,Â postEnterCbs,Â isValid)Â <span class="comment">//Â ç­‰å¾…å¼‚æ­¥ç»„ä»¶è§£æå®Œï¼Œå†æŠ½å–ç»„ä»¶å†…çš„beforeRouteEnterå®ˆå«</span></span><br><span class="line">Â Â Â Â <span class="keyword">const</span>Â queueÂ =Â enterGuards.concat(<span class="keyword">this</span>.router.resolveHooks)<span class="comment">//Â beforeResolveÂ hooks</span></span><br><span class="line">Â Â Â Â runQueue(queue,Â iterator,Â <span class="comment">/*Â æ‰§è¡Œç»“æŸå›è°ƒ*/</span><span class="function"><span class="params">()</span>Â =&gt;</span>Â &#123;</span><br><span class="line">Â Â Â Â Â Â <span class="keyword">if</span>Â (<span class="keyword">this</span>.pendingÂ !==Â route)Â &#123;</span><br><span class="line">Â Â Â Â Â Â Â Â <span class="keyword">return</span>Â abort()</span><br><span class="line">Â Â Â Â Â Â &#125;</span><br><span class="line"></span><br><span class="line">Â Â Â Â Â Â <span class="keyword">this</span>.pendingÂ =Â <span class="literal">null</span></span><br><span class="line"></span><br><span class="line">Â Â Â Â Â Â onComplete(route)Â <span class="comment">//Â æ‰§è¡ŒonCompleteå›è°ƒï¼ŒonCompleteä¸­ä¼šè°ƒç”¨updateRouteæ–¹æ³•ï¼Œå†…éƒ¨ä¼šè§¦å‘afterEaché’©å­</span></span><br><span class="line"></span><br><span class="line">Â Â Â Â Â Â <span class="keyword">if</span>Â (<span class="keyword">this</span>.router.app)Â &#123;</span><br><span class="line">Â Â Â Â Â Â Â Â <span class="keyword">this</span>.router.app.$nextTick(<span class="function"><span class="params">()</span>Â =&gt;</span>Â &#123;</span><br><span class="line">Â Â Â Â Â Â Â Â Â Â <span class="comment">//Â è°ƒç”¨Â beforeRouteEnterÂ å®ˆå«ä¸­ä¼ ç»™Â nextÂ çš„å›è°ƒå‡½æ•°</span></span><br><span class="line">Â Â Â Â Â Â Â Â Â Â <span class="comment">//Â next(vm=&gt;xxx)</span></span><br><span class="line">Â Â Â Â Â Â Â Â Â Â postEnterCbs.forEach(<span class="function"><span class="params">cb</span>Â =&gt;</span>Â &#123;</span><br><span class="line">Â Â Â Â Â Â Â Â Â Â Â Â cb()</span><br><span class="line">Â Â Â Â Â Â Â Â Â Â &#125;)</span><br><span class="line">Â Â Â Â Â Â Â Â &#125;)</span><br><span class="line">Â Â Â Â Â Â &#125;</span><br><span class="line">Â Â Â Â &#125;)</span><br><span class="line">Â Â &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>æˆ‘ä»¬å¯ä»¥å…ˆçœ‹ä¸‹æ–¹æ³•ç­¾å<ul>
<li><code>route</code>ç›®æ ‡è·¯ç”±å¯¹è±¡ï¼Œéœ€è¦è§£æçš„ç›®æ ‡ï¼Œå¯ä»¥ç†è§£ä¸ºè·¯ç”±è·³è½¬æ—¶çš„<code>to</code>å¯¹è±¡ï¼Œè€Œ<code>current</code>åˆ™å¯ä»¥ç†è§£ä¸º<code>from</code>å¯¹è±¡ã€‚</li>
<li><code>onComplete</code>è·³è½¬å®Œæˆçš„å›è°ƒ</li>
<li><code>onAbort</code>å–æ¶ˆã€é”™è¯¯çš„å›è°ƒ</li>
</ul>
</li>
<li>çœ‹ä¸‹ä¸»è¦é€»è¾‘<ul>
<li>é¦–å…ˆå¤„ç†äº†é‡å¤è·³è½¬çš„é—®é¢˜</li>
<li>ç„¶åé€šè¿‡å¯¹æ¯”æ‰¾å‡ºéœ€è¦æ›´æ–°ã€å¤±æ´»ã€æ¿€æ´»çš„è·¯ç”±è®°å½•</li>
<li>ä»ä¸Šè¿°ä¸‰ç§è·¯ç”±è®°å½•ä¸­æŠ½å–å‡ºå¯¹åº”é’©å­ã€å®ˆå«å‡½æ•°</li>
<li>å°†é’©å­åŠå®ˆå«å‡½æ•°æ”¾å…¥é˜Ÿåˆ—ä¸­å¹¶æ‰§è¡Œ</li>
</ul>
</li>
<li>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬ä¾æ¬¡çœ‹ä¸‹ç›¸å…³é€»è¾‘</li>
</ul>
<h3 id="åˆ¤æ–­é‡å¤è·³è½¬"><a href="#åˆ¤æ–­é‡å¤è·³è½¬" class="headerlink" title="åˆ¤æ–­é‡å¤è·³è½¬"></a>åˆ¤æ–­é‡å¤è·³è½¬</h3><ul>
<li>åœ¨åˆ¤æ–­é‡å¤è·³è½¬å‰å®šä¹‰äº†<code>abort</code>æ–¹æ³•ï¼Œå®ƒä¸»è¦å¯¹<code>onAbort</code>æ–¹æ³•åšäº†ä¸€å±‚åŒ…è£…ï¼›è¿™ä¸ªæ–¹æ³•åœ¨å¯¼èˆªå‘ç”Ÿå–æ¶ˆæ—¶ä¼šè¢«è°ƒç”¨åˆ°<ul>
<li>å®ƒæ¥æ”¶ä¸€ä¸ª<code>err</code>å‚æ•°ï¼Œå¦‚æœæœ‰æ³¨å†Œé”™è¯¯å›è°ƒå¹¶ä¸”<code>err</code>ä¸ºé<code>NavigationDuplicated</code>é”™è¯¯åˆ™éå†<code>errorCbs</code>åˆ—è¡¨æ‰§è¡Œå…¶ä¸­çš„é”™è¯¯å›è°ƒ</li>
<li>æœ€åè°ƒç”¨<code>onAbort</code>å›è°ƒå¹¶ä¼ å…¥<code>err</code>å‚æ•°äº¤ç»™å¤–éƒ¨å¤„ç†</li>
</ul>
</li>
<li>æ¥ä¸‹æ¥åˆ¤æ–­äº†æ˜¯å¦é‡å¤è·³è½¬ï¼Œä¸»è¦åˆ©ç”¨<code>isSameRoute</code>æ£€æµ‹äº†å½“å‰è·¯ç”±å¯¹è±¡å’Œç›®æ ‡è·¯ç”±å¯¹è±¡æ˜¯å¦ç›¸åŒï¼Œè‹¥ç›¸åŒä¸”äºŒè€…åŒ¹é…åˆ°è·¯ç”±è®°å½•æ•°é‡ç›¸åŒï¼Œåˆ™è§†ä¸ºé‡å¤è·³è½¬ï¼Œæ­¤æ—¶è°ƒç”¨<code>abort</code>æ–¹æ³•å¹¶ä¼ å…¥<code>NavigationDuplicated</code>é”™è¯¯å¹¶ç»ˆæ­¢æµç¨‹</li>
<li><code>isSameRoute</code>ä¸»è¦åˆ¤æ–­äº†<code>pathã€nameã€hashã€queryã€params</code>ç­‰å…³é”®ä¿¡æ¯æ˜¯å¦ç›¸åŒï¼Œè‹¥ç›¸åŒåˆ™è§†ä¸ºç›¸åŒè·¯ç”±å¯¹è±¡</li>
</ul>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/util/route.js</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//Â æ˜¯å¦ç›¸åŒroute</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">isSameRoute</span>(<span class="params">a: Route, b: ?Route</span>): <span class="title">boolean</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (b === START) &#123;</span><br><span class="line">    <span class="keyword">return</span> a === b</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!b) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (a.path &amp;&amp; b.path) &#123;</span><br><span class="line">    <span class="comment">//Â pathéƒ½å­˜åœ¨ï¼Œæ¯”è¾ƒpathã€hashã€queryæ˜¯å¦ç›¸åŒ</span></span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      a.path.replace(trailingSlashRE, <span class="string">''</span>) ===</span><br><span class="line">        b.path.replace(trailingSlashRE, <span class="string">''</span>) &amp;&amp;</span><br><span class="line">      a.hash === b.hash &amp;&amp;</span><br><span class="line">      isObjectEqual(a.query, b.query)</span><br><span class="line">    )</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (a.name &amp;&amp; b.name) &#123;</span><br><span class="line">    <span class="comment">//Â nameéƒ½å­˜åœ¨ï¼Œæ¯”è¾ƒnameã€hashã€queryã€paramsæ˜¯å¦ç›¸åŒ</span></span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      a.name === b.name &amp;&amp;</span><br><span class="line">      a.hash === b.hash &amp;&amp;</span><br><span class="line">      isObjectEqual(a.query, b.query) &amp;&amp;</span><br><span class="line">      isObjectEqual(a.params, b.params)</span><br><span class="line">    )</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>æ³¨æ„ï¼Œåœ¨ç¡®å®šæ˜¯é‡å¤è·³è½¬åï¼Œä»ç„¶ä¼šè°ƒç”¨å­ç±»çš„<code>ensureURL</code>æ–¹æ³•æ¥æ›´æ–°<code>url</code></li>
</ul>
<h3 id="å¯¹æ¯”æ‰¾å‡ºéœ€è¦æ›´æ–°ã€å¤±æ´»ã€æ¿€æ´»çš„è·¯ç”±è®°å½•"><a href="#å¯¹æ¯”æ‰¾å‡ºéœ€è¦æ›´æ–°ã€å¤±æ´»ã€æ¿€æ´»çš„è·¯ç”±è®°å½•" class="headerlink" title="å¯¹æ¯”æ‰¾å‡ºéœ€è¦æ›´æ–°ã€å¤±æ´»ã€æ¿€æ´»çš„è·¯ç”±è®°å½•"></a>å¯¹æ¯”æ‰¾å‡ºéœ€è¦æ›´æ–°ã€å¤±æ´»ã€æ¿€æ´»çš„è·¯ç”±è®°å½•</h3><ul>
<li>åˆ¤æ–­å®Œé‡å¤è·³è½¬åï¼Œå°±éœ€è¦å¯¹æ¯”<code>from</code>ã€<code>to</code>è·¯ç”±å¯¹è±¡ï¼Œæ‰¾å‡ºå“ªäº›è·¯ç”±è®°å½•éœ€è¦æ›´æ–°ï¼Œå“ªäº›å¤±æ´»ã€å“ªäº›éœ€è¦æ¿€æ´»ï¼Œç”¨æ¥åç»­æŠ½å–é’©å­ã€å®ˆå«å‡½æ•°</li>
</ul>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/history/base.js confirmTransitionæ–¹æ³•ä¸­</span></span><br><span class="line"><span class="comment">//Â å¯¹æ¯”å‰årouteçš„RouteRecordï¼Œæ‰¾å‡ºéœ€è¦æ›´æ–°ã€å¤±æ´»ã€æ¿€æ´»çš„çš„è·¯ç”±è®°å½•</span></span><br><span class="line"><span class="keyword">const</span> &#123; updated, deactivated, activated &#125; = resolveQueue(</span><br><span class="line">  <span class="keyword">this</span>.current.matched,</span><br><span class="line">  route.matched</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<ul>
<li>å¯ä»¥çœ‹åˆ°é€»è¾‘å°è£…åœ¨äº†<code>resolveQueue</code>æ–¹æ³•ä¸­ï¼Œä¼ å…¥äº†å½“å‰å’Œç›®æ ‡è·¯ç”±å¯¹è±¡çš„è®°å½•åˆ—è¡¨ï¼Œä»è¿”å›å€¼ä¸­è§£æ„å‡ºäº†<code>updated, deactivated, activated</code></li>
<li>çœ‹ä¸‹<code>resolveQueue</code>å®ç°</li>
</ul>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Â å¯¹æ¯”currenã€nextçš„è·¯ç”±è®°å½•åˆ—è¡¨ï¼Œæ‰¾å‡ºéœ€è¦æ›´æ–°ã€å¤±æ´»ã€æ¿€æ´»çš„è·¯ç”±è®°å½•</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">resolveQueue</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  current: <span class="built_in">Array</span>&lt;RouteRecord&gt;,</span></span></span><br><span class="line"><span class="function"><span class="params">  next: <span class="built_in">Array</span>&lt;RouteRecord&gt;</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): </span>&#123;</span><br><span class="line">  updated: <span class="built_in">Array</span>&lt;RouteRecord&gt;</span><br><span class="line">  activated: <span class="built_in">Array</span>&lt;RouteRecord&gt;</span><br><span class="line">  deactivated: <span class="built_in">Array</span>&lt;RouteRecord&gt;</span><br><span class="line">&#125; &#123;</span><br><span class="line">  <span class="keyword">let</span> i</span><br><span class="line">  <span class="keyword">const</span> max = <span class="built_in">Math</span>.max(current.length, next.length) <span class="comment">//Â æ‰¾åˆ°é¦–ä¸ªä¸ç›¸ç­‰çš„è·¯ç”±è®°å½•ç´¢å¼•</span></span><br><span class="line">  <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; max; i++) &#123;</span><br><span class="line">    <span class="keyword">if</span> (current[i] !== next[i]) &#123;</span><br><span class="line">      <span class="keyword">break</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="comment">//Â eg //Â current:[1,2,3] //Â next:[1,2,3,4,5] //Â iä¸º3 //Â éœ€è¦æ›´æ–°çš„ä¸º[1,2,3] //Â éœ€è¦æ¿€æ´»çš„ä¸º[4,5] //Â éœ€è¦å¤±æ´»çš„ä¸º[]</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    updated: next.slice(<span class="number">0</span>, i), <span class="comment">//Â ç´¢å¼•å·¦ä¾§æ˜¯éœ€è¦æ›´æ–°çš„</span></span><br><span class="line">    activated: next.slice(i), <span class="comment">//Â ç´¢å¼•å³ä¾§æ˜¯éœ€è¦æ¿€æ´»çš„</span></span><br><span class="line">    deactivated: current.slice(i), <span class="comment">//Â å½“å‰ç´¢å¼•å³ä¾§æ˜¯éœ€è¦å¤±æ´»çš„</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>é€»è¾‘å¾ˆç®€å•<ul>
<li>é¦–å…ˆæ‰¾å‡º<code>current</code>å’Œ<code>next</code>åˆ—è¡¨é•¿åº¦çš„æœ€å¤§å€¼ï¼Œ</li>
<li>ç„¶åä»¥æ­¤ä¸ºå¾ªç¯æœ€å¤§æ¬¡æ•°å¾ªç¯æ‰¾å‡ºé¦–ä¸ªä¸ç›¸ç­‰çš„è·¯ç”±è®°å½•ç´¢å¼•</li>
<li>ä»¥æ­¤ç´¢å¼•ä¸ºåˆ†ç•Œçº¿ï¼Œ<code>nextåˆ—è¡¨</code>å½“å‰ç´¢å¼•å·¦ä¾§ä¸ºéœ€è¦æ›´æ–°çš„è·¯ç”±è®°å½•ã€ç´¢å¼•åŠç´¢å¼•å³ä¾§çš„ä¸ºéœ€è¦æ¿€æ´»çš„è·¯ç”±è®°å½•</li>
<li><code>currentåˆ—è¡¨</code>ç´¢å¼•åŠå³ä¾§æ˜¯éœ€è¦å¤±æ´»çš„è·¯ç”±è®°å½•</li>
</ul>
</li>
<li>ä¸¾ä¾‹</li>
<li><code>current</code>ä¸º:<code>[1,2,3]</code>ã€<code>next</code>ä¸º<code>[1,2,3,4,5]</code>ï¼Œå½“å‰è·¯ç”±å¯¹è±¡åŒ…å«<code>1ã€2ã€3</code>ä¸‰ä¸ªè·¯ç”±è®°å½•ï¼Œç›®æ ‡è·¯ç”±å¯¹è±¡åŒ…å«<code>1ã€2ã€3ã€4ã€5</code>äº”ä¸ªè·¯ç”±è®°å½•</li>
<li>è®¡ç®—å<code>max</code>ä¸º<code>5</code></li>
<li>å¾ªç¯ï¼Œå‘ç°é¦–ä¸ªä¸ç›¸ç­‰çš„ç´¢å¼•ä¸º<code>3</code></li>
<li>æ‰€ä»¥éœ€è¦æ›´æ–°çš„ä¸º<code>next.slice(0,3)</code>å³<code>1ã€2ã€3</code></li>
<li>éœ€è¦æ¿€æ´»çš„ä¸º<code>next.slice(3)</code>å³<code>4ã€5</code></li>
<li>éœ€è¦å¤±æ´»çš„ä¸º<code>current.slice(3)</code>ï¼Œæ²¡æœ‰éœ€è¦å¤±æ´»çš„</li>
<li>æ‰¾å‡ºäº†éœ€è¦æ›´æ–°ã€æ¿€æ´»ã€å¤±æ´»çš„è·¯ç”±è®°å½•ï¼Œæˆ‘ä»¬å°±å¯ä»¥ä»ä¸­æŠ½å–å‡ºå¯¹åº”çš„é’©å­ã€å®ˆå«å‡½æ•°</li>
</ul>
<h3 id="æŠ½å–é’©å­ã€å®ˆå«å‡½æ•°ã€è§£æå¼‚æ­¥ç»„ä»¶"><a href="#æŠ½å–é’©å­ã€å®ˆå«å‡½æ•°ã€è§£æå¼‚æ­¥ç»„ä»¶" class="headerlink" title="æŠ½å–é’©å­ã€å®ˆå«å‡½æ•°ã€è§£æå¼‚æ­¥ç»„ä»¶"></a>æŠ½å–é’©å­ã€å®ˆå«å‡½æ•°ã€è§£æå¼‚æ­¥ç»„ä»¶</h3><ul>
<li>é¦–å…ˆæˆ‘ä»¬æ¢³ç†ä¸‹<code>vue-router</code>æœ‰å“ªäº›é’©å­ã€å®ˆå«å‡½æ•°<ul>
<li><code>router.beforeEach</code>å…¨å±€å‰ç½®å®ˆå«</li>
<li><code>router.beforeResolve</code>å…¨å±€è§£æå®ˆå«(v2.5.0 æ–°å¢)</li>
<li><code>router.afterEach</code>å…¨å±€åç½®é’©å­</li>
<li><code>RouteConfig.beforeEnter</code>è·¯ç”±ç‹¬äº«çš„å®ˆå«</li>
<li><code>vm.beforeRouteEnter</code>vue ç»„ä»¶å†…è·¯ç”±è¿›å…¥å®ˆå«</li>
<li><code>vm.beforeRouteUpdate</code>vue ç»„ä»¶å†…è·¯ç”±æ›´æ–°å®ˆå«(v2.2 æ–°å¢)</li>
<li><code>vm.beforeRouteLeave</code>vue ç»„ä»¶å†…è·¯ç”±ç¦»å¼€å®ˆå«</li>
</ul>
</li>
<li>å¯ä»¥çœ‹åˆ°æœ‰äº›æ˜¯å®šä¹‰<code>VueRouter</code>å®ä¾‹ä¸Šçš„ï¼Œæœ‰äº›æ˜¯å®šä¹‰åœ¨é…ç½®è§„åˆ™<code>RouteConfig</code>ä¸Šçš„ï¼Œæœ‰äº›æ˜¯å®šä¹‰åœ¨<code>RouteComponentè·¯ç”±ç»„ä»¶</code>ä¸Šçš„<ul>
<li>å‰ä¸¤è€…çš„é’©å­ã€å®ˆå«æ˜¯å¾ˆå®¹æ˜“è·å–åˆ°çš„ï¼Œå› ä¸ºæˆ‘ä»¬åœ¨<code>Historyç±»</code>ä¸­æŒæœ‰äº†<code>VueRouter</code>å®ä¾‹ï¼Œå¾ˆå®¹æ˜“è®¿é—®åˆ°è¿™äº›å®ˆå«ã€é’©å­å¹¶ä¸”å‡ ä¹ä¸éœ€è¦åšé¢å¤–å¤„ç†å°±å¯ä»¥ç›´æ¥æ‰§è¡Œï¼›</li>
<li>å”¯ä¸€ä¸å¥½å¤„ç†çš„æ˜¯å®šä¹‰åœ¨<code>RouteComponentè·¯ç”±ç»„ä»¶</code>ä¸­çš„å®ˆå«å‡½æ•°ï¼Œéœ€è¦å€ŸåŠ©<code>RouteRecord</code>æ‹¿åˆ°æ‰€æœ‰<code>RouteComponentè·¯ç”±ç»„ä»¶</code>å¹¶ä»ä¸­æŠ½å–å‡ºå¯¹åº”å®ˆå«ï¼Œæœ€åè¿˜è¦ä¸ºå…¶ç»‘å®šä¸Šä¸‹æ–‡ï¼Œä¿è¯æ‰§è¡Œç»“æœæ­£ç¡®ï¼›</li>
</ul>
</li>
<li>ä¸ŠèŠ‚ï¼Œæˆ‘ä»¬å·²ç»æ‹¿åˆ°éœ€è¦æ›´æ–°ã€æ¿€æ´»ã€å¤±æ´»çš„<code>RouteRecordè·¯ç”±è®°å½•</code>ï¼Œæˆ‘ä»¬çœ‹ä¸‹åˆ†åˆ«è¦ä»ä¸­æŠ½å–å‡ºå“ªäº›å®ˆå«</li>
<li><code>deactivated</code>ä¸­æŠ½å–<code>beforeRouteLeave</code></li>
<li><code>updated</code>ä¸­æŠ½å–<code>beforeRouteUpdate</code></li>
<li><code>activated</code>ä¸­æŠ½å–<code>beforeRouteEnter</code>ï¼Œè¿™é‡Œå­˜åœ¨ä¸€ä¸ªç‰¹æ®Šåœºæ™¯ï¼Œå°±æ˜¯å¼‚æ­¥è·¯ç”±ç»„ä»¶ï¼Œéœ€è¦ç­‰å¾…å¼‚æ­¥è·¯ç”±ç»„ä»¶è§£æå®Œæˆåï¼Œæ‰èƒ½æŠ½å–<code>beforeRouteEnter</code>å®ˆå«ï¼Œè¿™ä¸ªåé¢ä¼šè®²</li>
<li>æˆ‘ä»¬å…ˆçœ‹ä¸‹æŠ½å–çš„å…¥å£ä»£ç </li>
</ul>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/history/base.js confirmTransitionæ–¹æ³•å†…</span></span><br><span class="line"><span class="comment">//Â ç”Ÿæˆéœ€è¦æ‰§è¡Œçš„å®ˆå«ã€é’©å­é˜Ÿåˆ—</span></span><br><span class="line"><span class="keyword">const</span> queue: <span class="built_in">Array</span>&lt;?NavigationGuard&gt; = [].concat(</span><br><span class="line">  <span class="comment">//Â in-componentÂ leaveÂ guards</span></span><br><span class="line">  extractLeaveGuards(deactivated), <span class="comment">//Â æå–è·¯ç”±ç»„ä»¶ä¸­æ‰€æœ‰beforeRouteLeaveå®ˆå« //Â globalÂ beforeÂ hooks</span></span><br><span class="line">  <span class="keyword">this</span>.router.beforeHooks, <span class="comment">//Â å…¨å±€çš„beforeEachå®ˆå« //Â in-componentÂ updateÂ hooks</span></span><br><span class="line">  extractUpdateHooks(updated), <span class="comment">//Â æå–è·¯ç”±ç»„ä»¶ä¸­æ‰€æœ‰beforeRouteUpdateå®ˆå« //Â in-configÂ enterÂ guards</span></span><br><span class="line">  activated.map(<span class="function">(<span class="params">m</span>) =&gt;</span> m.beforeEnter), <span class="comment">//Â è·¯ç”±ç‹¬äº«çš„beforeEnterå®ˆå« //Â asyncÂ components</span></span><br><span class="line">  resolveAsyncComponents(activated) <span class="comment">//Â è§£æå¼‚æ­¥ç»„ä»¶</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<ul>
<li>å¯ä»¥çœ‹åˆ°å®šä¹‰äº†ä¸€ä¸ªé˜Ÿåˆ—<code>queue</code></li>
<li>ä¾æ¬¡åšäº†ä¸‹é¢çš„äº‹<ul>
<li>æŠ½å–äº†<code>deactivated</code>ä¸­çš„<code>beforeRouteLeave</code>å®ˆå«</li>
<li>è·å–äº†<code>VueRouter</code>å®ä¾‹ä¸Šå®šä¹‰çš„<code>beforeEach</code>å®ˆå«<ul>
<li><code>beforeEach</code>å®ˆå«æ˜¯ç›´æ¥å®šä¹‰åœ¨<code>VueRouter</code>å®ä¾‹ä¸Šçš„</li>
</ul>
</li>
<li>ä»<code>updated</code>ä¸­æŠ½å–äº†<code>beforeRouteUpdate</code>å®ˆå«</li>
<li>ä»<code>activated</code>ä¸­è·å–äº†è·¯ç”±ç‹¬äº«çš„<code>beforeEnter</code>å®ˆå«<ul>
<li><code>beforeEnter</code>å®ˆå«æœ€åˆæ˜¯å®šä¹‰åœ¨<code>RouteConfig</code>ä¸Šçš„ï¼Œåé¢åˆä¼ é€’ç»™è·¯ç”±è®°å½•ï¼Œæ‰€ä»¥åœ¨è·¯ç”±è®°å½•ä¸Šèƒ½ç›´æ¥è·å–åˆ°</li>
</ul>
</li>
<li>è§£æ<code>activated</code>ä¸­çš„å¼‚æ­¥è·¯ç”±ç»„ä»¶<ul>
<li>è·¯ç”±ç»„ä»¶æ”¯æŒ<code>import()</code>åŠ¨æ€å¯¼å…¥ï¼Œæ‰€ä»¥è¿™é‡Œè¦å¤„ç†</li>
</ul>
</li>
</ul>
</li>
<li>æˆ‘ä»¬å…ˆçœ‹æ–¹æ³•åå¾ˆç±»ä¼¼çš„<code>extractLeaveGuards</code>å’Œ<code>extractUpdateHooks</code></li>
</ul>
<h4 id="extractLeaveGuardsã€extractUpdateHooks"><a href="#extractLeaveGuardsã€extractUpdateHooks" class="headerlink" title="extractLeaveGuardsã€extractUpdateHooks"></a>extractLeaveGuardsã€extractUpdateHooks</h4><ul>
<li>äºŒè€…éƒ½ä½äº<code>src/base.js</code></li>
</ul>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/base.js</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//Â ä¼ å…¥è·¯ç”±è®°å½•åˆ—è¡¨ï¼Œæå–å‡ºbeforeRouteLeaveå®ˆå«å¹¶é€†åºè¾“å‡º</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">extractLeaveGuards</span>(<span class="params">deactivated: <span class="built_in">Array</span>&lt;RouteRecord&gt;</span>): <span class="title">Array</span>&lt;?<span class="title">Function</span>&gt; </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> extractGuards(deactivated, <span class="string">'beforeRouteLeave'</span>, bindGuard, <span class="literal">true</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//Â ä¼ å…¥è·¯ç”±è®°å½•åˆ—è¡¨ï¼Œæå–å‡ºbeforeRouteUpdateé’©å­</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">extractUpdateHooks</span>(<span class="params">updated: <span class="built_in">Array</span>&lt;RouteRecord&gt;</span>): <span class="title">Array</span>&lt;?<span class="title">Function</span>&gt; </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> extractGuards(updated, <span class="string">'beforeRouteUpdate'</span>, bindGuard)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>å¯ä»¥çœ‹åˆ°äºŒè€…å†…éƒ¨éƒ½è°ƒç”¨äº†<code>extractGuards</code>ï¼Œå‰è€…å¤šä¼ äº†ä¸€ä¸ªå‚æ•°<code>true</code></li>
<li>æˆ‘ä»¬å†çœ‹ä¸‹<code>extractGuards</code></li>
</ul>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/base.js</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//Â æå–å®ˆå«</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">extractGuards</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  records: <span class="built_in">Array</span>&lt;RouteRecord&gt;,</span></span></span><br><span class="line"><span class="function"><span class="params">  name: <span class="built_in">string</span>, <span class="comment">//Â è¦æå–çš„å®ˆå«å</span></span></span></span><br><span class="line"><span class="function"><span class="params">  bind: <span class="built_in">Function</span>, <span class="comment">//Â ç»‘å®šå®ˆå«ä¸Šä¸‹æ–‡å‡½æ•°</span></span></span></span><br><span class="line"><span class="function"><span class="params">  reverse?: <span class="built_in">boolean</span> <span class="comment">//Â æ˜¯å¦éœ€è¦é€†åº</span></span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">Array</span>&lt;?<span class="title">Function</span>&gt; </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> guards = flatMapComponents(records, (</span><br><span class="line">    def <span class="comment">/*è·¯ç”±ç»„ä»¶å®šä¹‰*/</span>,</span><br><span class="line">    instance <span class="comment">/*router-viewå®ä¾‹*/</span>,</span><br><span class="line">    match <span class="comment">/*è·¯ç”±è®°å½•*/</span>,</span><br><span class="line">    key <span class="comment">/*è§†å›¾å*/</span></span><br><span class="line">  ) =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> guard = extractGuard(def, name) <span class="comment">//Â æå–å‡ºè·¯ç”±ç»„ä»¶ä¸­çš„å®ˆå«å‡½æ•° //Â ä¸ºå®ˆå«ç»‘å®šä¸Šä¸‹æ–‡</span></span><br><span class="line">    <span class="keyword">if</span> (guard) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="built_in">Array</span>.isArray(guard)</span><br><span class="line">        ? guard.map(<span class="function">(<span class="params">guard</span>) =&gt;</span> bind(guard, instance, match, key))</span><br><span class="line">        : bind(guard, instance, match, key)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;) <span class="comment">//Â æ‰å¹³åŒ–Â +Â é€†åº</span></span><br><span class="line">  <span class="keyword">return</span> flatten(reverse ? guards.reverse() : guards)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>çœ‹ä¸‹æ–¹æ³•ç­¾å<ul>
<li>æ¥æ”¶ä¸€ä¸ªè·¯ç”±è®°å½•æ•°ç»„<code>records</code><ul>
<li>å³<code>extractLeaveGuards</code>ä¸­ä¼ å…¥çš„<code>deactivated</code>è·¯ç”±è®°å½•æ•°ç»„ï¼›<code>extractUpdateHooks</code>ä¸­ä¼ å…¥çš„<code>updated</code>è·¯ç”±è®°å½•æ•°ç»„</li>
</ul>
</li>
<li>æ¥æ”¶ä¸€ä¸ªéœ€è¦æå–çš„å®ˆå«å<code>name</code><ul>
<li><code>beforeRouteLeave</code>å’Œ<code>beforeRouteUpdate</code>å­—ç¬¦ä¸²</li>
</ul>
</li>
<li>ä¸€ä¸ªç»‘å®šå®ˆå«ä¸Šä¸‹çš„å‡½æ•°<code>bind</code><ul>
<li><code>extractLeaveGuards</code>ã€<code>extractUpdateHooks</code>ä¼ é€’çš„éƒ½æ˜¯<code>bindGuard</code>æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•æˆ‘ä»¬åœ¨ä¸‹é¢è§£æ</li>
</ul>
</li>
<li>ä»¥åŠä¸€ä¸ªæ˜¯å¦éœ€è¦é€†åºè¾“å‡ºçš„<code>reverse</code>å¸ƒå°”å€¼ï¼›å¯é€‰å‚æ•°ï¼›<ul>
<li><code>extractLeaveGuards</code>ä¼ é€’çš„æ˜¯<code>true</code>ï¼Œä»£è¡¨è¿”å›çš„æ•°ç»„(å®ˆå«å‡½æ•°æ•°ç»„)éœ€è¦é€†åºè¾“å‡ºï¼›</li>
</ul>
</li>
<li>è¿”å›ä¸€ä¸ª<code>item</code>æ˜¯<code>Function</code>çš„æ•°ç»„</li>
</ul>
</li>
<li>çœ‹ä¸‹å†…éƒ¨é€»è¾‘<ul>
<li>è°ƒç”¨<code>flatMapComponents</code>ä¼ å…¥<code>records</code>å’Œä¸€ä¸ªæ¥æ”¶<code>def, instance, match, key</code>å‚æ•°çš„ç®­å¤´å‡½æ•°ï¼Œè¿”å›ä¸€ä¸ª<code>guards</code>å®ˆå«æ•°ç»„</li>
<li>ç„¶åæ ¹æ®<code>reverse</code>æ¥å†³å®šæ˜¯å¦å¯¹<code>guards</code>æ•°ç»„åšé€†åºå¤„ç†<ul>
<li>ä¸ºä½•éœ€è¦é€†åº?</li>
<li>åœ¨<code>createRoute</code>ç« èŠ‚ä¹Ÿæè¿‡ï¼Œåœ¨ä¿å­˜è·¯ç”±è®°å½•æ—¶æ˜¯é€†åºçš„ï¼Œç²¾å‡†åŒ¹é…çš„è·¯ç”±è®°å½•åœ¨æ•°ç»„æœ€å(<code>length - 1</code>ä½ç½®)ï¼Œçˆ¶è®°å½•åœ¨å‰</li>
<li>éƒ¨åˆ†å®ˆå«å‡½æ•°éœ€è¦é€†åºé€†åºæ‰§è¡Œï¼Œä¾‹å¦‚<code>beforeRouteLeave</code>ï¼Œå®ƒéœ€è¦å…ˆåœ¨ç²¾å‡†åŒ¹é…çš„è·¯ç”±ç»„ä»¶ä¸Šè°ƒç”¨ï¼Œå†åœ¨çˆ¶ç»„ä»¶ä¸Šè°ƒç”¨</li>
</ul>
</li>
<li>æœ€åè°ƒç”¨<code>flatten</code>å°†<code>guards</code>æ‰å¹³åŒ–</li>
</ul>
</li>
<li>å…ˆçœ‹ä¸‹<code>flatMapComponents</code>å®ç°</li>
</ul>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/util/resolve-components.js</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//Â æ‰å¹³åŒ–è·¯ç”±è®°å½•ä¸­çš„è·¯ç”±ç»„ä»¶</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">flatMapComponents</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  matched: <span class="built_in">Array</span>&lt;RouteRecord&gt;, <span class="comment">//Â è·¯ç”±è®°å½•æ•°ç»„</span></span></span></span><br><span class="line"><span class="function"><span class="params">  fn: <span class="built_in">Function</span> <span class="comment">//Â å›è°ƒå‡½æ•°</span></span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">Array</span>&lt;?<span class="title">Function</span>&gt; </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> flatten(</span><br><span class="line">    matched.map(<span class="function">(<span class="params">m</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="built_in">Object</span>.keys(m.components).map(<span class="function">(<span class="params">key</span>) =&gt;</span></span><br><span class="line">        fn(</span><br><span class="line">          m.components[key], <span class="comment">//Â å‘½åè§†å›¾å¯¹åº”çš„è·¯ç”±ç»„ä»¶å®šä¹‰ï¼›ä¸€èˆ¬å¯¹åº”fnçš„å…¥å‚def</span></span><br><span class="line">          m.instances[key], <span class="comment">//Â router-viewå®ä¾‹ï¼›ä¸€èˆ¬å¯¹åº”fnçš„å…¥å‚_æˆ–instance</span></span><br><span class="line">          m, <span class="comment">//Â åŒ¹é…çš„è·¯ç”±è®°å½•ï¼›ä¸€èˆ¬å¯¹åº”fnçš„å…¥å‚match</span></span><br><span class="line">          key <span class="comment">//Â å‘½åè§†å›¾çš„keyï¼›ä¸€èˆ¬å¯¹åº”fnçš„å…¥å‚key</span></span><br><span class="line">        )</span><br><span class="line">      )</span><br><span class="line">    &#125;)</span><br><span class="line">  )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>å¯ä»¥çœ‹åˆ°å…¶æ¥æ”¶ä¸€ä¸ªè·¯ç”±è®°å½•æ•°ç»„<code>matched</code>å’Œä¸€ä¸ªå‡½æ•°<code>fn</code>ï¼Œè¿”å›ä¸€ä¸ªç»è¿‡<code>flatten</code>å¤„ç†çš„æ•°ç»„<ul>
<li><code>matched</code>å°±æ˜¯æˆ‘ä»¬ä¼ å…¥çš„<code>records</code></li>
<li><code>fn</code>å°±æ˜¯æ¥æ”¶<code>def, instance, match, key</code>å‚æ•°çš„ç®­å¤´å‡½æ•°</li>
</ul>
</li>
<li>è¿™ä¸ªæ–¹æ³•ä¸»è¦æ˜¯éå†è·¯ç”±è®°å½•ä¸­çš„æ¯ä¸ªè·¯ç”±ç»„ä»¶å¹¶ç”¨å…¶åšå…¥å‚ä¾æ¬¡è°ƒç”¨å¤–éƒ¨å‡½æ•°<code>fn</code>ï¼Œè¿”å›ç»“æœç”±<code>fn</code>å‡½æ•°å†³å®šï¼Œæœ€åå°†ç»“æœæ•°ç»„æ‰å¹³åŒ–è¾“å‡º<ul>
<li>åœ¨è§£æå¼‚æ­¥ç»„ä»¶æ—¶ä¹Ÿä¼šç”¨åˆ°æ­¤æ–¹æ³•</li>
</ul>
</li>
<li>å…¶ä¼šå¯¹ä¼ å…¥çš„<code>records</code>è°ƒç”¨<code>map</code>æ–¹æ³•ï¼Œå¹¶éå†æ¯ä¸ª<code>record</code>ä¸Šå®šä¹‰çš„<code>components</code>å­—æ®µï¼Œå¹¶å¯¹<code>components</code>å†æ¬¡è¿›è¡Œ<code>map</code>éå†ï¼Œç„¶åè°ƒç”¨ä¼ å…¥çš„<code>fn</code>ï¼Œ<code>map</code>ç»“æœå°±æ˜¯<code>fn</code>è¿”å›çš„ç»“æœ</li>
<li><code>components</code>å­—æ®µæ˜¯å®šä¹‰å‘½åè§†å›¾ç”¨çš„ï¼Œé•¿ä¸‹é¢è¿™æ ·ï¼Œkey ä¸ºè§†å›¾åï¼Œvalue ä¸ºå¯¹åº”è·¯ç”±ç»„ä»¶</li>
</ul>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">components: &#123;</span><br><span class="line">        <span class="keyword">default</span>: Foo,</span><br><span class="line">        a: Bar,</span><br><span class="line">        b: Baz</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>æ‰€ä»¥ä¼ å…¥çš„ fnï¼Œå³æ¥æ”¶<code>def, instance, match, key</code>å‚æ•°çš„ç®­å¤´å‡½æ•°çš„å››ä¸ªå‚æ•°åˆ†åˆ«ä¸º<ul>
<li><code>def</code>å¯¹åº”<code>m.components[key]</code>å³è·¯ç”±ç»„ä»¶å®šä¹‰(<code>Fooã€Barã€Baz</code>)</li>
<li><code>instance</code>å¯¹åº”<code>m.instances[key]</code>æ˜¯<code>router-view</code>ç»„ä»¶å®ä¾‹ï¼Œå…³äºè·¯ç”±è®°å½•å’Œ<code>route-view</code>æ˜¯å¦‚ä½•å…³è”çš„ï¼Œä¼šåœ¨ä»‹ç»<code>viewç»„ä»¶</code>æ—¶è§£æ</li>
<li><code>m</code>å¯¹åº”çš„å°±æ˜¯å½“å‰éå†åˆ°çš„è·¯ç”±è®°å½•</li>
<li><code>key</code>æ˜¯å½“å‰éå†åˆ°çš„è§†å›¾å</li>
</ul>
</li>
<li>å¤§ä½“é€»è¾‘å¦‚ä¸‹</li>
<li>flat-map-components.png<ul>
<li><img src="/2020/12/01/vue-router-analysis-part2/flat-map-components.png" alt="flat-map-components.png"></li>
</ul>
</li>
<li>æˆ‘ä»¬çœ‹ä¸‹ç®­å¤´å‡½æ•°å†…éƒ¨çš„é€»è¾‘</li>
</ul>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> guards = flatMapComponents(records, (</span><br><span class="line">  def <span class="comment">/*è·¯ç”±ç»„ä»¶å®šä¹‰*/</span>,</span><br><span class="line">  instance <span class="comment">/*router-viewå®ä¾‹*/</span>,</span><br><span class="line">  match <span class="comment">/*è·¯ç”±è®°å½•*/</span>,</span><br><span class="line">  key <span class="comment">/*è§†å›¾å*/</span></span><br><span class="line">) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> guard = extractGuard(def, name) <span class="comment">//Â æå–å‡ºè·¯ç”±ç»„ä»¶ä¸­çš„å®ˆå«å‡½æ•° //Â ä¸ºå®ˆå«ç»‘å®šä¸Šä¸‹æ–‡</span></span><br><span class="line">  <span class="keyword">if</span> (guard) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">Array</span>.isArray(guard)</span><br><span class="line">      ? guard.map(<span class="function">(<span class="params">guard</span>) =&gt;</span> bind(guard, instance, match, key))</span><br><span class="line">      : bind(guard, instance, match, key)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<ul>
<li>é¦–å…ˆè°ƒç”¨<code>extractGuard</code>ä»è·¯ç”±ç»„ä»¶å®šä¹‰ä¸­ç›´æ¥æŠ½å–å‡ºå¯¹åº”<code>name</code>çš„å®ˆå«å‡½æ•°</li>
<li>æ¥ä¸‹æ¥è°ƒç”¨ä¼ å…¥<code>extractGuards</code>çš„<code>bind</code>æ–¹æ³•ä¸ºå®ˆå«ç»‘å®šä¸Šä¸‹æ–‡</li>
<li>æˆ‘ä»¬çœ‹ä¸‹<code>extractGuard</code>å®ç°</li>
</ul>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/base.js</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//Â æå–å•ä¸ªå®ˆå«</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">extractGuard</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  def: <span class="built_in">Object</span> | <span class="built_in">Function</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">  key: <span class="built_in">string</span></span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">NavigationGuard</span> | <span class="title">Array</span>&lt;<span class="title">NavigationGuard</span>&gt; </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> def !== <span class="string">'function'</span>) &#123;</span><br><span class="line">    <span class="comment">//Â extendÂ nowÂ soÂ thatÂ globalÂ mixinsÂ areÂ applied.</span></span><br><span class="line">    def = _Vue.extend(def)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> def.options[key]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>ä¸»è¦æœ‰ä¸¤ä¸ªé€»è¾‘<ul>
<li>è°ƒç”¨<code>extend</code>ä»¥åº”ç”¨å…¨å±€ mixins</li>
<li>è¿”å›å¯¹åº”å®ˆå«å‡½æ•°</li>
</ul>
</li>
<li>æå–å®Œå•ä¸ªå®ˆå«åï¼Œå°±éœ€è¦è°ƒç”¨ä¼ å…¥çš„<code>bind</code>æ–¹æ³•å¯¹å…¶ç»‘å®šä¸Šä¸‹æ–‡ï¼›</li>
<li><code>bind</code>æ–¹æ³•å…¶å®æ˜¯<code>bindGuard</code></li>
</ul>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/history/base.js</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//Â å°†å®ˆå«çš„ä¸Šä¸‹æ–‡ç»‘å®šåˆ°vueå®ä¾‹(è·¯ç”±ç»„ä»¶)</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">bindGuard</span>(<span class="params">guard: NavigationGuard, instance: ?_Vue</span>): ?<span class="title">NavigationGuard</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (instance) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> /*å·²ç»ç»‘å®šè¿‡ä¸Šä¸‹æ–‡çš„å®ˆå«å‡½æ•°*/ <span class="title">boundRouteGuard</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> guard.apply(instance, <span class="built_in">arguments</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>ç»è¿‡ä¸Šé¢çš„ä¸Šä¸‹æ–‡ç»‘å®šï¼Œä»è·¯ç”±ç»„ä»¶ä¸­æŠ½å–å‡ºçš„å®ˆå«å‡½æ•°å°±åˆå›æ¥åˆ°è·¯ç”±ç»„ä»¶ä¸Šä¸‹æ–‡ä¸­æ‰§è¡Œäº†ï¼Œè¿™æ ·å°±ä¿è¯äº†å®ˆå«å‡½æ•°æ— è®ºåœ¨ä½•å¤„è¢«è°ƒç”¨ï¼Œéƒ½èƒ½è¿”å›æ­£ç¡®çš„ç»“æœ</li>
<li>å°ç»“</li>
<li><code>extractGuards</code>ä¸»è¦å®Œæˆäº†ä»è·¯ç”±ç»„ä»¶ä¸­æŠ½å–å®ˆå«å‡½æ•°å¹¶ä¸ºå…¶ç»‘å®šä¸Šä¸‹æ–‡çš„å·¥ä½œ</li>
<li>extract-guards.png<ul>
<li><img src="/2020/12/01/vue-router-analysis-part2/extract-guards.png" alt="extract-guards.png"></li>
</ul>
</li>
<li>æ¥ä¸‹æ¥æˆ‘ä»¬è¦å¯¹æ¿€æ´»çš„è·¯ç”±è®°å½•è¿›è¡Œå¼‚æ­¥ç»„ä»¶çš„è§£æ</li>
<li>ä¸»è¦é€šè¿‡<code>resolveAsyncComponents</code>æ–¹æ³•å®ç°çš„</li>
</ul>
<h4 id="resolveAsyncComponents"><a href="#resolveAsyncComponents" class="headerlink" title="resolveAsyncComponents"></a>resolveAsyncComponents</h4><ul>
<li>åœ¨çœ‹å¦‚ä½•è§£æå¼‚æ­¥ç»„ä»¶å‰ï¼Œæˆ‘ä»¬å…ˆçœ‹ä¸‹<code>vue</code>ä¸­çš„å¼‚æ­¥ç»„ä»¶é•¿ä»€ä¹ˆæ ·ï¼Ÿ</li>
</ul>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// https://cn.vuejs.org/v2/guide/components-dynamic-async.html#å¼‚æ­¥ç»„ä»¶</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//Â æ¥æ”¶resolve,reject</span></span><br><span class="line">Vue.component(<span class="string">'async-example'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">resolve, reject</span>) </span>&#123;</span><br><span class="line">  setTimeout(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="comment">//Â å‘Â `resolve`Â å›è°ƒä¼ é€’ç»„ä»¶å®šä¹‰</span></span><br><span class="line">    resolve(&#123;</span><br><span class="line">      template: <span class="string">'&lt;div&gt;IÂ amÂ async!&lt;/div&gt;'</span>,</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;, <span class="number">1000</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">//Â ç»“åˆrequireä½¿ç”¨</span></span><br><span class="line">Vue.component(<span class="string">'async-webpack-example'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">resolve</span>) </span>&#123;</span><br><span class="line">  <span class="comment">//Â è¿™ä¸ªç‰¹æ®Šçš„Â `require`Â è¯­æ³•å°†ä¼šå‘Šè¯‰Â webpack</span></span><br><span class="line">  <span class="comment">//Â è‡ªåŠ¨å°†ä½ çš„æ„å»ºä»£ç åˆ‡å‰²æˆå¤šä¸ªåŒ…ï¼Œè¿™äº›åŒ…</span></span><br><span class="line">  <span class="comment">//Â ä¼šé€šè¿‡Â AjaxÂ è¯·æ±‚åŠ è½½</span></span><br><span class="line">  <span class="built_in">require</span>([<span class="string">'./my-async-component'</span>], resolve)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">//Â ç»“åˆimport()ä½¿ç”¨</span></span><br><span class="line">Vue.component(</span><br><span class="line">  <span class="string">'async-webpack-example'</span>, <span class="comment">//Â è¿™ä¸ªåŠ¨æ€å¯¼å…¥ä¼šè¿”å›ä¸€ä¸ªÂ `Promise`Â å¯¹è±¡ã€‚</span></span><br><span class="line">  () =&gt; <span class="keyword">import</span>(<span class="string">'./my-async-component'</span>)</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">//Â å±€éƒ¨æ³¨å†Œ</span></span><br><span class="line"><span class="keyword">new</span> Vue(&#123;</span><br><span class="line">  <span class="comment">//Â ...</span></span><br><span class="line">  components: &#123;</span><br><span class="line">    <span class="string">'my-component'</span>: <span class="function"><span class="params">()</span> =&gt;</span> <span class="keyword">import</span>(<span class="string">'./my-async-component'</span>),</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">//Â å¸¦æœ‰åŠ è½½çŠ¶æ€</span></span><br><span class="line"><span class="keyword">const</span> AsyncComponent = <span class="function"><span class="params">()</span> =&gt;</span> (&#123;</span><br><span class="line">  <span class="comment">//Â éœ€è¦åŠ è½½çš„ç»„ä»¶Â (åº”è¯¥æ˜¯ä¸€ä¸ªÂ `Promise`Â å¯¹è±¡)</span></span><br><span class="line">  component: <span class="keyword">import</span>(<span class="string">'./MyComponent.vue'</span>), <span class="comment">//Â å¼‚æ­¥ç»„ä»¶åŠ è½½æ—¶ä½¿ç”¨çš„ç»„ä»¶</span></span><br><span class="line">  loading: LoadingComponent, <span class="comment">//Â åŠ è½½å¤±è´¥æ—¶ä½¿ç”¨çš„ç»„ä»¶</span></span><br><span class="line">  error: ErrorComponent, <span class="comment">//Â å±•ç¤ºåŠ è½½æ—¶ç»„ä»¶çš„å»¶æ—¶æ—¶é—´ã€‚é»˜è®¤å€¼æ˜¯Â 200Â (æ¯«ç§’)</span></span><br><span class="line">  delay: <span class="number">200</span>, <span class="comment">//Â å¦‚æœæä¾›äº†è¶…æ—¶æ—¶é—´ä¸”ç»„ä»¶åŠ è½½ä¹Ÿè¶…æ—¶äº†ï¼Œ //Â åˆ™ä½¿ç”¨åŠ è½½å¤±è´¥æ—¶ä½¿ç”¨çš„ç»„ä»¶ã€‚é»˜è®¤å€¼æ˜¯ï¼š`Infinity`</span></span><br><span class="line">  timeout: <span class="number">3000</span>,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<ul>
<li>æ–‡æ¡£å¯¹å¼‚æ­¥ç»„ä»¶çš„æè¿°æ˜¯<code>Vue å…è®¸ä½ ä»¥ä¸€ä¸ªå·¥å‚å‡½æ•°çš„æ–¹å¼å®šä¹‰ä½ çš„ç»„ä»¶ï¼Œè¿™ä¸ªå·¥å‚å‡½æ•°ä¼šå¼‚æ­¥è§£æä½ çš„ç»„ä»¶å®šä¹‰</code></li>
<li>å¯ä»¥ç†è§£ä¸ºï¼šå¼‚æ­¥ç»„ä»¶æ˜¯ä¸€ä¸ªå·¥å‚å‡½æ•°ï¼Œå‡½æ•°å†…<code>resolveã€reject</code>ç»„ä»¶çš„å®šä¹‰ã€è¿”å›ä¸€ä¸ª<code>Promise</code>ã€è¿”å›ä¸€ä¸ªå¸¦æœ‰ç‰¹å®šæ ‡è¯†å­—æ®µçš„å¯¹è±¡</li>
<li>è§£æè·¯ç”±è®°å½•ä¸­çš„å¼‚æ­¥ç»„ä»¶ä»£ç ä½äº<code>src/util/resolve-components.js</code></li>
</ul>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/util/resolve-components.js</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//Â è§£æå¼‚æ­¥ç»„ä»¶ï¼Œè¿”å›ä¸€ä¸ªæ¥æ”¶to,Â from,Â nextå‚æ•°çš„å‡½æ•°</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">resolveAsyncComponents</span>(<span class="params">matched: <span class="built_in">Array</span>&lt;RouteRecord&gt;</span>): <span class="title">Function</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="function">(<span class="params">to, <span class="keyword">from</span>, next</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> hasAsync = <span class="literal">false</span></span><br><span class="line">    <span class="keyword">let</span> pending = <span class="number">0</span></span><br><span class="line">    <span class="keyword">let</span> error = <span class="literal">null</span></span><br><span class="line">    flatMapComponents(matched, (</span><br><span class="line">      <span class="comment">/*è·¯ç”±ç»„ä»¶å®šä¹‰*/</span> def,</span><br><span class="line">      <span class="comment">/*router-viewå®ä¾‹*/</span> _,</span><br><span class="line">      <span class="comment">/*è·¯ç”±è®°å½•*/</span> match,</span><br><span class="line">      <span class="comment">/*è§†å›¾å*/</span> key</span><br><span class="line">    ) =&gt; &#123;</span><br><span class="line">      <span class="comment">//Â ifÂ it'sÂ aÂ functionÂ andÂ doesn'tÂ haveÂ cidÂ attached,</span></span><br><span class="line">      <span class="comment">//Â assumeÂ it'sÂ anÂ asyncÂ componentÂ resolveÂ function.</span></span><br><span class="line">      <span class="comment">//Â weÂ areÂ notÂ usingÂ Vue'sÂ defaultÂ asyncÂ resolvingÂ mechanismÂ because</span></span><br><span class="line">      <span class="comment">//Â weÂ wantÂ toÂ haltÂ theÂ navigationÂ untilÂ theÂ incomingÂ componentÂ hasÂ been</span></span><br><span class="line">      <span class="comment">//Â resolved.</span></span><br><span class="line">      <span class="comment">//Â def.cidä¸ºå®ä¾‹æ„é€ å‡½æ•°æ ‡è¯†ï¼›https://github.com/vuejs/vue/search?q=cid&amp;unscoped_q=cid</span></span><br><span class="line">      <span class="comment">//Â ç»„ä»¶çš„å®šä¹‰æ˜¯å‡½æ•°ä¸”ç»„ä»¶cidè¿˜æœªè®¾ç½®ï¼Œåˆ™è®¤ä¸ºå…¶æ˜¯ä¸€ä¸ªå¼‚æ­¥ç»„ä»¶</span></span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">typeof</span> def === <span class="string">'function'</span> &amp;&amp; def.cid === <span class="literal">undefined</span>) &#123;</span><br><span class="line">        hasAsync = <span class="literal">true</span></span><br><span class="line">        pending++ <span class="comment">//Â è§£æ</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> resolve = once(<span class="function">(<span class="params">resolvedDef</span>) =&gt;</span> &#123;</span><br><span class="line">          <span class="comment">//Â åŠ è½½åçš„ç»„ä»¶å®šä¹‰æ˜¯ä¸€ä¸ªesm</span></span><br><span class="line">          <span class="keyword">if</span> (isESModule(resolvedDef)) &#123;</span><br><span class="line">            resolvedDef = resolvedDef.default</span><br><span class="line">          &#125; <span class="comment">//Â saveÂ resolvedÂ onÂ asyncÂ factoryÂ inÂ caseÂ it'sÂ usedÂ elsewhere //Â ä¿ç•™å¼‚æ­¥ç»„ä»¶å·¥å‚å‡½æ•°ï¼Œæ–¹ä¾¿åç»­ä½¿ç”¨</span></span><br><span class="line">          def.resolved =</span><br><span class="line">            <span class="keyword">typeof</span> resolvedDef === <span class="string">'function'</span></span><br><span class="line">              ? resolvedDef</span><br><span class="line">              : _Vue.extend(resolvedDef)</span><br><span class="line">          match.components[key] = resolvedDef <span class="comment">//Â æ›¿æ¢è·¯ç”±è®°å½•çš„å‘½åè§†å›¾ä¸­çš„ç»„ä»¶</span></span><br><span class="line">          pending--</span><br><span class="line">          <span class="keyword">if</span> (pending &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">//Â æ‰€æœ‰å¼‚æ­¥ç»„ä»¶åŠ è½½å®Œ</span></span><br><span class="line">            next()</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;) <span class="comment">//Â æŠ¥é”™</span></span><br><span class="line">        <span class="keyword">const</span> reject = once(<span class="function">(<span class="params">reason</span>) =&gt;</span> &#123;</span><br><span class="line">          <span class="keyword">const</span> msg = <span class="string">`FailedÂ toÂ resolveÂ asyncÂ componentÂ <span class="subst">$&#123;key&#125;</span>:Â <span class="subst">$&#123;reason&#125;</span>`</span></span><br><span class="line">          process.env.NODE_ENV !== <span class="string">'production'</span> &amp;&amp; warn(<span class="literal">false</span>, msg)</span><br><span class="line">          <span class="keyword">if</span> (!error) &#123;</span><br><span class="line">            error = isError(reason) ? reason : <span class="keyword">new</span> <span class="built_in">Error</span>(msg)</span><br><span class="line">            next(error)</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;) <span class="comment">//Â å¼‚æ­¥ç»„ä»¶ï¼Œhttps://cn.vuejs.org/v2/guide/components-dynamic-async.html#å¼‚æ­¥ç»„ä»¶</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> res</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">          res = def(resolve, reject) <span class="comment">//Â è¿”å›promise</span></span><br><span class="line">        &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">          reject(e)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (res) &#123;</span><br><span class="line">          <span class="keyword">if</span> (<span class="keyword">typeof</span> res.then === <span class="string">'function'</span>) &#123;</span><br><span class="line">            res.then(resolve, reject)</span><br><span class="line">          &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//Â newÂ syntaxÂ inÂ VueÂ 2.3</span></span><br><span class="line">            <span class="comment">//Â å¤„ç†åŠ è½½çŠ¶æ€ï¼Œè¿”å›ä¸€ä¸ªåŒ…å¯¹è±¡ï¼›https://cn.vuejs.org/v2/guide/components-dynamic-async.html#å¤„ç†åŠ è½½çŠ¶æ€</span></span><br><span class="line">            <span class="keyword">const</span> comp = res.component <span class="comment">//Â æ˜¯é€šè¿‡import()åŠ è½½ï¼Œè¿”å›çš„æ˜¯ä¸€ä¸ªpromise</span></span><br><span class="line">            <span class="keyword">if</span> (comp &amp;&amp; <span class="keyword">typeof</span> comp.then === <span class="string">'function'</span>) &#123;</span><br><span class="line">              comp.then(resolve, reject)</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;) <span class="comment">//Â æ²¡æœ‰å¼‚æ­¥ç»„ä»¶ï¼Œç›´æ¥next</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!hasAsync) next()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>å¯ä»¥çœ‹åˆ°å…¶æ¥æ”¶ä¸€ä¸ªè·¯ç”±è®°å½•æ•°ç»„<code>matched</code>ï¼Œè¿”å›ä¸€ä¸ªæ¥æ”¶<code>fromã€toã€next</code>çš„å‡½æ•°ï¼Œå†…éƒ¨æ˜¯å¼‚æ­¥ç»„ä»¶çš„è§£æé€»è¾‘</li>
<li><code>resolveAsyncComponents</code>è¢«è°ƒç”¨æ—¶å¹¶ä¸ä¼šæ‰§è¡Œè§£æå¼‚æ­¥ç»„ä»¶çš„é€»è¾‘ï¼Œå› ä¸ºå…¶åªä¼šè¿”å›ä¸€ä¸ªå‡½æ•°ï¼Œè¿”å›çš„å‡½æ•°ä¼šåœ¨è¿è¡Œé˜Ÿåˆ—æ—¶æ‰ä¼šè¢«è°ƒç”¨ï¼Œè¿™æ—¶æ‰ä¼šè§£æå¼‚æ­¥ç»„ä»¶</li>
<li>é˜Ÿåˆ—çš„è¿è¡Œï¼Œæˆ‘ä»¬åé¢å†çœ‹ï¼Œæˆ‘ä»¬å…ˆçœ‹ä¸‹è¿”å›çš„å‡½æ•°å†…éƒ¨æ˜¯ä»€ä¹ˆé€»è¾‘<ul>
<li>å®šä¹‰äº†ä¸€ä¸ªæ˜¯å¦æœ‰å¼‚æ­¥ç»„ä»¶çš„æ ‡è¯†å­—æ®µ<code>hasAsync</code>ã€ä»¥åŠå½“å‰å¾…è§£æçš„å¼‚æ­¥ç»„ä»¶æ•°é‡<code>pending</code></li>
<li>ç„¶åè°ƒç”¨äº†<code>flatMapComponents</code>æ‹¿åˆ°<code>records</code>ä¸­çš„æ‰€æœ‰è·¯ç”±ç»„ä»¶ï¼Œå¹¶ä¾æ¬¡è°ƒç”¨ä¼ å…¥çš„å›è°ƒæ–¹æ³•</li>
<li>å›è°ƒæ–¹æ³•ä¼šæ¥æ”¶åˆ°è¢«éå†çš„è·¯ç”±ç»„ä»¶ï¼Œæ­¤æ—¶éœ€è¦åˆ¤æ–­è¿™ä¸ªè·¯ç”±ç»„ä»¶æ˜¯å¦æ˜¯å¼‚æ­¥ç»„ä»¶ï¼Œå¦‚æœæ˜¯ï¼Œåˆ™å¼€å§‹å¼‚æ­¥ç»„ä»¶çš„è§£æï¼Œå¦åˆ™è·³è¿‡</li>
<li>å¦‚æœéå†ç»“æŸå‘ç°<code>hasAsync</code>ä»ç„¶ä¸º<code>false</code>ï¼Œä»£è¡¨æ²¡æœ‰å¼‚æ­¥ç»„ä»¶ç›´æ¥<code>next()</code>è¿›è¡Œä¸‹ä¸€æ­¥å³å¯</li>
</ul>
</li>
<li>å¦‚ä½•ç¡®å®šæŸä¸ªç»„ä»¶æ˜¯å¦æ˜¯å¼‚æ­¥ç»„ä»¶å‘¢ï¼Ÿ<ul>
<li>å‰é¢æˆ‘ä»¬è¯´è¿‡ï¼Œåœ¨<code>vue</code>ä¸­å¼‚æ­¥ç»„ä»¶ä¸€å®šæ˜¯ä¸ªå·¥å‚å‡½æ•°ï¼Œå†…éƒ¨ä¼šè°ƒç”¨<code>resoveã€reject</code>æˆ–è¿”å›<code>Promise</code>æˆ–è¿”å›ç‰¹å®šæ ¼å¼å¯¹è±¡ï¼Œæ€»ä¹‹ä»–è‚¯å®šæ˜¯ä¸ªå‡½æ•°</li>
<li>å…¶æ¬¡<code>vue</code>ä¸­æ¯ä¸ªå®ä¾‹éƒ½ä¼šæœ‰ä¸ªå”¯ä¸€æ ‡è¯†<code>cid</code>ï¼Œå¦‚æœæœ‰<code>cid</code>å°±ä»£è¡¨å·²ç»ç”Ÿæˆç›¸åº”å®ä¾‹ï¼Œæ‰€ä»¥å¼‚æ­¥ç»„ä»¶çš„<code>cid</code>ä¸€å®šä¸º<code>undefined</code></li>
<li>æ‰€ä»¥åˆ¤æ–­æ˜¯å¦æ˜¯å¼‚æ­¥ç»„ä»¶çš„ä¾æ®å°±æ˜¯ <code>å‡½æ•° &amp;&amp; cid === &#39;undefined&#39;</code></li>
</ul>
</li>
<li>å¦‚æœåˆ¤æ–­æ˜¯å¼‚æ­¥ç»„ä»¶ï¼Œåˆ™å°†<code>hasAsync</code>ç½®ä¸º<code>true</code>å¹¶è®©<code>pending</code>è‡ªå¢ï¼Œä»£è¡¨æœ‰å‘ç°å¼‚æ­¥ç»„ä»¶ï¼Œåœ¨è§£æå®Œç»„ä»¶å<code>pending</code>è‡ªå‡ï¼Œå½“<code>pending&lt;=0</code>åˆ™ä»£è¡¨å¼‚æ­¥ç»„ä»¶è§£æç»“æŸï¼Œå¯ä»¥è°ƒç”¨<code>next</code>è¿›è¡Œä¸‹ä¸€æ­¥</li>
<li>å‰é¢æè¿‡ï¼Œ<code>vue</code>çš„å¼‚æ­¥ç»„ä»¶å·¥å‚å‡½æ•°ä¼šæ¥æ”¶<code>resolveã€reject</code>ä¸¤ä¸ªæ–¹æ³•å¹¶åœ¨ä»æœåŠ¡å™¨å¾—åˆ°ç»„ä»¶å®šä¹‰åè¢«è°ƒç”¨ï¼›</li>
<li>åœ¨æ¥æ”¶åˆ°æœåŠ¡å™¨è¿”å›å¼‚æ­¥ç»„ä»¶çš„å®šä¹‰æ—¶ï¼Œè¿™ä¸¤ä¸ªæ–¹æ³•ä¼šè¢«ä¼ å…¥å¼‚æ­¥ç»„ä»¶å·¥å‚å‡½æ•°</li>
<li>ç”±äºå¼‚æ­¥ç»„ä»¶å·¥å‚å‡½æ•°ä¼šè¿”å›ä¸€ä¸ª<code>Promise</code>å‡½æ•°æˆ–ç‰¹å®šæ ¼å¼çš„å¯¹è±¡ï¼Œæ‰€ä»¥ä¼šæœ‰ä¸‹é¢æƒ…å†µ<ul>
<li>å¦‚æœæ˜¯è¿”å›<code>Promise</code>ï¼Œåˆ™å°†è¿™ä¸¤æ–¹æ³•å†ä¼ å…¥è¿”å›çš„<code>Promise.then</code>ä¸­</li>
<li>å¦‚æœè¿”å›ç‰¹å®šæ ¼å¼å¯¹è±¡ï¼Œåˆ™æ‰¾åˆ°<code>component</code>å­—æ®µï¼Œå¹¶å°†è¿™ä¸¤æ–¹æ³•å†ä¼ å…¥<code>component.then</code>ä¸­</li>
</ul>
</li>
<li>ç”±äº<code>resolveã€reject</code>å·²ç»è¢«<code>once</code>åŒ…è£…ï¼Œå³ä½¿ä¼ å…¥å¤šæ¬¡ï¼Œä¹Ÿåªä¼šè¢«æ‰§è¡Œä¸€æ¬¡</li>
<li>æˆ‘ä»¬çœ‹ä¸‹<code>resolveã€reject</code>æ–¹æ³•</li>
<li>ä»–ä»¬éƒ½è¢«ä¸€ä¸ª<code>once</code>æ–¹æ³•åŒ…è£¹ä»¥ä¿è¯åªä¼šè¢«æ‰§è¡Œä¸€æ¬¡</li>
<li><code>reject</code><ul>
<li>ç›´æ¥æŠ›å‡ºä¸€ä¸ªé”™è¯¯å¹¶è°ƒç”¨<code>next</code>ä¼ é€’åˆ°ä¸‹ä¸€æµç¨‹</li>
</ul>
</li>
<li><code>resolve</code><ul>
<li>å…ˆåˆ¤æ–­ä¸‹æ˜¯å¦æ˜¯<code>esm</code>ï¼Œè‹¥æ˜¯ï¼Œåˆ™å–å…¶<code>.default</code>å­—æ®µæ¥è·å–ç»„ä»¶å®šä¹‰</li>
<li>æ‹¿åˆ°ç»„ä»¶å®šä¹‰åï¼Œä¼šå…ˆä¿ç•™å¼‚æ­¥ç»„ä»¶å·¥å‚å‡½æ•°ï¼Œæ–¹ä¾¿åç»­ä½¿ç”¨</li>
<li>ç„¶åæ›¿æ¢è·¯ç”±è®°å½•çš„å‘½åè§†å›¾ä¸­çš„å¯¹åº”ç»„ä»¶ï¼Œè¿™å°±å®Œæˆäº†ç»„ä»¶çš„è§£æå¹¶ç»‘å®šåˆ°è·¯ç”±è®°å½•ä¸Š</li>
</ul>
</li>
<li>å†æ¬¡é‡ç”³ä¸Šé¢æåˆ°çš„é€»è¾‘éƒ½æ˜¯<code>resolveAsyncComponents</code>è¿”å›çš„å‡½æ•°é€»è¾‘ï¼Œè¿™ä¸ªå‡½æ•°é€»è¾‘ä¼šç­‰åˆ°é˜Ÿåˆ—è¢«æ‰§è¡Œæ—¶æ‰å®é™…è°ƒç”¨</li>
<li>è‡³æ­¤ï¼Œæˆ‘ä»¬çš„é˜Ÿåˆ—<code>queue</code>å·²ç»åŒ…å«äº†æŠ½å–å‡ºæ¥çš„<code>å®ˆå«ã€é’©å­ã€åŒ…å«è§£æå¼‚æ­¥ç»„ä»¶é€»è¾‘çš„å‡½æ•°</code></li>
<li>é˜Ÿåˆ—å·²ç»æ„å»ºå®Œæˆï¼Œä¸‹é¢æˆ‘ä»¬æ¥çœ‹çœ‹å®ƒæ˜¯å¦‚ä½•æ‰§è¡Œçš„</li>
</ul>
<h3 id="å®ˆå«é˜Ÿåˆ—çš„æ‰§è¡Œ"><a href="#å®ˆå«é˜Ÿåˆ—çš„æ‰§è¡Œ" class="headerlink" title="å®ˆå«é˜Ÿåˆ—çš„æ‰§è¡Œ"></a>å®ˆå«é˜Ÿåˆ—çš„æ‰§è¡Œ</h3><ul>
<li>é˜Ÿåˆ—çš„æ‰§è¡Œæ˜¯é€šè¿‡<code>runQueueã€iterator</code>ç›¸äº’é…åˆæ¥å®ç°çš„</li>
</ul>
<h4 id="runQueue"><a href="#runQueue" class="headerlink" title="runQueue"></a>runQueue</h4><ul>
<li><code>runQueue</code>æ–¹æ³•ä½äº<code>src/util/async.js</code></li>
</ul>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/util/async.js</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*Â @flowÂ */</span></span><br><span class="line"><span class="comment">//Â é˜Ÿåˆ—æ‰§è¡Œå‡½æ•°</span></span><br><span class="line"><span class="comment">//Â queueÂ éœ€è¦æ‰§è¡Œçš„é˜Ÿåˆ—</span></span><br><span class="line"><span class="comment">//Â fnÂ è¿­ä»£å‡½æ•°</span></span><br><span class="line"><span class="comment">//Â cbÂ å›è°ƒå‡½æ•°</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">runQueue</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  queue: <span class="built_in">Array</span>&lt;?NavigationGuard&gt;,</span></span></span><br><span class="line"><span class="function"><span class="params">  fn: <span class="built_in">Function</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">  cb: <span class="built_in">Function</span></span></span></span><br><span class="line"><span class="function"><span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> step = <span class="function">(<span class="params">index</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">//Â å…¨éƒ¨æ‰§è¡Œå®Œï¼Œæ‰§è¡Œå›è°ƒ</span></span><br><span class="line">    <span class="keyword">if</span> (index &gt;= queue.length) &#123;</span><br><span class="line">      cb()</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">//Â å­˜åœ¨ï¼Œæ‰§è¡Œè¿­ä»£å‡½æ•°</span></span><br><span class="line">      <span class="keyword">if</span> (queue[index]) &#123;</span><br><span class="line">        fn(</span><br><span class="line">          queue[index],</span><br><span class="line">          <span class="comment">/*Â next*/</span> () =&gt; &#123;</span><br><span class="line">            step(index + <span class="number">1</span>)</span><br><span class="line">          &#125;</span><br><span class="line">        )</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//Â å¦åˆ™ï¼Œè·³åˆ°ä¸‹ä¸ªæ‰§è¡Œ</span></span><br><span class="line">        step(index + <span class="number">1</span>)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  step(<span class="number">0</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>å¯ä»¥çœ‹åˆ°å®ƒæ¥æ”¶ä¸€ä¸ªé˜Ÿåˆ—<code>queue</code>ã€ä¸€ä¸ªè¿­ä»£å‡½æ•°<code>fn</code>ã€ä¸€ä¸ªæ‰§è¡Œå®Œæ¯•çš„å›è°ƒå‡½æ•°<code>cb</code></li>
<li>å†…éƒ¨æ˜¯ä¸€ä¸ªé€’å½’çš„å®ç°</li>
<li>å®šä¹‰äº†ä¸€ä¸ª<code>step</code>å‡½æ•°å¹¶æ¥æ”¶ä¸€ä¸ªæ ‡è¯†é˜Ÿåˆ—æ‰§è¡Œæ­¥éª¤çš„<code>index</code></li>
<li>å¿…é¡»é€šè¿‡æ‰‹åŠ¨è°ƒç”¨<code>step</code>æ‰èƒ½è·³åˆ°ä¸‹ä¸€ä¸ªé˜Ÿåˆ—é¡¹çš„æ‰§è¡Œ<ul>
<li>åœ¨è§£æç»„ä»¶æ—¶ä¼šç”¨åˆ°</li>
</ul>
</li>
<li>å½“<code>index</code>å¤§äºç­‰äºé˜Ÿåˆ—çš„é•¿åº¦æ—¶(é€’å½’çš„ç»“æŸæ¡ä»¶)ï¼Œä»£è¡¨é˜Ÿåˆ—é¡¹å…¨æ‰§è¡Œå®Œæ¯•ï¼Œå¯ä»¥è°ƒç”¨<code>cb</code></li>
<li>å¦åˆ™ï¼Œè‹¥è¿˜æœ‰é˜Ÿåˆ—é¡¹ï¼Œåˆ™ç»§ç»­è°ƒç”¨è¿­ä»£å‡½æ•°<code>fn</code>å¹¶ä¼ å…¥é˜Ÿåˆ—é¡¹å’Œè·³è½¬ä¸‹ä¸ªé˜Ÿåˆ—é¡¹çš„<code>step(index + 1)</code>å‡½æ•°</li>
<li>è‹¥æ— é˜Ÿåˆ—é¡¹äº†ï¼Œåˆ™ç›´æ¥è·³åˆ°ä¸‹ä¸ªé˜Ÿåˆ—é¡¹çš„æ‰§è¡Œ</li>
<li>é€’å½’é€šè¿‡<code>step(0)</code>æ¥æ¿€æ´»</li>
</ul>
<h4 id="iterator"><a href="#iterator" class="headerlink" title="iterator"></a>iterator</h4><ul>
<li>è¿­ä»£å™¨ç›¸å…³ä»£ç å¥½ä¸‹</li>
</ul>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/history/base.js</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//Â è¿­ä»£å‡½æ•°</span></span><br><span class="line"><span class="keyword">const</span> iterator = <span class="function">(<span class="params">hook: NavigationGuard, next</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">this</span>.pending !== route) &#123;</span><br><span class="line">    <span class="comment">//Â å½“å‘ç°toå‘ç”Ÿå˜åŒ–ï¼Œåˆ™ä»£è¡¨éœ€è¦å–æ¶ˆ</span></span><br><span class="line">    <span class="keyword">return</span> abort()</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    hook(</span><br><span class="line">      <span class="comment">/*Â to*/</span> route,</span><br><span class="line">      <span class="comment">/*Â from*/</span> current,</span><br><span class="line">      <span class="comment">/*Â next*/</span> (to: <span class="built_in">any</span>) =&gt; &#123;</span><br><span class="line">        <span class="keyword">if</span> (to === <span class="literal">false</span> || isError(to)) &#123;</span><br><span class="line">          <span class="comment">//Â next(false)Â -&gt;Â abortÂ navigation,Â ensureÂ currentÂ URL</span></span><br><span class="line">          <span class="comment">//Â next(false)Â -&gt;Â å–æ¶ˆè·³è½¬ï¼Œæ·»åŠ ä¸€ä¸ªæ–°å†å²è®°å½•(ä½†ç”±äºurlåœ°å€æœªå‘ç”Ÿå˜åŒ–ï¼Œæ‰€ä»¥å¹¶æœªæ·»åŠ è®°å½•)</span></span><br><span class="line">          <span class="keyword">this</span>.ensureURL(<span class="literal">true</span>)</span><br><span class="line">          abort(to)</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (</span><br><span class="line">          <span class="keyword">typeof</span> to === <span class="string">'string'</span> || <span class="comment">//Â next('/')</span></span><br><span class="line">          (<span class="keyword">typeof</span> to === <span class="string">'object'</span> &amp;&amp;</span><br><span class="line">            (<span class="keyword">typeof</span> to.path === <span class="string">'string'</span> || <span class="keyword">typeof</span> to.name === <span class="string">'string'</span>))</span><br><span class="line">        ) &#123;</span><br><span class="line">          <span class="comment">//Â next(&#123;path:'/'&#125;)æˆ–next(&#123;name:'Home'&#125;)</span></span><br><span class="line">          <span class="comment">//Â next('/')Â orÂ next(&#123;Â path:Â '/'Â &#125;)Â -&gt;Â redirect</span></span><br><span class="line">          abort() <span class="comment">//Â å–æ¶ˆå½“å‰</span></span><br><span class="line">          <span class="keyword">if</span> (<span class="keyword">typeof</span> to === <span class="string">'object'</span> &amp;&amp; to.replace) &#123;</span><br><span class="line">            <span class="comment">//Â è°ƒç”¨å­ç±»æ–¹æ³•çš„æ›¿æ¢è®°å½•</span></span><br><span class="line">            <span class="keyword">this</span>.replace(to)</span><br><span class="line">          &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//Â è°ƒç”¨å­ç±»æ–¹æ³•çš„æ·»åŠ è®°å½•</span></span><br><span class="line">            <span class="keyword">this</span>.push(to)</span><br><span class="line">          &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="comment">//Â confirmÂ transitionÂ andÂ passÂ onÂ theÂ value</span></span><br><span class="line">          <span class="comment">//Â next()</span></span><br><span class="line">          next(to)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    )</span><br><span class="line">  &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">    abort(e)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>å¯ä»¥çœ‹åˆ°å…¶æ¥æ”¶ä¸€ä¸ª<code>hook</code>ä¹Ÿå°±æ˜¯å®ˆå«é˜Ÿåˆ—ä¸­çš„å®ˆå«ã€é’©å­å‡½æ•°å’Œ<code>next</code>å‡½æ•°(<code>runQueueä¼ é€’è¿‡æ¥çš„stepå‡½æ•°</code>)</li>
<li>å½“åœ¨æ‰§è¡Œçš„è¿‡ç¨‹ä¸­ï¼Œè·¯ç”±å‘ç”Ÿå˜åŒ–ï¼Œä¼šç«‹å³å–æ¶ˆ</li>
<li>ç„¶åå°è¯•è°ƒç”¨<code>hook</code>ï¼Œå¹¶ä¼ å…¥ç›®æ ‡è·¯ç”±å¯¹è±¡ã€å½“å‰è·¯ç”±å¯¹è±¡ã€ä»¥åŠä¸€ä¸ªæ¥æ”¶<code>to</code>çš„ç®­å¤´å‡½æ•°</li>
<li>å…¶å®è¿™ä¸‰ä¸ªå‚æ•°å°±å¯¹åº”å®ˆå«ä¼šæ¥æ”¶åˆ°çš„<code>fromã€toã€next</code>ä¸‰ä¸ªå‚æ•°</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">router.beforeEach(<span class="function">(<span class="params">to, <span class="keyword">from</span>, next</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<ul>
<li>æˆ‘ä»¬çŸ¥é“å®ˆå«çš„<code>next</code>æ˜¯ä¸€ä¸ª<code>function</code>ï¼Œå¹¶èƒ½æ¥æ”¶ä¸‹é¢å‡ ç§å‚æ•°ä»¥æ»¡è¶³ä¸åŒçš„è·¯ç”±è·³è½¬éœ€æ±‚<ul>
<li><code>next()</code>: è¿›è¡Œç®¡é“ä¸­çš„ä¸‹ä¸€ä¸ªé’©å­ã€‚</li>
<li><code>next(false)</code>: ä¸­æ–­å½“å‰çš„å¯¼èˆªã€‚</li>
<li><code>next(&#39;/&#39;)</code>  æˆ–è€…  <code>next({ path: &#39;/&#39; })</code>: è·³è½¬åˆ°ä¸€ä¸ªä¸åŒçš„åœ°å€ã€‚å½“å‰çš„å¯¼èˆªè¢«ä¸­æ–­ï¼Œç„¶åè¿›è¡Œä¸€ä¸ªæ–°çš„å¯¼èˆªã€‚ä½ å¯ä»¥å‘  next  ä¼ é€’ä»»æ„ä½ç½®å¯¹è±¡ï¼Œä¸”å…è®¸è®¾ç½®è¯¸å¦‚  replace: trueã€name: â€˜homeâ€™  ä¹‹ç±»çš„é€‰é¡¹ä»¥åŠä»»ä½•ç”¨åœ¨  router-link  çš„  to prop  æˆ–  router.push  ä¸­çš„é€‰é¡¹ã€‚</li>
<li><code>next(error)</code>: (2.4.0+) å¦‚æœä¼ å…¥  next  çš„å‚æ•°æ˜¯ä¸€ä¸ª  Error  å®ä¾‹ï¼Œåˆ™å¯¼èˆªä¼šè¢«ç»ˆæ­¢ä¸”è¯¥é”™è¯¯ä¼šè¢«ä¼ é€’ç»™  router.onError()  æ³¨å†Œè¿‡çš„å›è°ƒã€‚</li>
</ul>
</li>
<li>ä¸Šé¢æ¥æ”¶<code>to</code>çš„ç®­å¤´å‡½æ•°å°±å¤„ç†äº†ä¸Šè¿°å‡ ç§åœºæ™¯</li>
<li>é˜Ÿåˆ—ä¸­çš„æ¯ä¸€é¡¹éƒ½ä¼šåœ¨<code>iterator</code>ä¸­è¢«è°ƒç”¨ä¸€æ¬¡å¹¶é€šè¿‡<code>next()</code>åˆ°è·³è½¬åˆ°ä¸‹ä¸€ä¸ªé˜Ÿåˆ—é¡¹çš„æ‰§è¡Œ</li>
<li>äº†è§£äº†<code>runQueueã€iterator</code>åï¼Œæˆ‘ä»¬å†æ¥çœ‹çœ‹é˜Ÿåˆ—å®é™…æ‰§è¡Œçš„ä»£ç æ˜¯ä»€ä¹ˆæ ·çš„</li>
</ul>
<h4 id="é˜Ÿåˆ—æ‰§è¡Œ"><a href="#é˜Ÿåˆ—æ‰§è¡Œ" class="headerlink" title="é˜Ÿåˆ—æ‰§è¡Œ"></a>é˜Ÿåˆ—æ‰§è¡Œ</h4><ul>
<li>é˜Ÿåˆ—æ‰§è¡Œçš„å®Œæ•´ä»£ç å¦‚ä¸‹</li>
</ul>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/history/base.js</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//Â æ‰§è¡Œé˜Ÿåˆ—</span></span><br><span class="line">runQueue(</span><br><span class="line">  queue,</span><br><span class="line">  iterator,</span><br><span class="line">  <span class="comment">/*Â æ‰§è¡Œç»“æŸå›è°ƒ*/</span> () =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> postEnterCbs = [] <span class="comment">//Â ä¿å­˜beforeRouteEnterä¸­ä¼ ç»™nextçš„å›è°ƒå‡½æ•°</span></span><br><span class="line">    <span class="keyword">const</span> isValid = <span class="function"><span class="params">()</span> =&gt;</span> <span class="keyword">this</span>.current === route <span class="comment">//Â è¡¨ç¤ºè·³è½¬ç»“æŸ //Â waitÂ untilÂ asyncÂ componentsÂ areÂ resolvedÂ before //Â extractingÂ in-componentÂ enterÂ guards</span></span><br><span class="line">    <span class="keyword">const</span> enterGuards = extractEnterGuards(activated, postEnterCbs, isValid) <span class="comment">//Â ç­‰å¾…å¼‚æ­¥ç»„ä»¶è§£æå®Œï¼Œå†æŠ½å–ç»„ä»¶å†…çš„beforeRouteEnterå®ˆå«</span></span><br><span class="line">    <span class="keyword">const</span> queue = enterGuards.concat(<span class="keyword">this</span>.router.resolveHooks) <span class="comment">//Â beforeResolveÂ hooks</span></span><br><span class="line">    runQueue(</span><br><span class="line">      queue,</span><br><span class="line">      iterator,</span><br><span class="line">      <span class="comment">/*Â æ‰§è¡Œç»“æŸå›è°ƒ*/</span> () =&gt; &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.pending !== route) &#123;</span><br><span class="line">          <span class="keyword">return</span> abort()</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">this</span>.pending = <span class="literal">null</span></span><br><span class="line">        onComplete(route) <span class="comment">//Â æ‰§è¡ŒonCompleteå›è°ƒï¼ŒonCompleteä¸­ä¼šè°ƒç”¨updateRouteæ–¹æ³•ï¼Œå†…éƒ¨ä¼šè§¦å‘afterEaché’©å­</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.router.app) &#123;</span><br><span class="line">          <span class="keyword">this</span>.router.app.$nextTick(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">            <span class="comment">//Â è°ƒç”¨Â beforeRouteEnterÂ å®ˆå«ä¸­ä¼ ç»™Â nextÂ çš„å›è°ƒå‡½æ•°</span></span><br><span class="line">            <span class="comment">//Â next(vm=&gt;xxx)</span></span><br><span class="line">            postEnterCbs.forEach(<span class="function">(<span class="params">cb</span>) =&gt;</span> &#123;</span><br><span class="line">              cb()</span><br><span class="line">            &#125;)</span><br><span class="line">          &#125;)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<ul>
<li>å¯ä»¥çœ‹åˆ°ï¼Œä¼ å…¥äº†é˜Ÿåˆ—<code>queue</code>ã€è¿­ä»£å™¨<code>iterator</code>ä»¥åŠä¸€ä¸ªå…¨éƒ¨æ‰§è¡Œç»“æŸçš„å›è°ƒå‡½æ•°</li>
<li>å…ˆå›é¡¾ä¸‹<code>queue</code>é˜Ÿåˆ—ä¸­æœ‰å“ªäº›å…ƒç´ <ul>
<li><code>beforeRouteLeaveå®ˆå«</code></li>
<li>å…¨å±€çš„<code>beforeEachå®ˆå«</code></li>
<li><code>beforeRouteUpdateå®ˆå«</code></li>
<li><code>beforeEnterå®ˆå«</code></li>
<li>ä»¥åŠä¸€ä¸ªé«˜é˜¶å‡½æ•°ï¼Œæ‰§è¡Œåä¼šè¿”å›è§£æå¼‚æ­¥ç»„ä»¶çš„å‡½æ•°</li>
</ul>
</li>
<li>é˜Ÿåˆ—ä¸­çš„å‡½æ•°ä¼šåœ¨é˜Ÿåˆ—æ‰§è¡Œæ—¶ä¾æ¬¡åœ¨<code>iterator</code>ä¸­è¢«è°ƒç”¨</li>
<li>å‰é¢å‡ ä¸ªéƒ½æ˜¯å·²ç»æå–å‡ºæ¥çš„å®ˆå«å‡½æ•°ï¼Œå¯ä»¥åŒæ­¥æ‰§è¡Œ</li>
<li>ä½†æ˜¯æœ€åä¸€ä¸ªé«˜é˜¶å‡½æ•°æ‰§è¡Œåï¼Œä¼šè¿”å›ä¸€ä¸ªè§£æå¼‚æ­¥ç»„ä»¶çš„å‡½æ•°</li>
<li>å…¶å€ŸåŠ©é—­åŒ…çš„ç‰¹æ€§ï¼Œèƒ½è®¿é—®ä»<code>iterator</code>ä¸­ä¼ å…¥çš„<code>fromã€toã€next</code></li>
<li>ç„¶ååœ¨è§£æå®Œå¼‚æ­¥ç»„ä»¶åè°ƒç”¨<code>next</code>ï¼Œè¿›å…¥é˜Ÿåˆ—ä¸‹ä¸€é¡¹çš„æ‰§è¡Œ</li>
<li>è¿™æ ·å°±èƒ½ä¿è¯ï¼Œå³ä½¿é˜Ÿåˆ—ä¸­æœ‰å¼‚æ­¥å‡½æ•°ï¼Œä¹Ÿèƒ½é¡ºåºåœ°å°†é˜Ÿåˆ—æ‰§è¡Œå®Œ</li>
<li>åœ¨æ•´ä¸ªå®ˆå«é˜Ÿåˆ—æ‰§è¡Œå®Œåï¼Œå°±ä¼šæ‰§è¡Œç»“æŸå›è°ƒ</li>
<li>æ‰§è¡Œç»“æŸå›è°ƒæ—¶ï¼Œæ­¤æ—¶å¼‚æ­¥ç»„ä»¶å·²ç»å…¨éƒ¨è§£æå®Œæ¯•ï¼Œå°±å¯ä»¥æŠ½å–<code>beforeRouteEnter</code>äº†</li>
</ul>
<h4 id="æŠ½å–-beforeRouteEnter"><a href="#æŠ½å–-beforeRouteEnter" class="headerlink" title="æŠ½å– beforeRouteEnter"></a>æŠ½å– beforeRouteEnter</h4><ul>
<li>æŠ½å–<code>beforeRouteEnter</code>å’Œå…¶å®ƒå®ˆå«ç¨å¾®æœ‰ç‚¹ä¸åŒ</li>
<li><ol>
<li>å› ä¸º<code>beforeRouteEnter</code>æ‰€åœ¨çš„ç»„ä»¶å¯èƒ½æ˜¯å¼‚æ­¥çš„ï¼Œæ‰€ä»¥<code>beforeRouteEnter</code>å¿…é¡»ç­‰åˆ°å¼‚æ­¥ç»„ä»¶è§£æå®Œæ¯•æ‰èƒ½å¼€å§‹æŠ½å–</li>
</ol>
</li>
<li><ol start="2">
<li>è¿˜æœ‰ä¸€ä¸ªä¸åŒï¼Œå°±æ˜¯åœ¨è·¯ç”±è¿‡æ¸¡åŠ¨ç”»ä¸º<code>out-in</code>æ—¶ï¼Œå¼‚æ­¥ç»„ä»¶å¯èƒ½å·²ç»è§£æå®Œæ¯•äº†ï¼Œä½†æ˜¯<code>router-view</code>å®ä¾‹å¯èƒ½è¿˜æœªæ³¨å†Œï¼Œæ­¤æ—¶æ˜¯ä¸èƒ½è°ƒç”¨<code>beforeRouteEnter</code>çš„ï¼›å…·ä½“è§<a href="https://github.com/vuejs/vue-router/issues/750" target="_blank" rel="noopener">issue #750</a></li>
</ol>
</li>
<li>å› ä¸º<code>beforeRouteEnter</code>æ”¯æŒä¼ ä¸€ä¸ªå›è°ƒç»™<code>next</code>æ¥è®¿é—®ç»„ä»¶å®ä¾‹ï¼Œå°±åƒä¸‹é¢è¿™æ ·</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">beforeRouteEnter (to, <span class="keyword">from</span>, next) &#123;</span><br><span class="line">  next(<span class="comment">/*postEnterCb*/</span><span class="function"><span class="params">vm</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// é€šè¿‡ `vm` è®¿é—®ç»„ä»¶å®ä¾‹</span></span><br><span class="line">  &#125;)&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>è€Œè¿™ä¸ª<code>vm</code>æ˜¯ä¿å­˜åœ¨<code>router-view</code>å®ä¾‹ä¸Šçš„ï¼Œæ‰€ä»¥éœ€è¦ç­‰åˆ°<code>router-view</code>å®ä¾‹å­˜åœ¨æ—¶ï¼Œæ‰èƒ½è°ƒç”¨å›è°ƒ</li>
<li>æˆ‘ä»¬çœ‹ä¸‹ä»£ç å®ç°</li>
</ul>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//src/history/base.js</span></span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"><span class="keyword">const</span>Â postEnterCbsÂ =Â []Â <span class="comment">//Â ä¿å­˜beforeRouteEnterä¸­ä¼ ç»™nextçš„å›è°ƒå‡½æ•°</span></span><br><span class="line"><span class="keyword">const</span>Â isValidÂ =Â <span class="function"><span class="params">()</span>Â =&gt;</span>Â <span class="keyword">this</span>.currentÂ ===Â routeÂ <span class="comment">//Â è¡¨ç¤ºè·³è½¬ç»“æŸ</span></span><br><span class="line"><span class="comment">//Â waitÂ untilÂ asyncÂ componentsÂ areÂ resolvedÂ before</span></span><br><span class="line"><span class="comment">//Â extractingÂ in-componentÂ enterÂ guards</span></span><br><span class="line"><span class="keyword">const</span>Â enterGuardsÂ =Â extractEnterGuards(activated,Â postEnterCbs,Â isValid)Â <span class="comment">//Â ç­‰å¾…å¼‚æ­¥ç»„ä»¶è§£æå®Œï¼Œå†æŠ½å–ç»„ä»¶å†…çš„beforeRouteEnterå®ˆå«</span></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//Â æå–ç»„ä»¶çš„beforeRouteEnterå®ˆå«</span></span><br><span class="line"><span class="function"><span class="keyword">function</span>Â <span class="title">extractEnterGuards</span>Â (<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">Â Â activated:Â <span class="built_in">Array</span>&lt;RouteRecord&gt;,</span></span></span><br><span class="line"><span class="function"><span class="params">Â Â cbs:Â <span class="built_in">Array</span>&lt;<span class="built_in">Function</span>&gt;,Â <span class="comment">//Â postEnterCbs</span></span></span></span><br><span class="line">Â Â isValid:Â ()Â =&gt;Â boolean</span><br><span class="line">):Â <span class="built_in">Array</span>&lt;?<span class="built_in">Function</span>&gt;Â &#123;</span><br><span class="line">Â Â <span class="keyword">return</span>Â extractGuards(</span><br><span class="line">Â Â Â Â activated,</span><br><span class="line">Â Â Â Â <span class="string">'beforeRouteEnter'</span>,</span><br><span class="line">Â Â Â Â (guard,Â _,Â match,Â key)Â =&gt;Â &#123;Â <span class="comment">/*Â ç»‘å®šbeforeRouteEnterçš„æ‰§è¡Œä¸Šä¸‹æ–‡Â */</span></span><br><span class="line">Â Â Â Â Â Â <span class="keyword">return</span>Â bindEnterGuard(guard,Â match,Â key,Â cbs,Â isValid)</span><br><span class="line">Â Â Â Â &#125;</span><br><span class="line">Â Â )</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//Â ç»‘å®šbeforeRouteEnterçš„æ‰§è¡Œä¸Šä¸‹æ–‡</span></span><br><span class="line"><span class="function"><span class="keyword">function</span>Â <span class="title">bindEnterGuard</span>Â (<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">Â Â guard:Â NavigationGuard,</span></span></span><br><span class="line"><span class="function"><span class="params">Â Â match:Â RouteRecord,</span></span></span><br><span class="line"><span class="function"><span class="params">Â Â key:Â <span class="built_in">string</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">Â Â cbs:Â <span class="built_in">Array</span>&lt;<span class="built_in">Function</span>&gt;,Â <span class="comment">//Â postEnterCbs</span></span></span></span><br><span class="line">Â Â isValid:Â ()Â =&gt;Â boolean</span><br><span class="line">):Â NavigationGuardÂ &#123;</span><br><span class="line">Â Â <span class="comment">//Â å¯¹ç»„ä»¶å†…çš„beforeRouteEnterè¿›è¡Œäº†åŒ…è£…</span></span><br><span class="line">Â Â <span class="keyword">return</span>Â <span class="function"><span class="keyword">function</span>Â <span class="title">routeEnterGuard</span>Â (<span class="params">to,Â <span class="keyword">from</span>,Â next</span>)Â </span>&#123;</span><br><span class="line">Â Â Â Â <span class="comment">//Â è°ƒç”¨ç»„ä»¶å†…beforeRouteEnterå®ˆå«</span></span><br><span class="line">Â Â Â Â <span class="keyword">return</span>Â guard(to,Â <span class="keyword">from</span>,Â <span class="comment">/*Â beforeRouteEnterÂ nextå‡½æ•°ï¼›cbä¸ºnextä¸­å›è°ƒ*/</span><span class="function"><span class="params">cb</span>Â =&gt;</span>Â &#123;</span><br><span class="line">Â Â Â Â Â Â <span class="keyword">if</span>Â (<span class="keyword">typeof</span>Â cbÂ ===Â <span class="string">'function'</span>)Â &#123;</span><br><span class="line">Â Â Â Â Â Â Â Â cbs.push(<span class="function"><span class="params">()</span>Â =&gt;</span>Â &#123;</span><br><span class="line">Â Â Â Â Â Â Â Â Â Â <span class="comment">//Â #750</span></span><br><span class="line">Â Â Â Â Â Â Â Â Â Â <span class="comment">//Â ifÂ aÂ router-viewÂ isÂ wrappedÂ withÂ anÂ out-inÂ transition,</span></span><br><span class="line">Â Â Â Â Â Â Â Â Â Â <span class="comment">//Â theÂ instanceÂ mayÂ notÂ haveÂ beenÂ registeredÂ atÂ thisÂ time.</span></span><br><span class="line">Â Â Â Â Â Â Â Â Â Â <span class="comment">//Â weÂ willÂ needÂ toÂ pollÂ forÂ registrationÂ untilÂ currentÂ route</span></span><br><span class="line">Â Â Â Â Â Â Â Â Â Â <span class="comment">//Â isÂ noÂ longerÂ valid.</span></span><br><span class="line">Â Â Â Â Â Â Â Â Â Â <span class="comment">//Â å¦‚æœrouter-viewè¢«out-inÂ transitionåŒ…è£¹</span></span><br><span class="line">Â Â Â Â Â Â Â Â Â Â <span class="comment">//Â åœ¨ç¡®è®¤è·¯ç”±ï¼Œå‡†å¤‡è°ƒç”¨beforeRouteEnterå®ˆå«æ—¶ï¼Œrouter-viewå®ä¾‹å¯èƒ½è¿˜ä¸å­˜åœ¨</span></span><br><span class="line">Â Â Â Â Â Â Â Â Â Â <span class="comment">//Â ä½†æ˜¯æ­¤æ—¶this.currentå·²ç»ä¸ºto</span></span><br><span class="line">Â Â Â Â Â Â Â Â Â Â <span class="comment">//Â æ‰€ä»¥å¿…é¡»è½®è¯¢è°ƒç”¨cbç›´åˆ°instanceå­˜åœ¨</span></span><br><span class="line">Â Â Â Â Â Â Â Â Â Â poll(cb,Â match.instances,Â key,Â isValid)</span><br><span class="line">Â Â Â Â Â Â Â Â &#125;)</span><br><span class="line">Â Â Â Â Â Â &#125;</span><br><span class="line">Â Â Â Â Â Â <span class="comment">//Â è¿­ä»£å™¨ä¸‹æ­¥</span></span><br><span class="line">Â Â Â Â Â Â next(cb)</span><br><span class="line">Â Â Â Â &#125;)</span><br><span class="line">Â Â &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//Â è½®è¯¢è°ƒç”¨cb</span></span><br><span class="line"><span class="function"><span class="keyword">function</span>Â <span class="title">poll</span>Â (<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">Â Â cb:Â <span class="built_in">any</span>,Â <span class="comment">/*Â cbä¸ºbeforeRouteEnterÂ nextä¸­å›è°ƒ*/</span>Â <span class="comment">//Â somehowÂ flowÂ cannotÂ inferÂ thisÂ isÂ aÂ function</span></span></span></span><br><span class="line"><span class="function"><span class="params">Â Â instances:Â <span class="built_in">Object</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">Â Â key:Â <span class="built_in">string</span>,</span></span></span><br><span class="line">Â Â isValid:Â ()Â =&gt;Â boolean</span><br><span class="line">)Â &#123;</span><br><span class="line">Â Â <span class="keyword">if</span>Â (</span><br><span class="line">Â Â Â Â instances[key]Â &amp;&amp;</span><br><span class="line">Â Â Â Â !instances[key]._isBeingDestroyedÂ <span class="comment">//Â doÂ notÂ reuseÂ beingÂ destroyedÂ instance</span></span><br><span class="line">Â Â )Â &#123;</span><br><span class="line">Â Â Â Â cb(instances[key])</span><br><span class="line">Â Â &#125;Â <span class="keyword">else</span>Â <span class="keyword">if</span>Â (isValid())Â &#123;</span><br><span class="line">Â Â Â Â setTimeout(<span class="function"><span class="params">()</span>Â =&gt;</span>Â &#123;</span><br><span class="line">Â Â Â Â Â Â poll(cb,Â instances,Â key,Â isValid)</span><br><span class="line">Â Â Â Â &#125;,Â <span class="number">16</span>)</span><br><span class="line">Â Â &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>å¯ä»¥çœ‹åˆ°åœ¨è°ƒç”¨<code>extractEnterGuards</code>å‰</li>
<li>åœ¨å¤–å±‚å£°æ˜äº†ä¸€ä¸ª<code>postEnterCbs</code>æ•°ç»„<ul>
<li>ç”¨æ¥ä¿å­˜<code>beforeRouteEnterä¸­ä¼ ç»™nextçš„å›è°ƒå‡½æ•°</code>ï¼Œæˆ‘ä»¬ç§°ä¸º<code>postEnterCb</code>ï¼Œä¹Ÿå°±æ˜¯è¿›å…¥åçš„å›è°ƒ</li>
</ul>
</li>
<li>ä»¥åŠä¸€ä¸ªåˆ¤æ–­è·³è½¬æ˜¯å¦ç»“æŸçš„<code>isValid</code>å‡½æ•°</li>
<li><code>isValid</code>å‡½æ•°ä¼šè¢«ä¼ å…¥<code>extractEnterGuards</code>ä¸­</li>
<li><code>extractEnterGuards</code>ä¸­é€šè¿‡é«˜é˜¶å‡½æ•°å½¢å¼è¿”å›ä¸€ä¸ªåŒ…è£…äº†<code>beforeRouteEnter</code>çš„å…·åå‡½æ•°<code>routeEnterGuard</code>ï¼Œå…¶ä¼šåœ¨æ‰§è¡Œé˜Ÿåˆ—æ—¶è¢«è°ƒç”¨ï¼Œå¹¶æ‰§è¡ŒçœŸæ­£çš„<code>beforeRouteEnter</code>å®ˆå«<code>guard</code></li>
<li><code>guard</code>åœ¨è¢«æ‰§è¡Œæ—¶ï¼Œä¼šæ¥æ”¶<code>fromã€to</code>ä»¥åŠä¸€ä¸ªè¢«â€™æ”¹é€ â€™è¿‡çš„<code>next</code>ï¼Œå…¶æ¥æ”¶ä¸€ä¸ª<code>postEnterCb</code></li>
<li>è¿™ä¸ª<code>postEnterCb</code>å¯èƒ½åœ¨å°†æ¥éœ€è¦è®¿é—®<code>vm</code></li>
<li>æ‰€ä»¥å°†<code>postEnterCb</code>ç”¨<code>poll</code>æ–¹æ³•åŒ…è£¹å¡å…¥åœ¨å¤–é¢å®šä¹‰å¥½çš„<code>postEnterCbs</code>æ•°ç»„ä¸­</li>
<li><code>poll</code>æ–¹æ³•ä¸»è¦æ˜¯ç”¨æ¥è§£å†³å‰é¢æåˆ°çš„<code>issue #750</code>çš„ï¼Œå®ƒä¼šä¸€ç›´è½®è¯¢ï¼Œç›´åˆ°<code>router-view</code>å®ä¾‹å­˜åœ¨æ—¶ï¼Œå†è°ƒç”¨<code>postEnterCb</code>å¹¶ä¼ å…¥æŒ‚è½½åˆ°<code>router-view</code>ä¸Šçš„ç»„ä»¶å®ä¾‹</li>
<li>è¿™æ ·å°±å®ç°äº†<code>next</code>ä¸­èƒ½è®¿é—®åˆ°ç»„ä»¶å®ä¾‹çš„é€»è¾‘</li>
<li>æŠ½å–å®Œ<code>beforeRouteEnter</code>å®ˆå«å’Œå…¶ä¸­çš„<code>postEnterCbs</code>åï¼Œåˆåœ¨<code>queue</code>åæ‹¼æ¥äº†<code>beforeResolve</code>å®ˆå«</li>
</ul>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> enterGuards = extractEnterGuards(activated, postEnterCbs, isValid) <span class="comment">//Â ç­‰å¾…å¼‚æ­¥ç»„ä»¶è§£æå®Œï¼Œå†æŠ½å–ç»„ä»¶å†…çš„beforeRouteEnterå®ˆå«</span></span><br><span class="line"><span class="keyword">const</span> queue = enterGuards.concat(<span class="keyword">this</span>.router.resolveHooks) <span class="comment">//Â beforeResolveÂ hooks</span></span><br></pre></td></tr></table></figure>
<ul>
<li>æ­¤æ—¶<code>queue</code>ä¸­æ˜¯<code>routeEnterGuard</code>å‡½æ•°åŠ<code>resolveHook</code></li>
<li>ç„¶åæ‰§è¡Œæ­¤é˜Ÿåˆ—ï¼Œé˜Ÿåˆ—ä¸­çš„<code>routerEnterGuard</code>å’Œ<code>resolveHook</code>ä¼šæ‰§è¡Œ</li>
</ul>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">runQueue(</span><br><span class="line">  queue,</span><br><span class="line">  iterator,</span><br><span class="line">  <span class="comment">/*Â æ‰§è¡Œç»“æŸå›è°ƒ*/</span> () =&gt; &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.pending !== route) &#123;</span><br><span class="line">      <span class="keyword">return</span> abort()</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">this</span>.pending = <span class="literal">null</span></span><br><span class="line">    onComplete(route) <span class="comment">//Â æ‰§è¡ŒonCompleteå›è°ƒï¼ŒonCompleteä¸­ä¼šè°ƒç”¨updateRouteæ–¹æ³•ï¼Œå†…éƒ¨ä¼šè§¦å‘afterEaché’©å­</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.router.app) &#123;</span><br><span class="line">      <span class="keyword">this</span>.router.app.$nextTick(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="comment">//Â è°ƒç”¨Â beforeRouteEnterÂ å®ˆå«ä¸­ä¼ ç»™Â nextÂ çš„å›è°ƒå‡½æ•°</span></span><br><span class="line">        <span class="comment">//Â next(vm=&gt;xxx)</span></span><br><span class="line">        postEnterCbs.forEach(<span class="function">(<span class="params">cb</span>) =&gt;</span> &#123;</span><br><span class="line">          cb()</span><br><span class="line">        &#125;)</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<ul>
<li>æ‰§è¡Œçš„é€»è¾‘å’Œä¹‹å‰ç±»ä¼¼ï¼Œ<code>beforeRouteEnter</code>å’Œ<code>beforeResolve</code>ä¼šè¢«ä¾æ¬¡è°ƒç”¨ï¼Œç„¶åæ‰§è¡Œé˜Ÿåˆ—ç»“æŸå›è°ƒ</li>
<li>é˜Ÿåˆ—ç»“æŸå›è°ƒä¸­ä¼šè°ƒç”¨<code>onComplete</code>å¹¶ä¼ å…¥<code>ç›®æ ‡Route</code>å¹¶åœ¨<code>$nextTick</code>ä¸­éå†ä¹‹å‰ä¿å­˜çš„<code>postEnterCbs</code>ï¼Œå³ä¼ å…¥<code>next</code>çš„å›è°ƒ</li>
<li>æ­¤å¤„çš„<code>onComplete</code>æ˜¯ç¡®è®¤è·¯ç”±æ—¶(<code>confirmTransition</code>)ä¼ å…¥çš„</li>
</ul>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/history/base.js transitionToæ–¹æ³•ä¸­</span></span><br><span class="line"></span><br><span class="line">   <span class="keyword">this</span>.confirmTransition(</span><br><span class="line">      route,</span><br><span class="line">      () =&gt; &#123; <span class="comment">// onCompleteï¼Œå®Œæˆ</span></span><br><span class="line">        <span class="keyword">this</span>.updateRoute(route) <span class="comment">// æ›´æ–°routeï¼Œä¼šè§¦å‘afterEaché’©å­</span></span><br><span class="line">        onComplete &amp;&amp; onComplete(route) <span class="comment">// è°ƒç”¨onCompleteå›è°ƒ</span></span><br><span class="line">        <span class="keyword">this</span>.ensureURL()</span><br><span class="line"></span><br><span class="line">        <span class="comment">// fire ready cbs once</span></span><br><span class="line">        <span class="comment">// è§¦å‘readyå›è°ƒ</span></span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">this</span>.ready) &#123;</span><br><span class="line">          <span class="keyword">this</span>.ready = <span class="literal">true</span></span><br><span class="line">          <span class="keyword">this</span>.readyCbs.forEach(<span class="function"><span class="params">cb</span> =&gt;</span> &#123;</span><br><span class="line">            cb(route)</span><br><span class="line">          &#125;)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="comment">// onAbortå›è°ƒ</span></span><br><span class="line">      err=&gt;&#123;...&#125;</span><br><span class="line">    )</span><br></pre></td></tr></table></figure>
<ul>
<li>å¯ä»¥çœ‹åˆ°å…¶è°ƒç”¨<code>updateRoute</code>æ¥æ›´æ–°<code>route</code>ï¼Œè¿™ä¼šè§¦å‘<code>afterEach</code>é’©å­</li>
<li>è°ƒç”¨<code>ensureURL</code>æ›´æ–° url</li>
<li>å¹¶è°ƒç”¨ä¼ å…¥<code>transitionTo</code>çš„<code>onComplete</code>å‡½æ•°ï¼Œä¸»è¦ç”¨æ¥åœ¨<code>vue-router</code>åˆå§‹åŒ–æ—¶ä¸º<code>hash</code>æ¨¡å¼åšåˆå§‹åŒ–ç»‘å®š(<code>setupHashListener</code>)</li>
<li>æœ€åè§¦å‘é€šè¿‡<code>onReady</code>æ³¨å†Œçš„<code>readyCbs</code>å›è°ƒ</li>
</ul>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/history/base.js</span></span><br><span class="line"></span><br><span class="line">Â Â <span class="comment">//Â æ›´æ–°è·¯ç”±ï¼Œè§¦å‘afterEaché’©å­</span></span><br><span class="line">Â Â updateRouteÂ (route:Â Route)Â &#123;</span><br><span class="line">Â Â Â Â <span class="keyword">const</span>Â prevÂ =Â <span class="keyword">this</span>.current</span><br><span class="line">Â Â Â Â <span class="keyword">this</span>.currentÂ =Â route<span class="comment">//Â æ›´æ–°current</span></span><br><span class="line">Â Â Â Â <span class="keyword">this</span>.cbÂ &amp;&amp;Â <span class="keyword">this</span>.cb(route)Â <span class="comment">//Â è°ƒç”¨updateRouteå›è°ƒï¼Œå›è°ƒä¸­ä¼šé‡æ–°ä¸º_routerRoot._routeèµ‹å€¼ï¼Œè¿›è€Œè§¦å‘router-viewçš„é‡æ–°æ¸²æŸ“</span></span><br><span class="line">Â Â Â Â <span class="keyword">this</span>.router.afterHooks.forEach(<span class="function"><span class="params">hook</span>Â =&gt;</span>Â &#123;Â <span class="comment">//Â è§¦å‘afterEachç‹—å­</span></span><br><span class="line">Â Â Â Â Â Â hookÂ &amp;&amp;Â hook(<span class="comment">/*Â to*/</span>route,Â <span class="comment">/*Â from*/</span>prev)</span><br><span class="line">Â Â Â Â &#125;)</span><br><span class="line">Â Â &#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><code>updateRoute</code>ä¼šè°ƒç”¨<code>History</code>ä¸Šé€šè¿‡<code>listen</code>æ–¹æ³•æ³¨å†Œçš„æ›´æ–°å›è°ƒï¼Œè§¦å‘<code>roter-view</code>çš„é‡æ–°æ¸²æŸ“</li>
<li>è¿™äº›æ›´æ–°å›è°ƒæ˜¯åœ¨<code>vue-router</code>åˆå§‹åŒ–æ—¶æ³¨å†Œçš„</li>
</ul>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/index.js init</span></span><br><span class="line">history.listen(<span class="function">(<span class="params">route</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">this</span>.apps.forEach(<span class="function">(<span class="params">app</span>) =&gt;</span> &#123;</span><br><span class="line">    app._route = route <span class="comment">// æ›´æ–°route</span></span><br><span class="line">  &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<ul>
<li>ç„¶åæ‰§è¡Œæ‰€æœ‰<code>afterEach</code>é’©å­</li>
<li>è‡³æ­¤ä¸€æ¬¡å®Œæ•´çš„è·¯ç”±è·³è½¬å®Œæˆï¼Œç›¸åº”çš„å®ˆå«åŠé’©å­ä¹Ÿè§¦å‘å®Œæˆ</li>
</ul>
<h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><ul>
<li>æ•´ä¸ªå¯¼èˆªçš„è§£æ(ç¡®è®¤)ï¼Œå…¶å®å°±æ˜¯ä»ä¸åŒçŠ¶æ€çš„è·¯ç”±è®°å½•ä¸­æŠ½å–å‡ºå¯¹åº”çš„å®ˆå«åŠé’©å­</li>
<li>ç„¶åç»„æˆé˜Ÿåˆ—ï¼Œä½¿ç”¨<code>runQueue</code>ã€<code>iterator</code>å·§å¦™çš„å®Œæˆå®ˆå«çš„æ‰§è¡Œ</li>
<li>å¹¶åœ¨å…¶ä¸­å¤„ç†äº†å¼‚æ­¥ç»„ä»¶çš„è§£æã€<code>postEnterCb</code>ä¸­å®ä¾‹è·å–çš„é—®é¢˜</li>
<li>æ•´ä¸ªå®ˆå«ã€é’©å­çš„æ‰§è¡Œæµç¨‹å¦‚ä¸‹<ul>
<li>å¯¼èˆªè¢«è§¦å‘ã€‚</li>
<li>åœ¨å¤±æ´»çš„ç»„ä»¶é‡Œè°ƒç”¨  beforeRouteLeave  å®ˆå«ã€‚</li>
<li>è°ƒç”¨å…¨å±€çš„  beforeEach  å®ˆå«ã€‚</li>
<li>åœ¨é‡ç”¨çš„ç»„ä»¶é‡Œè°ƒç”¨  beforeRouteUpdate  å®ˆå« (2.2+)ã€‚</li>
<li>åœ¨è·¯ç”±é…ç½®é‡Œè°ƒç”¨  beforeEnterã€‚</li>
<li>è§£æå¼‚æ­¥è·¯ç”±ç»„ä»¶ã€‚</li>
<li>åœ¨è¢«æ¿€æ´»çš„ç»„ä»¶é‡Œè°ƒç”¨  beforeRouteEnterã€‚</li>
<li>è°ƒç”¨å…¨å±€çš„  beforeResolve  å®ˆå« (2.5+)ã€‚</li>
<li>å¯¼èˆªè¢«ç¡®è®¤ã€‚</li>
<li>è°ƒç”¨å…¨å±€çš„  afterEach  é’©å­ã€‚</li>
<li>è§¦å‘ DOM æ›´æ–°ã€‚</li>
<li>ç”¨åˆ›å»ºå¥½çš„å®ä¾‹è°ƒç”¨  beforeRouteEnter  å®ˆå«ä¸­ä¼ ç»™  next  çš„å›è°ƒå‡½æ•°ã€‚</li>
</ul>
</li>
</ul>
<h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><ul>
<li><a href="https://github.com/dwqs/blog/issues/53" target="_blank" rel="noopener">https://github.com/dwqs/blog/issues/53</a></li>
<li><a href="https://github.com/dwqs/blog/issues/54" target="_blank" rel="noopener">https://github.com/dwqs/blog/issues/54</a></li>
<li><a href="https://github.com/dwqs/blog/issues/55" target="_blank" rel="noopener">https://github.com/dwqs/blog/issues/55</a></li>
<li><a href="https://github.com/vuejs/vue-router/issues/2184#issuecomment-393484643" target="_blank" rel="noopener">https://github.com/vuejs/vue-router/issues/2184#issuecomment-393484643</a></li>
<li><a href="https://juejin.im/post/5e456513f265da573c0c6d4b" target="_blank" rel="noopener">https://juejin.im/post/5e456513f265da573c0c6d4b</a></li>
<li><a href="https://juejin.im/post/584040e1ac502e006cbedb23" target="_blank" rel="noopener">https://juejin.im/post/584040e1ac502e006cbedb23</a></li>
<li><a href="https://juejin.im/post/5df0ada0f265da33d56d1a2f" target="_blank" rel="noopener">https://juejin.im/post/5df0ada0f265da33d56d1a2f</a></li>
<li><a href="https://juejin.im/post/5dbed0bef265da4cff701f68" target="_blank" rel="noopener">https://juejin.im/post/5dbed0bef265da4cff701f68</a></li>
<li><a href="https://www.jianshu.com/p/29e8214d0bee" target="_blank" rel="noopener">https://www.jianshu.com/p/29e8214d0bee</a></li>
<li><a href="https://ustbhuangyi.github.io/vue-analysis/v2/vue-router/" target="_blank" rel="noopener">https://ustbhuangyi.github.io/vue-analysis/v2/vue-router/</a></li>
<li><a href="https://blog.liuyunzhuge.com/2020/04/08/vue-routeræºç ï¼šcreate-matcher/" target="_blank" rel="noopener">https://blog.liuyunzhuge.com/2020/04/08/vue-router æºç ï¼šcreate-matcher/</a></li>
</ul>
<h2 id="PS"><a href="#PS" class="headerlink" title="PS"></a>PS</h2><ul>
<li>åé¢è¿˜ä¼šä»‹ç»å…¶ä½™éƒ¨åˆ†ï¼Œå¦‚æœè§‰å¾—è¿˜è¡Œï¼Œå¯ä»¥ç»™ä¸ªèµå“¦ âœ¨</li>
<li>ä¸ªäºº<code>github</code>ï¼Œä¹Ÿæ€»ç»“äº†ä¸€äº›ä¸œè¥¿ï¼Œæ¬¢è¿ star</li>
<li>åŸºäº canvas çš„ç»˜å›¾æ¿<a href="https://github.com/BryanAdamss/drawing-board" target="_blank" rel="noopener">drawing-board</a></li>
<li>å‰ç«¯å…¥é—¨ demoã€æœ€ä½³å®è·µé›†åˆ <a href="https://github.com/BryanAdamss/fe-awesome-demos" target="_blank" rel="noopener">fe-awesome-demos</a></li>
<li>ä¸€ä¸ªè‡ªåŠ¨ç”Ÿæˆåˆ«åçš„<code>vue-cli-plugin</code><a href="https://www.npmjs.com/package/vue-cli-plugin-auto-alias" target="_blank" rel="noopener">https://www.npmjs.com/package/vue-cli-plugin-auto-alias</a></li>
</ul>
<h2 id="npm-åŒ…"><a href="#npm-åŒ…" class="headerlink" title="npm åŒ…"></a>npm åŒ…</h2><ul>
<li><a href="https://www.npmjs.com/package/vue-cli-plugin-auto-alias" target="_blank" rel="noopener">vue-cli-plugin-auto-alias</a></li>
<li><a href="https://www.npmjs.com/package/@bryanadamss/drawing-board" target="_blank" rel="noopener">@bryanadamss/drawing-board</a></li>
<li><a href="https://www.npmjs.com/package/@bryanadamss/num2chn" target="_blank" rel="noopener">@bryanadamss/num2chn</a></li>
<li><a href="https://www.npmjs.com/package/ant-color-converter" target="_blank" rel="noopener">ant-color-converter</a></li>
</ul>
<h2 id="äº¤æµ"><a href="#äº¤æµ" class="headerlink" title="äº¤æµ"></a>äº¤æµ</h2><ul>
<li>å¦‚æœæœ‰é—®é¢˜ï¼Œå¯ä»¥åŠ å¾®ä¿¡äº¤æµï¼Œå…±åŒæˆé•¿ï¼Œå…±åŒè¿›æ­¥~</li>
<li><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/917b376a388f43faa6c8f8d81f730bcb~tplv-k3u1fbpfcp-watermark.image" alt=""></li>
</ul>

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>


    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/vue/" rel="tag"># vue</a>
          
            <a href="/tags/vue-router/" rel="tag"># vue-router</a>
          
            <a href="/tags/æºç è§£æ/" rel="tag"># æºç è§£æ</a>
          
        </div>
      

      
        
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2020/06/22/vue-cli-mode/" rel="next" title="vue-cli-mode">
                <i class="fa fa-chevron-left"></i> vue-cli-mode
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2020/12/01/x5-video-summary/" rel="prev" title="x5-video-summary">
                x5-video-summary <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>

          
          </div>
          


          
  <div class="comments" id="comments">
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            æ–‡ç« ç›®å½•
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            ç«™ç‚¹æ¦‚è§ˆ
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/Avatar.png"
               alt="BryanAdamss" />
          <p class="site-author-name" itemprop="name">BryanAdamss</p>
           
              <p class="site-description motion-element" itemprop="description"></p>
          
        </div>
        <nav class="site-state motion-element">
        
          
            <div class="site-state-item site-state-posts">
              <a href="/archives">
                <span class="site-state-item-count">64</span>
                <span class="site-state-item-name">æ—¥å¿—</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-categories">
              <a href="/categories">
                <span class="site-state-item-count">2</span>
                <span class="site-state-item-name">åˆ†ç±»</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">91</span>
                <span class="site-state-item-name">æ ‡ç­¾</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/BryanAdamss" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                  GitHub
                </a>
              </span>
            
          
        </div>

        
        

        
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#vue-router-æºç è§£æ-1-5w-å­—-å¤šå›¾é¢„è­¦-ã€ä¸­ã€‘"><span class="nav-number">1.</span> <span class="nav-text">vue-router æºç è§£æ | 1.5w å­— | å¤šå›¾é¢„è­¦ - ã€ä¸­ã€‘</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#è·¯ç”±è·³è½¬"><span class="nav-number">1.1.</span> <span class="nav-text">è·¯ç”±è·³è½¬</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#transitionTo"><span class="nav-number">1.1.1.</span> <span class="nav-text">transitionTo</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#è·¯ç”±åŒ¹é…"><span class="nav-number">1.2.</span> <span class="nav-text">è·¯ç”±åŒ¹é…</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#åœ°å€æ ¼å¼åŒ–-normalizeLocation"><span class="nav-number">1.2.1.</span> <span class="nav-text">åœ°å€æ ¼å¼åŒ– normalizeLocation</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#åœ°å€æ˜¯å¦åŒ¹é…åˆ¤æ–­-matchRoute"><span class="nav-number">1.2.2.</span> <span class="nav-text">åœ°å€æ˜¯å¦åŒ¹é…åˆ¤æ–­ matchRoute</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#å¡«å……å‚æ•°-fillParams"><span class="nav-number">1.2.3.</span> <span class="nav-text">å¡«å……å‚æ•° fillParams</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#åˆ›å»ºè·¯ç”±å¯¹è±¡-createRoute"><span class="nav-number">1.2.4.</span> <span class="nav-text">åˆ›å»ºè·¯ç”±å¯¹è±¡_createRoute</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#createRoute"><span class="nav-number">1.2.4.1.</span> <span class="nav-text">createRoute</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#åˆ›å»ºåˆ«åè·¯ç”±å¯¹è±¡-alias"><span class="nav-number">1.2.4.2.</span> <span class="nav-text">åˆ›å»ºåˆ«åè·¯ç”±å¯¹è±¡ alias</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#åˆ›å»ºé‡å®šå‘è·¯ç”±å¯¹è±¡-redirect"><span class="nav-number">1.2.4.3.</span> <span class="nav-text">åˆ›å»ºé‡å®šå‘è·¯ç”±å¯¹è±¡ redirect</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#å°ç»“"><span class="nav-number">1.2.5.</span> <span class="nav-text">å°ç»“</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#å¯¼èˆªè§£æ-ç¡®è®¤-æµç¨‹"><span class="nav-number">1.3.</span> <span class="nav-text">å¯¼èˆªè§£æ(ç¡®è®¤)æµç¨‹</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#åˆ¤æ–­é‡å¤è·³è½¬"><span class="nav-number">1.3.1.</span> <span class="nav-text">åˆ¤æ–­é‡å¤è·³è½¬</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#å¯¹æ¯”æ‰¾å‡ºéœ€è¦æ›´æ–°ã€å¤±æ´»ã€æ¿€æ´»çš„è·¯ç”±è®°å½•"><span class="nav-number">1.3.2.</span> <span class="nav-text">å¯¹æ¯”æ‰¾å‡ºéœ€è¦æ›´æ–°ã€å¤±æ´»ã€æ¿€æ´»çš„è·¯ç”±è®°å½•</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#æŠ½å–é’©å­ã€å®ˆå«å‡½æ•°ã€è§£æå¼‚æ­¥ç»„ä»¶"><span class="nav-number">1.3.3.</span> <span class="nav-text">æŠ½å–é’©å­ã€å®ˆå«å‡½æ•°ã€è§£æå¼‚æ­¥ç»„ä»¶</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#extractLeaveGuardsã€extractUpdateHooks"><span class="nav-number">1.3.3.1.</span> <span class="nav-text">extractLeaveGuardsã€extractUpdateHooks</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#resolveAsyncComponents"><span class="nav-number">1.3.3.2.</span> <span class="nav-text">resolveAsyncComponents</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#å®ˆå«é˜Ÿåˆ—çš„æ‰§è¡Œ"><span class="nav-number">1.3.4.</span> <span class="nav-text">å®ˆå«é˜Ÿåˆ—çš„æ‰§è¡Œ</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#runQueue"><span class="nav-number">1.3.4.1.</span> <span class="nav-text">runQueue</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#iterator"><span class="nav-number">1.3.4.2.</span> <span class="nav-text">iterator</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#é˜Ÿåˆ—æ‰§è¡Œ"><span class="nav-number">1.3.4.3.</span> <span class="nav-text">é˜Ÿåˆ—æ‰§è¡Œ</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#æŠ½å–-beforeRouteEnter"><span class="nav-number">1.3.4.4.</span> <span class="nav-text">æŠ½å– beforeRouteEnter</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#æ€»ç»“"><span class="nav-number">1.3.5.</span> <span class="nav-text">æ€»ç»“</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#å‚è€ƒ"><span class="nav-number">1.4.</span> <span class="nav-text">å‚è€ƒ</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#PS"><span class="nav-number">1.5.</span> <span class="nav-text">PS</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#npm-åŒ…"><span class="nav-number">1.6.</span> <span class="nav-text">npm åŒ…</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#äº¤æµ"><span class="nav-number">1.7.</span> <span class="nav-text">äº¤æµ</span></a></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy;  2017 - 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">BryanAdamss</span>
</div>


<div class="powered-by">
  ç”± <a class="theme-link" href="https://hexo.io">Hexo</a> å¼ºåŠ›é©±åŠ¨
</div>

<div class="theme-info">
  ä¸»é¢˜ -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Mist
  </a>
</div>


        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    
    
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  




  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.0"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.0"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.0"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.0"></script>



  



  




	





  





  





  



  
  
  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length == 0) {
      search_path = "search.xml";
    }
    var path = "/" + search_path;
    // monitor main search box;

    function proceedsearch() {
      $("body").append('<div class="local-search-pop-overlay">').css('overflow', 'hidden');
      $('.popup').toggle();
    }
    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';
      $.ajax({
        url: path,
        dataType: "xml",
        async: true,
        success: function( xmlResponse ) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = $( "entry", xmlResponse ).map(function() {
            return {
              title: $( "title", this ).text(),
              content: $("content",this).text(),
              url: $( "url" , this).text()
            };
          }).get();
          var $input = document.getElementById(search_id);
          var $resultContent = document.getElementById(content_id);
          $input.addEventListener('input', function(){
            var matchcounts = 0;
            var str='<ul class=\"search-result-list\">';
            var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
            $resultContent.innerHTML = "";
            if (this.value.trim().length > 1) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var content_index = [];
                var data_title = data.title.trim().toLowerCase();
                var data_content = data.content.trim().replace(/<[^>]+>/g,"").toLowerCase();
                var data_url = decodeURIComponent(data.url);
                var index_title = -1;
                var index_content = -1;
                var first_occur = -1;
                // only match artiles with not empty titles and contents
                if(data_title != '') {
                  keywords.forEach(function(keyword, i) {
                    index_title = data_title.indexOf(keyword);
                    index_content = data_content.indexOf(keyword);
                    if( index_title >= 0 || index_content >= 0 ){
                      isMatch = true;
                      if (i == 0) {
                        first_occur = index_content;
                      }
                    }

                  });
                }
                // show search results
                if (isMatch) {
                  matchcounts += 1;
                  str += "<li><a href='"+ data_url +"' class='search-result-title'>"+ data_title +"</a>";
                  var content = data.content.trim().replace(/<[^>]+>/g,"");
                  if (first_occur >= 0) {
                    // cut out 100 characters
                    var start = first_occur - 20;
                    var end = first_occur + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if(start == 0){
                      end = 50;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    var match_content = content.substring(start, end);
                    // highlight all keywords
                    keywords.forEach(function(keyword){
                      var regS = new RegExp(keyword, "gi");
                      match_content = match_content.replace(regS, "<b class=\"search-keyword\">"+keyword+"</b>");
                    });

                    str += "<p class=\"search-result\">" + match_content +"...</p>"
                  }
                  str += "</li>";
                }
              })};
            str += "</ul>";
            if (matchcounts == 0) { str = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>' }
            if (keywords == "") { str = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>' }
            $resultContent.innerHTML = str;
          });
          proceedsearch();
        }
      });}

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched == false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(function(e){
      $('.popup').hide();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    });
    $('.popup').click(function(e){
      e.stopPropagation();
    });
  </script>


  

  

  

  


  

</body>
</html>
